{% extends "admin_base.html" %}

{% block title %}Áî®Êà∑ÁÆ°ÁêÜ - CyberWaifu Bot ÁÆ°ÁêÜÁ≥ªÁªü{% endblock %}

{% block page_title %}Áî®Êà∑ÁÆ°ÁêÜ{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">
    Áî®Êà∑ÁÆ°ÁêÜ
</li>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="header-container">
            <div class="header-title">
                <h3><i class="icon">üë•</i> Áî®Êà∑ÁÆ°ÁêÜ</h3>
            </div>
            <div class="search-container">
                <form method="GET" class="search-form">
                    <div class="search-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>
                    <input type="text" name="search" class="search-input" 
                           placeholder="ÊêúÁ¥¢Áî®Êà∑ID„ÄÅÁî®Êà∑Âêç..." value="{{ search_term }}"
                           aria-label="ÊêúÁ¥¢Áî®Êà∑">
                    <div class="search-loading"></div>
                    {% if search_term %}
                    <a href="{{ url_for('users') }}" class="clear-button" aria-label="Ê∏ÖÈô§ÊêúÁ¥¢">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </a>
                    {% endif %}
                    <button type="submit" class="search-button" aria-label="ÊêúÁ¥¢">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </button>
                </form>
                {% if search_term %}
                <div class="search-status">ÊâæÂà∞‰∏é "{{ search_term }}" Áõ∏ÂÖ≥ÁöÑÁªìÊûú</div>
                {% endif %}
            </div>
        </div>
        
        <div class="filter-container mt-md">
            <div class="filter-label">Á≠õÈÄâÔºö</div>
            
            <button class="filter-button" aria-label="ÊâìÂºÄÁ≠õÈÄâÈÄâÈ°π">
                <span class="filter-button-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                </span>
                <span>Á≠õÈÄâÊù°‰ª∂</span>
            </button>
            
            <div class="filter-dropdown">
                <div class="filter-group">
                    <div class="filter-group-title">Ê≥®ÂÜåÊó∂Èó¥</div>
                    <div class="filter-options">
                        <div class="filter-option" data-key="date" data-value="today">‰ªäÂ§©</div>
                        <div class="filter-option" data-key="date" data-value="week">Êú¨Âë®</div>
                        <div class="filter-option" data-key="date" data-value="month">Êú¨Êúà</div>
                        <div class="filter-option" data-key="date" data-value="year">‰ªäÂπ¥</div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <div class="filter-group-title">ÂØπËØùÊï∞Èáè</div>
                    <div class="filter-options">
                        <div class="filter-option" data-key="conversations" data-value="0">Êó†ÂØπËØù</div>
                        <div class="filter-option" data-key="conversations" data-value="1-10">1-10</div>
                        <div class="filter-option" data-key="conversations" data-value="10+">10+</div>
                        <div class="filter-option" data-key="conversations" data-value="50+">50+</div>
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-text" id="clear-filters">Ê∏ÖÈô§Á≠õÈÄâ</button>
                    <button class="btn btn-primary" id="apply-filters">Â∫îÁî®Á≠õÈÄâ</button>
                </div>
            </div>
            
            <div class="filter-tags">
                <!-- Á≠õÈÄâÊ†áÁ≠æÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÊ∑ªÂä† -->
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if users %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="number">
                            <a href="{{ url_for('users', search=search_term, sort_by='uid', sort_order=next_sort_order('uid')) }}" 
                               class="sort-link" aria-label="ÊåâÁî®Êà∑IDÊéíÂ∫è">
                                <span>Áî®Êà∑ID</span>
                                <span class="sort-indicator">
                                    {% if sort_by == 'uid' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                            {% if sort_order == 'asc' %}
                                            <polyline points="18 15 12 9 6 15"></polyline>
                                            {% else %}
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                            {% endif %}
                                        </svg>
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <polyline points="19 12 12 19 5 12"></polyline>
                                        </svg>
                                    {% endif %}
                                </span>
                            </a>
                        </th>
                        <th class="sortable" data-sort="text">
                            <a href="{{ url_for('users', search=search_term, sort_by='user_name', sort_order=next_sort_order('user_name')) }}" 
                               class="sort-link" aria-label="ÊåâÁî®Êà∑ÂêçÊéíÂ∫è">
                                <span>Áî®Êà∑Âêç</span>
                                <span class="sort-indicator">
                                    {% if sort_by == 'user_name' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                            {% if sort_order == 'asc' %}
                                            <polyline points="18 15 12 9 6 15"></polyline>
                                            {% else %}
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                            {% endif %}
                                        </svg>
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <polyline points="19 12 12 19 5 12"></polyline>
                                        </svg>
                                    {% endif %}
                                </span>
                            </a>
                        </th>
                        <th>ÂßìÂêç</th>
                        <th class="sortable" data-sort="number">
                            <a href="{{ url_for('users', search=search_term, sort_by='conversations', sort_order=next_sort_order('conversations')) }}" 
                               class="sort-link" aria-label="ÊåâÂØπËØùÊï∞ÊéíÂ∫è">
                                <span>ÂØπËØùÊï∞</span>
                                <span class="sort-indicator">
                                    {% if sort_by == 'conversations' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                            {% if sort_order == 'asc' %}
                                            <polyline points="18 15 12 9 6 15"></polyline>
                                            {% else %}
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                            {% endif %}
                                        </svg>
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <polyline points="19 12 12 19 5 12"></polyline>
                                        </svg>
                                    {% endif %}
                                </span>
                            </a>
                        </th>
                        <th class="sortable" data-sort="number">
                            <a href="{{ url_for('users', search=search_term, sort_by='dialog_turns', sort_order=next_sort_order('dialog_turns')) }}" 
                               class="sort-link" aria-label="ÊåâÊ∂àÊÅØÊï∞ÊéíÂ∫è">
                                <span>Ê∂àÊÅØÊï∞</span>
                                <span class="sort-indicator">
                                    {% if sort_by == 'dialog_turns' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                            {% if sort_order == 'asc' %}
                                            <polyline points="18 15 12 9 6 15"></polyline>
                                            {% else %}
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                            {% endif %}
                                        </svg>
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <polyline points="19 12 12 19 5 12"></polyline>
                                        </svg>
                                    {% endif %}
                                </span>
                            </a>
                        </th>
                        <th class="sortable" data-sort="date">
                            <a href="{{ url_for('users', search=search_term, sort_by='create_at', sort_order=next_sort_order('create_at')) }}" 
                               class="sort-link" aria-label="ÊåâÊ≥®ÂÜåÊó∂Èó¥ÊéíÂ∫è">
                                <span>Ê≥®ÂÜåÊó∂Èó¥</span>
                                <span class="sort-indicator">
                                    {% if sort_by == 'create_at' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                            {% if sort_order == 'asc' %}
                                            <polyline points="18 15 12 9 6 15"></polyline>
                                            {% else %}
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                            {% endif %}
                                        </svg>
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <polyline points="19 12 12 19 5 12"></polyline>
                                        </svg>
                                    {% endif %}
                                </span>
                            </a>
                        </th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr class="table-row-interactive">
                        <td>
                            <span class="badge primary user-id">{{ user.uid }}</span>
                        </td>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">
                                    <div class="avatar-image">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                            <circle cx="12" cy="7" r="4"></circle>
                                        </svg>
                                    </div>
                                </div>
                                <div class="user-details">
                                    <span class="user-name">{{ user.user_name or 'Êú™ËÆæÁΩÆ' }}</span>
                                    {% if user.is_active %}
                                    <span class="user-status active" title="Ê¥ªË∑ÉÁî®Êà∑"></span>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if user.first_name or user.last_name %}
                                <span class="user-fullname">{{ user.first_name or '' }} {{ user.last_name or '' }}</span>
                            {% else %}
                                <span class="text-muted">Êú™ËÆæÁΩÆ</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="stat-badge">
                                <span class="stat-value">{{ user.conversations or 0 }}</span>
                                <span class="stat-label">ÂØπËØù</span>
                            </div>
                        </td>
                        <td>
                            <div class="stat-badge">
                                <span class="stat-value">{{ user.dialog_turns or 0 }}</span>
                                <span class="stat-label">Ê∂àÊÅØ</span>
                            </div>
                        </td>
                        <td>
                            <div class="date-info">
                                <span class="date-value">{{ format_datetime(user.create_at).split(' ')[0] }}</span>
                                <span class="date-time text-muted">{{ format_datetime(user.create_at).split(' ')[1] }}</span>
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="{{ url_for('conversations', search=user.uid) }}" 
                                   class="btn btn-icon btn-sm" title="Êü•ÁúãÂØπËØù" aria-label="Êü•ÁúãÁî®Êà∑ÂØπËØù">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                    </svg>
                                </a>
                                <button class="btn btn-icon btn-sm" title="Êü•ÁúãËØ¶ÊÉÖ" aria-label="Êü•ÁúãÁî®Êà∑ËØ¶ÊÉÖ">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="12" y1="8" x2="12" y2="16"></line>
                                        <line x1="8" y1="12" x2="16" y2="12"></line>
                                    </svg>
                                </button>
                                <button class="btn btn-icon btn-sm btn-danger" title="Âà†Èô§Áî®Êà∑" aria-label="Âà†Èô§Áî®Êà∑">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                                <button class="btn btn-icon btn-sm btn-warning" title="ÁºñËæëÁî®Êà∑" aria-label="ÁºñËæëÁî®Êà∑">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- ÂàÜÈ°µ -->
        {% if total_pages > 1 %}
        <div class="pagination-container">
            <div class="pagination-info">
                ÊòæÁ§∫Á¨¨ <span class="text-primary">{{ (page - 1) * per_page + 1 }}</span> Ëá≥ 
                <span class="text-primary">{{ min(page * per_page, total_users) }}</span> Êù°Ôºå
                ÂÖ± <span class="text-primary">{{ total_users }}</span> Êù°ËÆ∞ÂΩï
            </div>
            <div class="pagination">
                {% if page > 1 %}
                <a class="page-item" href="{{ url_for('users', page=1, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="Á¨¨‰∏ÄÈ°µ" title="Á¨¨‰∏ÄÈ°µ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="11 17 6 12 11 7"></polyline>
                        <polyline points="18 17 13 12 18 7"></polyline>
                    </svg>
                </a>
                <a class="page-item" href="{{ url_for('users', page=page-1, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="‰∏ä‰∏ÄÈ°µ" title="‰∏ä‰∏ÄÈ°µ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </a>
                {% else %}
                <span class="page-item disabled" aria-disabled="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="11 17 6 12 11 7"></polyline>
                        <polyline points="18 17 13 12 18 7"></polyline>
                    </svg>
                </span>
                <span class="page-item disabled" aria-disabled="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </span>
                {% endif %}
                
                {% for p in range(max(1, page-2), min(total_pages+1, page+3)) %}
                <a class="page-item {{ 'active' if p == page else '' }}" href="{{ url_for('users', page=p, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="Á¨¨{{ p }}È°µ" {% if p == page %}aria-current="page"{% endif %}>
                    {{ p }}
                </a>
                {% endfor %}
                
                {% if page < total_pages %}
                <a class="page-item" href="{{ url_for('users', page=page+1, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="‰∏ã‰∏ÄÈ°µ" title="‰∏ã‰∏ÄÈ°µ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </a>
                <a class="page-item" href="{{ url_for('users', page=total_pages, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="ÊúÄÂêé‰∏ÄÈ°µ" title="ÊúÄÂêé‰∏ÄÈ°µ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="13 17 18 12 13 7"></polyline>
                        <polyline points="6 17 11 12 6 7"></polyline>
                    </svg>
                </a>
                {% else %}
                <span class="page-item disabled" aria-disabled="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </span>
                <span class="page-item disabled" aria-disabled="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="13 17 18 12 13 7"></polyline>
                        <polyline points="6 17 11 12 6 7"></polyline>
                    </svg>
                </span>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="7" r="4"></circle>
                    <path d="M5 21v-2a4 4 0 0 1 4-4h6a4 4 0 0 1 4 4v2"></path>
                    <line x1="8" y1="3" x2="16" y2="21"></line>
                </svg>
            </div>
            <h5 class="empty-title">ÊöÇÊó†Áî®Êà∑Êï∞ÊçÆ</h5>
            {% if search_term %}
            <p class="empty-text">Ê≤°ÊúâÊâæÂà∞ÂåπÈÖç "<span class="search-highlight">{{ search_term }}</span>" ÁöÑÁî®Êà∑</p>
            <a href="{{ url_for('users') }}" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-xs">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                Ê∏ÖÈô§ÊêúÁ¥¢
            </a>
            {% else %}
            <p class="empty-text">Á≥ªÁªü‰∏≠ËøòÊ≤°Êúâ‰ªª‰ΩïÁî®Êà∑Êï∞ÊçÆ</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- ÁªüËÆ°‰ø°ÊÅØ -->
{% if users %}
<div class="stats-container">
    <div class="stats-card">
        <div class="stats-header">
            <h3 class="stats-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-xs">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                    <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                </svg>
                ÁªüËÆ°‰ø°ÊÅØ
            </h3>
            <div class="stats-actions">
                <button class="btn btn-icon refresh-stats" title="Âà∑Êñ∞ÁªüËÆ°" aria-label="Âà∑Êñ∞ÁªüËÆ°Êï∞ÊçÆ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="1 4 1 10 7 10"></polyline>
                        <polyline points="23 20 23 14 17 14"></polyline>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon users-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value primary">{{ users|length }}</div>
                    <div class="stat-label">ÂΩìÂâçÈ°µÁî®Êà∑Êï∞</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon conversations-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value success">{{ users|map(attribute='conversations')|select('number')|sum or 0 }}</div>
                    <div class="stat-label">ÂΩìÂâçÈ°µÊÄªÂØπËØùÊï∞</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon messages-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="17" y1="10" x2="3" y2="10"></line>
                        <line x1="21" y1="6" x2="3" y2="6"></line>
                        <line x1="21" y1="14" x2="3" y2="14"></line>
                        <line x1="17" y1="18" x2="3" y2="18"></line>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value info">{{ users|map(attribute='dialog_turns')|select('number')|sum or 0 }}</div>
                    <div class="stat-label">ÂΩìÂâçÈ°µÊÄªÊ∂àÊÅØÊï∞</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon tokens-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value warning">{{ (users|map(attribute='input_tokens')|select('number')|sum or 0) + (users|map(attribute='output_tokens')|select('number')|sum or 0) }}</div>
                    <div class="stat-label">ÂΩìÂâçÈ°µÊÄªTokenÊï∞</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Áî®Êà∑Êìç‰ΩúÊ®°ÊÄÅÊ°Ü -->
<div class="modal" id="userActionModal" role="dialog" aria-labelledby="userActionModalTitle" aria-hidden="true" style="display: none;">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userActionModalTitle">Áî®Êà∑Êìç‰Ωú</h5>
                <button type="button" class="modal-close" aria-label="ÂÖ≥Èó≠">
                    <span aria-hidden="true">√ó</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="userActionForm">
                    <!-- Ë°®ÂçïÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÊ∑ªÂä† -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close">ÂèñÊ∂à</button>
                <button type="button" class="btn btn-primary" id="userActionSubmit">Á°ÆËÆ§</button>
            </div>
        </div>
    </div>
</div>

<!-- Á°ÆËÆ§Âà†Èô§Ê®°ÊÄÅÊ°Ü -->
<div class="modal" id="confirmDeleteModal" role="dialog" aria-labelledby="confirmDeleteModalTitle" aria-hidden="true" style="display: none;">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalTitle">Á°ÆËÆ§Âà†Èô§</h5>
                <button type="button" class="modal-close" aria-label="ÂÖ≥Èó≠">
                    <span aria-hidden="true">√ó</span>
                </button>
            </div>
            <div class="modal-body">
                <p>ÊÇ®Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§Áî®Êà∑ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÈÄÜ„ÄÇ</p>
                <div class="alert alert-warning">
                    <strong>Ë≠¶ÂëäÔºö</strong> Âà†Èô§Áî®Êà∑Â∞ÜÂêåÊó∂Âà†Èô§ËØ•Áî®Êà∑ÁöÑÊâÄÊúâÂØπËØùËÆ∞ÂΩïÂíåÁõ∏ÂÖ≥Êï∞ÊçÆ„ÄÇ
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close">ÂèñÊ∂à</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Á°ÆËÆ§Âà†Èô§</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script src="{{ url_for('static', filename='js/search.js') }}"></script>
<script src="{{ url_for('static', filename='js/user-table.js') }}"></script>
<script src="{{ url_for('static', filename='js/user-filter.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin-modal.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin-form-validation.js') }}"></script>

<script>
// Áî®Êà∑ÁÆ°ÁêÜÈ°µÈù¢ÁâπÂÆöÁöÑJavaScript
document.addEventListener('DOMContentLoaded', function() {
    // ÂàùÂßãÂåñÂà†Èô§Áî®Êà∑ÂäüËÉΩ
    initUserDeleteButtons();
    
    // ÂàùÂßãÂåñÁºñËæëÁî®Êà∑ÂäüËÉΩ
    initUserEditButtons();
});

/**
 * ÂàùÂßãÂåñÂà†Èô§Áî®Êà∑ÊåâÈíÆ
 */
function initUserDeleteButtons() {
    const deleteButtons = document.querySelectorAll('.btn-danger[title="Âà†Èô§Áî®Êà∑"]');
    const confirmDeleteModal = document.getElementById('confirmDeleteModal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    
    if (!confirmDeleteModal || !confirmDeleteBtn) return;
    
    deleteButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const row = this.closest('tr');
            const userIdElement = row.querySelector('.user-id');
            const userId = userIdElement ? userIdElement.textContent.trim() : null;
            
            if (userId) {
                // ÊòæÁ§∫Á°ÆËÆ§Âà†Èô§Ê®°ÊÄÅÊ°Ü
                showModal(confirmDeleteModal);
                
                // ËÆæÁΩÆÁ°ÆËÆ§ÊåâÈíÆÁöÑÁî®Êà∑ID
                confirmDeleteBtn.dataset.userId = userId;
            }
        });
    });
    
    // Á°ÆËÆ§Âà†Èô§ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
    confirmDeleteBtn.addEventListener('click', function() {
        const userId = this.dataset.userId;
        
        if (userId) {
            // ÂèëÈÄÅÂà†Èô§ËØ∑Ê±Ç
            fetch(`/api/users/${userId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Âà†Èô§ÊàêÂäüÔºåÂà∑Êñ∞È°µÈù¢
                    showToast('Âà†Èô§ÊàêÂäü', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    // Âà†Èô§Â§±Ë¥•
                    showToast(data.message || 'Âà†Èô§Â§±Ë¥•', 'error');
                }
            })
            .catch(error => {
                console.error('Âà†Èô§Áî®Êà∑Êó∂Âá∫Èîô:', error);
                showToast('Âà†Èô§Áî®Êà∑Êó∂Âá∫Èîô', 'error');
            })
            .finally(() => {
                // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                hideModal(confirmDeleteModal);
            });
        }
    });
}

/**
 * ÂàùÂßãÂåñÁºñËæëÁî®Êà∑ÊåâÈíÆ
 */
function initUserEditButtons() {
    const editButtons = document.querySelectorAll('.btn-warning[title="ÁºñËæëÁî®Êà∑"]');
    const userActionModal = document.getElementById('userActionModal');
    const userActionForm = document.getElementById('userActionForm');
    const userActionSubmit = document.getElementById('userActionSubmit');
    
    if (!userActionModal || !userActionForm || !userActionSubmit) return;
    
    editButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const row = this.closest('tr');
            const userIdElement = row.querySelector('.user-id');
            const userId = userIdElement ? userIdElement.textContent.trim() : null;
            
            if (userId) {
                // Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆ
                fetch(`/api/users/${userId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Â°´ÂÖÖË°®Âçï
                            userActionForm.innerHTML = `
                                <div class="form-group">
                                    <label for="edit-user-id" class="form-label">Áî®Êà∑ID</label>
                                    <input type="text" id="edit-user-id" class="form-control" value="${data.user.uid}" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="edit-user-name" class="form-label">Áî®Êà∑Âêç</label>
                                    <input type="text" id="edit-user-name" class="form-control" value="${data.user.user_name || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="edit-first-name" class="form-label">Âêç</label>
                                    <input type="text" id="edit-first-name" class="form-control" value="${data.user.first_name || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="edit-last-name" class="form-label">Âßì</label>
                                    <input type="text" id="edit-last-name" class="form-control" value="${data.user.last_name || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="edit-account-tier" class="form-label">Ë¥¶Êà∑Á≠âÁ∫ß</label>
                                    <select id="edit-account-tier" class="form-control">
                                        <option value="free" ${data.user.account_tier === 'free' ? 'selected' : ''}>ÂÖçË¥πÁî®Êà∑</option>
                                        <option value="premium" ${data.user.account_tier === 'premium' ? 'selected' : ''}>È´òÁ∫ßÁî®Êà∑</option>
                                        <option value="admin" ${data.user.account_tier === 'admin' ? 'selected' : ''}>ÁÆ°ÁêÜÂëò</option>
                                    </select>
                                </div>
                            `;
                            
                            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                            document.getElementById('userActionModalTitle').textContent = 'ÁºñËæëÁî®Êà∑';
                            userActionSubmit.textContent = '‰øùÂ≠ò';
                            userActionSubmit.dataset.userId = userId;
                            userActionSubmit.dataset.action = 'edit';
                            
                            showModal(userActionModal);
                        } else {
                            showToast(data.message || 'Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆÂ§±Ë¥•', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆÊó∂Âá∫Èîô:', error);
                        showToast('Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆÊó∂Âá∫Èîô', 'error');
                    });
            }
        });
    });
    
    // Êèê‰∫§ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
    userActionSubmit.addEventListener('click', function() {
        const userId = this.dataset.userId;
        const action = this.dataset.action;
        
        if (userId && action === 'edit') {
            // Ëé∑ÂèñË°®ÂçïÊï∞ÊçÆ
            const userData = {
                user_name: document.getElementById('edit-user-name').value,
                first_name: document.getElementById('edit-first-name').value,
                last_name: document.getElementById('edit-last-name').value,
                account_tier: document.getElementById('edit-account-tier').value
            };
            
            // ÂèëÈÄÅÊõ¥Êñ∞ËØ∑Ê±Ç
            fetch(`/api/users/${userId}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(userData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Êõ¥Êñ∞ÊàêÂäüÔºåÂà∑Êñ∞È°µÈù¢
                    showToast('Êõ¥Êñ∞ÊàêÂäü', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    // Êõ¥Êñ∞Â§±Ë¥•
                    showToast(data.message || 'Êõ¥Êñ∞Â§±Ë¥•', 'error');
                }
            })
            .catch(error => {
                console.error('Êõ¥Êñ∞Áî®Êà∑Êó∂Âá∫Èîô:', error);
                showToast('Êõ¥Êñ∞Áî®Êà∑Êó∂Âá∫Èîô', 'error');
            })
            .finally(() => {
                // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                hideModal(userActionModal);
            });
        }
    });
}

/**
 * ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
 * @param {HTMLElement} modal - Ê®°ÊÄÅÊ°ÜÂÖÉÁ¥†
 */
function showModal(modal) {
    if (!modal) return;
    
    modal.style.display = 'block';
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
    
    // ÁªëÂÆöÂÖ≥Èó≠ÊåâÈíÆ‰∫ã‰ª∂
    const closeButtons = modal.querySelectorAll('.modal-close');
    closeButtons.forEach(button => {
        button.addEventListener('click', () => {
            hideModal(modal);
        });
    });
    
    // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
    modal.querySelector('.modal-backdrop').addEventListener('click', () => {
        hideModal(modal);
    });
}

/**
 * ÈöêËóèÊ®°ÊÄÅÊ°Ü
 * @param {HTMLElement} modal - Ê®°ÊÄÅÊ°ÜÂÖÉÁ¥†
 */
function hideModal(modal) {
    if (!modal) return;
    
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

/**
 * ÊòæÁ§∫ÊèêÁ§∫Ê∂àÊÅØ
 * @param {string} message - Ê∂àÊÅØÂÜÖÂÆπ
 * @param {string} type - Ê∂àÊÅØÁ±ªÂûãÔºàsuccess, error, warning, infoÔºâ
 */
function showToast(message, type = 'info') {
    // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®toastÂÆπÂô®
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container';
        document.body.appendChild(toastContainer);
    }
    
    // ÂàõÂª∫toastÂÖÉÁ¥†
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <span class="toast-message">${message}</span>
        </div>
    `;
    
    // Ê∑ªÂä†Âà∞ÂÆπÂô®
    toastContainer.appendChild(toast);
    
    // ÊòæÁ§∫Âä®Áîª
    setTimeout(() => {
        toast.classList.add('show');
    }, 10);
    
    // Ëá™Âä®ÂÖ≥Èó≠
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
}

/**
 * Ëé∑ÂèñCSRF‰ª§Áâå
 * @returns {string} CSRF‰ª§Áâå
 */
function getCsrfToken() {
    // ‰ªémetaÊ†áÁ≠æÊàñcookie‰∏≠Ëé∑ÂèñCSRF‰ª§Áâå
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag) {
        return metaTag.getAttribute('content');
    }
    
    // ‰ªécookie‰∏≠Ëé∑Âèñ
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrf_token') {
            return value;
        }
    }
    
    return '';
}
</script>
{% endblock %}
{% endblock %}