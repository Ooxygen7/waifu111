{% extends "admin_base.html" %}

{% block title %}ç”¨æˆ·ç®¡ç† - CyberWaifu Bot ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block page_title %}ç”¨æˆ·ç®¡ç†{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">
    ç”¨æˆ·ç®¡ç†
</li>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="header-container">
            <div class="header-title">
                <h3><i class="icon">ğŸ‘¥</i> ç”¨æˆ·ç®¡ç†</h3>
            </div>
            <div class="search-container">
                <form method="GET" class="search-form">
                    <div class="search-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>
                    <input type="text" name="search" class="search-input" 
                           placeholder="æœç´¢ç”¨æˆ·IDã€ç”¨æˆ·å..." value="{{ search_term }}"
                           aria-label="æœç´¢ç”¨æˆ·">
                    <div class="search-loading"></div>
                    {% if search_term %}
                    <a href="{{ url_for('users') }}" class="clear-button" aria-label="æ¸…é™¤æœç´¢">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </a>
                    {% endif %}
                    <button type="submit" class="search-button" aria-label="æœç´¢">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </button>
                </form>
                {% if search_term %}
                <div class="search-status">æ‰¾åˆ°ä¸ "{{ search_term }}" ç›¸å…³çš„ç»“æœ</div>
                {% endif %}
            </div>
        </div>
        
        <div class="filter-container mt-md">
            <div class="filter-label">ç­›é€‰ï¼š</div>
            
            <button class="filter-button" aria-label="æ‰“å¼€ç­›é€‰é€‰é¡¹">
                <span class="filter-button-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                </span>
                <span>ç­›é€‰æ¡ä»¶</span>
            </button>
            
            <div class="filter-dropdown">
                <div class="filter-group">
                    <div class="filter-group-title">æ³¨å†Œæ—¶é—´</div>
                    <div class="filter-options">
                        <div class="filter-option" data-key="date" data-value="today">ä»Šå¤©</div>
                        <div class="filter-option" data-key="date" data-value="week">æœ¬å‘¨</div>
                        <div class="filter-option" data-key="date" data-value="month">æœ¬æœˆ</div>
                        <div class="filter-option" data-key="date" data-value="year">ä»Šå¹´</div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <div class="filter-group-title">å¯¹è¯æ•°é‡</div>
                    <div class="filter-options">
                        <div class="filter-option" data-key="conversations" data-value="0">æ— å¯¹è¯</div>
                        <div class="filter-option" data-key="conversations" data-value="1-10">1-10</div>
                        <div class="filter-option" data-key="conversations" data-value="10+">10+</div>
                        <div class="filter-option" data-key="conversations" data-value="50+">50+</div>
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-text" id="clear-filters">æ¸…é™¤ç­›é€‰</button>
                    <button class="btn btn-primary" id="apply-filters">åº”ç”¨ç­›é€‰</button>
                </div>
            </div>
            
            <div class="filter-tags">
                <!-- ç­›é€‰æ ‡ç­¾å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if users %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="number">
                            <a href="{{ url_for('users', search=search_term, sort_by='uid', sort_order=next_sort_order('uid')) }}" 
                               class="sort-link" aria-label="æŒ‰ç”¨æˆ·IDæ’åº">
                                <span>ç”¨æˆ·ID</span>
                                <span class="sort-indicator">
                                    {% if sort_by == 'uid' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                            {% if sort_order == 'asc' %}
                                            <polyline points="18 15 12 9 6 15"></polyline>
                                            {% else %}
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                            {% endif %}
                                        </svg>
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <polyline points="19 12 12 19 5 12"></polyline>
                                        </svg>
                                    {% endif %}
                                </span>
                            </a>
                        </th>
                        <th class="sortable" data-sort="text">
                            <a href="{{ url_for('users', search=search_term, sort_by='user_name', sort_order=next_sort_order('user_name')) }}" 
                               class="sort-link" aria-label="æŒ‰ç”¨æˆ·åæ’åº">
                                <span>ç”¨æˆ·å</span>
                                <span class="sort-indicator">
                                    {% if sort_by == 'user_name' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                            {% if sort_order == 'asc' %}
                                            <polyline points="18 15 12 9 6 15"></polyline>
                                            {% else %}
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                            {% endif %}
                                        </svg>
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <polyline points="19 12 12 19 5 12"></polyline>
                                        </svg>
                                    {% endif %}
                                </span>
                            </a>
                        </th>
                        <th>å§“å</th>
                        <th class="sortable" data-sort="number">
                            <a href="{{ url_for('users', search=search_term, sort_by='conversations', sort_order=next_sort_order('conversations')) }}" 
                               class="sort-link" aria-label="æŒ‰å¯¹è¯æ•°æ’åº">
                                <span>å¯¹è¯æ•°</span>
                                <span class="sort-indicator">
                                    {% if sort_by == 'conversations' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                            {% if sort_order == 'asc' %}
                                            <polyline points="18 15 12 9 6 15"></polyline>
                                            {% else %}
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                            {% endif %}
                                        </svg>
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <polyline points="19 12 12 19 5 12"></polyline>
                                        </svg>
                                    {% endif %}
                                </span>
                            </a>
                        </th>
                        <th class="sortable" data-sort="number">
                            <a href="{{ url_for('users', search=search_term, sort_by='dialog_turns', sort_order=next_sort_order('dialog_turns')) }}" 
                               class="sort-link" aria-label="æŒ‰æ¶ˆæ¯æ•°æ’åº">
                                <span>æ¶ˆæ¯æ•°</span>
                                <span class="sort-indicator">
                                    {% if sort_by == 'dialog_turns' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                            {% if sort_order == 'asc' %}
                                            <polyline points="18 15 12 9 6 15"></polyline>
                                            {% else %}
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                            {% endif %}
                                        </svg>
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <polyline points="19 12 12 19 5 12"></polyline>
                                        </svg>
                                    {% endif %}
                                </span>
                            </a>
                        </th>
                        <th class="sortable" data-sort="date">
                            <a href="{{ url_for('users', search=search_term, sort_by='create_at', sort_order=next_sort_order('create_at')) }}" 
                               class="sort-link" aria-label="æŒ‰æ³¨å†Œæ—¶é—´æ’åº">
                                <span>æ³¨å†Œæ—¶é—´</span>
                                <span class="sort-indicator">
                                    {% if sort_by == 'create_at' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                            {% if sort_order == 'asc' %}
                                            <polyline points="18 15 12 9 6 15"></polyline>
                                            {% else %}
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                            {% endif %}
                                        </svg>
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <polyline points="19 12 12 19 5 12"></polyline>
                                        </svg>
                                    {% endif %}
                                </span>
                            </a>
                        </th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr class="table-row-interactive">
                        <td>
                            <span class="badge primary user-id">{{ user.uid }}</span>
                        </td>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">
                                    <div class="avatar-image">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                            <circle cx="12" cy="7" r="4"></circle>
                                        </svg>
                                    </div>
                                </div>
                                <div class="user-details">
                                    <span class="user-name">{{ user.user_name or 'æœªè®¾ç½®' }}</span>
                                    {% if user.is_active %}
                                    <span class="user-status active" title="æ´»è·ƒç”¨æˆ·"></span>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if user.first_name or user.last_name %}
                                <span class="user-fullname">{{ user.first_name or '' }} {{ user.last_name or '' }}</span>
                            {% else %}
                                <span class="text-muted">æœªè®¾ç½®</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="stat-badge">
                                <span class="stat-value">{{ user.conversations or 0 }}</span>
                                <span class="stat-label">å¯¹è¯</span>
                            </div>
                        </td>
                        <td>
                            <div class="stat-badge">
                                <span class="stat-value">{{ user.dialog_turns or 0 }}</span>
                                <span class="stat-label">æ¶ˆæ¯</span>
                            </div>
                        </td>
                        <td>
                            <div class="date-info">
                                <span class="date-value">{{ format_datetime(user.create_at).split(' ')[0] }}</span>
                                <span class="date-time text-muted">{{ format_datetime(user.create_at).split(' ')[1] }}</span>
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="{{ url_for('conversations', search=user.uid) }}" 
                                   class="btn btn-icon btn-sm" title="æŸ¥çœ‹å¯¹è¯" aria-label="æŸ¥çœ‹ç”¨æˆ·å¯¹è¯">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                    </svg>
                                </a>
                                <button class="btn btn-icon btn-sm" title="æŸ¥çœ‹è¯¦æƒ…" aria-label="æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="12" y1="8" x2="12" y2="16"></line>
                                        <line x1="8" y1="12" x2="16" y2="12"></line>
                                    </svg>
                                </button>
                                <button class="btn btn-icon btn-sm btn-danger" title="åˆ é™¤ç”¨æˆ·" aria-label="åˆ é™¤ç”¨æˆ·">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                                <button class="btn btn-icon btn-sm btn-warning" title="ç¼–è¾‘ç”¨æˆ·" aria-label="ç¼–è¾‘ç”¨æˆ·">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- åˆ†é¡µ -->
        {% if total_pages > 1 %}
        <div class="pagination-container">
            <div class="pagination-info">
                æ˜¾ç¤ºç¬¬ <span class="text-primary">{{ (page - 1) * per_page + 1 }}</span> è‡³ 
                <span class="text-primary">{{ min(page * per_page, total_users) }}</span> æ¡ï¼Œ
                å…± <span class="text-primary">{{ total_users }}</span> æ¡è®°å½•
            </div>
            <div class="pagination">
                {% if page > 1 %}
                <a class="page-item" href="{{ url_for('users', page=1, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="ç¬¬ä¸€é¡µ" title="ç¬¬ä¸€é¡µ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="11 17 6 12 11 7"></polyline>
                        <polyline points="18 17 13 12 18 7"></polyline>
                    </svg>
                </a>
                <a class="page-item" href="{{ url_for('users', page=page-1, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="ä¸Šä¸€é¡µ" title="ä¸Šä¸€é¡µ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </a>
                {% else %}
                <span class="page-item disabled" aria-disabled="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="11 17 6 12 11 7"></polyline>
                        <polyline points="18 17 13 12 18 7"></polyline>
                    </svg>
                </span>
                <span class="page-item disabled" aria-disabled="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </span>
                {% endif %}
                
                {% for p in range(max(1, page-2), min(total_pages+1, page+3)) %}
                <a class="page-item {{ 'active' if p == page else '' }}" href="{{ url_for('users', page=p, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="ç¬¬{{ p }}é¡µ" {% if p == page %}aria-current="page"{% endif %}>
                    {{ p }}
                </a>
                {% endfor %}
                
                {% if page < total_pages %}
                <a class="page-item" href="{{ url_for('users', page=page+1, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="ä¸‹ä¸€é¡µ" title="ä¸‹ä¸€é¡µ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </a>
                <a class="page-item" href="{{ url_for('users', page=total_pages, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="æœ€åä¸€é¡µ" title="æœ€åä¸€é¡µ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="13 17 18 12 13 7"></polyline>
                        <polyline points="6 17 11 12 6 7"></polyline>
                    </svg>
                </a>
                {% else %}
                <span class="page-item disabled" aria-disabled="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </span>
                <span class="page-item disabled" aria-disabled="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="13 17 18 12 13 7"></polyline>
                        <polyline points="6 17 11 12 6 7"></polyline>
                    </svg>
                </span>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="7" r="4"></circle>
                    <path d="M5 21v-2a4 4 0 0 1 4-4h6a4 4 0 0 1 4 4v2"></path>
                    <line x1="8" y1="3" x2="16" y2="21"></line>
                </svg>
            </div>
            <h5 class="empty-title">æš‚æ— ç”¨æˆ·æ•°æ®</h5>
            {% if search_term %}
            <p class="empty-text">æ²¡æœ‰æ‰¾åˆ°åŒ¹é… "<span class="search-highlight">{{ search_term }}</span>" çš„ç”¨æˆ·</p>
            <a href="{{ url_for('users') }}" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-xs">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                æ¸…é™¤æœç´¢
            </a>
            {% else %}
            <p class="empty-text">ç³»ç»Ÿä¸­è¿˜æ²¡æœ‰ä»»ä½•ç”¨æˆ·æ•°æ®</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- ç»Ÿè®¡ä¿¡æ¯ -->
{% if users %}
<div class="stats-container">
    <div class="stats-card">
        <div class="stats-header">
            <h3 class="stats-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-xs">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                    <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                </svg>
                ç»Ÿè®¡ä¿¡æ¯
            </h3>
            <div class="stats-actions">
                <button class="btn btn-icon refresh-stats" title="åˆ·æ–°ç»Ÿè®¡" aria-label="åˆ·æ–°ç»Ÿè®¡æ•°æ®">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="1 4 1 10 7 10"></polyline>
                        <polyline points="23 20 23 14 17 14"></polyline>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon users-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value primary">{{ users|length }}</div>
                    <div class="stat-label">å½“å‰é¡µç”¨æˆ·æ•°</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon conversations-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value success">{{ users|map(attribute='conversations')|select('number')|sum or 0 }}</div>
                    <div class="stat-label">å½“å‰é¡µæ€»å¯¹è¯æ•°</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon messages-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="17" y1="10" x2="3" y2="10"></line>
                        <line x1="21" y1="6" x2="3" y2="6"></line>
                        <line x1="21" y1="14" x2="3" y2="14"></line>
                        <line x1="17" y1="18" x2="3" y2="18"></line>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value info">{{ users|map(attribute='dialog_turns')|select('number')|sum or 0 }}</div>
                    <div class="stat-label">å½“å‰é¡µæ€»æ¶ˆæ¯æ•°</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon tokens-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value warning">{{ (users|map(attribute='input_tokens')|select('number')|sum or 0) + (users|map(attribute='output_tokens')|select('number')|sum or 0) }}</div>
                    <div class="stat-label">å½“å‰é¡µæ€»Tokenæ•°</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ç”¨æˆ·æ“ä½œæ¨¡æ€æ¡† -->
<div class="modal" id="userActionModal" role="dialog" aria-labelledby="userActionModalTitle" aria-hidden="true" style="display: none;">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userActionModalTitle">ç”¨æˆ·æ“ä½œ</h5>
                <button type="button" class="modal-close" aria-label="å…³é—­">
                    <span aria-hidden="true">Ã—</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="userActionForm">
                    <!-- è¡¨å•å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="userActionSubmit">ç¡®è®¤</button>
            </div>
        </div>
    </div>
</div>

<!-- ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡† -->
<div class="modal" id="confirmDeleteModal" role="dialog" aria-labelledby="confirmDeleteModalTitle" aria-hidden="true" style="display: none;">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalTitle">ç¡®è®¤åˆ é™¤</h5>
                <button type="button" class="modal-close" aria-label="å…³é—­">
                    <span aria-hidden="true">Ã—</span>
                </button>
            </div>
            <div class="modal-body">
                <p>æ‚¨ç¡®å®šè¦åˆ é™¤æ­¤ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚</p>
                <div class="alert alert-warning">
                    <strong>è­¦å‘Šï¼š</strong> åˆ é™¤ç”¨æˆ·å°†åŒæ—¶åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰å¯¹è¯è®°å½•å’Œç›¸å…³æ•°æ®ã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script src="{{ url_for('static', filename='js/search.js') }}"></script>
<script src="{{ url_for('static', filename='js/user-table.js') }}"></script>
<script src="{{ url_for('static', filename='js/user-filter.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin-modal.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin-form-validation.js') }}"></script>

<script>
// ç”¨æˆ·ç®¡ç†é¡µé¢ç‰¹å®šçš„JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–åˆ é™¤ç”¨æˆ·åŠŸèƒ½
    initUserDeleteButtons();
    
    // åˆå§‹åŒ–ç¼–è¾‘ç”¨æˆ·åŠŸèƒ½
    initUserEditButtons();
});

/**
 * åˆå§‹åŒ–åˆ é™¤ç”¨æˆ·æŒ‰é’®
 */
function initUserDeleteButtons() {
    const deleteButtons = document.querySelectorAll('.btn-danger[title="åˆ é™¤ç”¨æˆ·"]');
    const confirmDeleteModal = document.getElementById('confirmDeleteModal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    
    if (!confirmDeleteModal || !confirmDeleteBtn) return;
    
    deleteButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const row = this.closest('tr');
            const userIdElement = row.querySelector('.user-id');
            const userId = userIdElement ? userIdElement.textContent.trim() : null;
            
            if (userId) {
                // æ˜¾ç¤ºç¡®è®¤åˆ é™¤æ¨¡æ€æ¡†
                showModal(confirmDeleteModal);
                
                // è®¾ç½®ç¡®è®¤æŒ‰é’®çš„ç”¨æˆ·ID
                confirmDeleteBtn.dataset.userId = userId;
            }
        });
    });
    
    // ç¡®è®¤åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    confirmDeleteBtn.addEventListener('click', function() {
        const userId = this.dataset.userId;
        
        if (userId) {
            // å‘é€åˆ é™¤è¯·æ±‚
            fetch(`/api/users/${userId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // åˆ é™¤æˆåŠŸï¼Œåˆ·æ–°é¡µé¢
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    // åˆ é™¤å¤±è´¥
                    showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                console.error('åˆ é™¤ç”¨æˆ·æ—¶å‡ºé”™:', error);
                showToast('åˆ é™¤ç”¨æˆ·æ—¶å‡ºé”™', 'error');
            })
            .finally(() => {
                // å…³é—­æ¨¡æ€æ¡†
                hideModal(confirmDeleteModal);
            });
        }
    });
}

/**
 * åˆå§‹åŒ–ç¼–è¾‘ç”¨æˆ·æŒ‰é’®
 */
function initUserEditButtons() {
    const editButtons = document.querySelectorAll('.btn-warning[title="ç¼–è¾‘ç”¨æˆ·"]');
    const userActionModal = document.getElementById('userActionModal');
    const userActionForm = document.getElementById('userActionForm');
    const userActionSubmit = document.getElementById('userActionSubmit');
    
    if (!userActionModal || !userActionForm || !userActionSubmit) return;
    
    editButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const row = this.closest('tr');
            const userIdElement = row.querySelector('.user-id');
            const userId = userIdElement ? userIdElement.textContent.trim() : null;
            
            if (userId) {
                // è·å–ç”¨æˆ·æ•°æ®
                fetch(`/api/users/${userId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // å¡«å……è¡¨å•
                            userActionForm.innerHTML = `
                                <div class="form-group">
                                    <label for="edit-user-id" class="form-label">ç”¨æˆ·ID</label>
                                    <input type="text" id="edit-user-id" class="form-control" value="${data.user.uid}" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="edit-user-name" class="form-label">ç”¨æˆ·å</label>
                                    <input type="text" id="edit-user-name" class="form-control" value="${data.user.user_name || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="edit-first-name" class="form-label">å</label>
                                    <input type="text" id="edit-first-name" class="form-control" value="${data.user.first_name || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="edit-last-name" class="form-label">å§“</label>
                                    <input type="text" id="edit-last-name" class="form-control" value="${data.user.last_name || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="edit-account-tier" class="form-label">è´¦æˆ·ç­‰çº§</label>
                                    <select id="edit-account-tier" class="form-control">
                                        <option value="free" ${data.user.account_tier === 'free' ? 'selected' : ''}>å…è´¹ç”¨æˆ·</option>
                                        <option value="premium" ${data.user.account_tier === 'premium' ? 'selected' : ''}>é«˜çº§ç”¨æˆ·</option>
                                        <option value="admin" ${data.user.account_tier === 'admin' ? 'selected' : ''}>ç®¡ç†å‘˜</option>
                                    </select>
                                </div>
                            `;
                            
                            // æ˜¾ç¤ºæ¨¡æ€æ¡†
                            document.getElementById('userActionModalTitle').textContent = 'ç¼–è¾‘ç”¨æˆ·';
                            userActionSubmit.textContent = 'ä¿å­˜';
                            userActionSubmit.dataset.userId = userId;
                            userActionSubmit.dataset.action = 'edit';
                            
                            showModal(userActionModal);
                        } else {
                            showToast(data.message || 'è·å–ç”¨æˆ·æ•°æ®å¤±è´¥', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('è·å–ç”¨æˆ·æ•°æ®æ—¶å‡ºé”™:', error);
                        showToast('è·å–ç”¨æˆ·æ•°æ®æ—¶å‡ºé”™', 'error');
                    });
            }
        });
    });
    
    // æäº¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    userActionSubmit.addEventListener('click', function() {
        const userId = this.dataset.userId;
        const action = this.dataset.action;
        
        if (userId && action === 'edit') {
            // è·å–è¡¨å•æ•°æ®
            const userData = {
                user_name: document.getElementById('edit-user-name').value,
                first_name: document.getElementById('edit-first-name').value,
                last_name: document.getElementById('edit-last-name').value,
                account_tier: document.getElementById('edit-account-tier').value
            };
            
            // å‘é€æ›´æ–°è¯·æ±‚
            fetch(`/api/users/${userId}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(userData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ›´æ–°æˆåŠŸï¼Œåˆ·æ–°é¡µé¢
                    showToast('æ›´æ–°æˆåŠŸ', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    // æ›´æ–°å¤±è´¥
                    showToast(data.message || 'æ›´æ–°å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                console.error('æ›´æ–°ç”¨æˆ·æ—¶å‡ºé”™:', error);
                showToast('æ›´æ–°ç”¨æˆ·æ—¶å‡ºé”™', 'error');
            })
            .finally(() => {
                // å…³é—­æ¨¡æ€æ¡†
                hideModal(userActionModal);
            });
        }
    });
}

/**
 * æ˜¾ç¤ºæ¨¡æ€æ¡†
 * @param {HTMLElement} modal - æ¨¡æ€æ¡†å…ƒç´ 
 */
function showModal(modal) {
    if (!modal) return;
    
    modal.style.display = 'block';
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
    
    // ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
    const closeButtons = modal.querySelectorAll('.modal-close');
    closeButtons.forEach(button => {
        button.addEventListener('click', () => {
            hideModal(modal);
        });
    });
    
    // ç‚¹å‡»èƒŒæ™¯å…³é—­
    modal.querySelector('.modal-backdrop').addEventListener('click', () => {
        hideModal(modal);
    });
}

/**
 * éšè—æ¨¡æ€æ¡†
 * @param {HTMLElement} modal - æ¨¡æ€æ¡†å…ƒç´ 
 */
function hideModal(modal) {
    if (!modal) return;
    
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

/**
 * æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
 * @param {string} message - æ¶ˆæ¯å†…å®¹
 * @param {string} type - æ¶ˆæ¯ç±»å‹ï¼ˆsuccess, error, warning, infoï¼‰
 */
function showToast(message, type = 'info') {
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨toastå®¹å™¨
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container';
        document.body.appendChild(toastContainer);
    }
    
    // åˆ›å»ºtoastå…ƒç´ 
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <span class="toast-message">${message}</span>
        </div>
    `;
    
    // æ·»åŠ åˆ°å®¹å™¨
    toastContainer.appendChild(toast);
    
    // æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => {
        toast.classList.add('show');
    }, 10);
    
    // è‡ªåŠ¨å…³é—­
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
}

/**
 * è·å–CSRFä»¤ç‰Œ
 * @returns {string} CSRFä»¤ç‰Œ
 */
function getCsrfToken() {
    // ä»metaæ ‡ç­¾æˆ–cookieä¸­è·å–CSRFä»¤ç‰Œ
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag) {
        return metaTag.getAttribute('content');
    }
    
    // ä»cookieä¸­è·å–
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrf_token') {
            return value;
        }
    }
    
    return '';
}
</script>
{% endblock %}
{% endblock %}