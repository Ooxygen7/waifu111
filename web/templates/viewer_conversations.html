{% extends "viewer_base.html" %}

{% block title %}å¯¹è¯è®°å½• - CyberWaifu Bot æµè§ˆç³»ç»Ÿ{% endblock %}

{% block page_title %}å¯¹è¯è®°å½•{% endblock %}

{% block content %}
<div class="content-wrapper">
<div class="card mb-4">
    <div class="card-body">
        <div class="filter-container">
            <!-- æœç´¢æ¡† -->
            <div class="search-container">
                <form method="GET" class="search-form">
                    <div class="search-icon">ğŸ”</div>
                    <input type="text" name="search" value="{{ search }}" class="search-input" 
                           placeholder="æœç´¢ç”¨æˆ·åã€ç”¨æˆ·ID..." aria-label="æœç´¢å¯¹è¯">
                    {% if search %}
                    <a href="{{ url_for('viewer_conversations') }}" class="clear-button" aria-label="æ¸…é™¤æœç´¢">âœ•</a>
                    {% endif %}
                    <button type="submit" class="search-button" aria-label="æœç´¢">
                        <span class="search-button-text">æœç´¢</span>
                    </button>
                </form>
            </div>
            
            <!-- æ’åºé€‰é¡¹ -->
            <div class="sort-container">
                <div class="sort-dropdown">
                    <button class="filter-button" id="sortDropdown" onclick="toggleSortMenu()" aria-haspopup="true" aria-expanded="false">
                        <span class="filter-button-icon">â†•ï¸</span> æ’åºæ–¹å¼
                        <span class="dropdown-arrow">â–¼</span>
                    </button>
                    <div class="sort-menu" id="sortMenu" role="menu">
                        <a class="sort-item {% if sort_by == 'conv_id' %}active{% endif %}" 
                           href="{{ url_for('viewer_conversations', search=search, sort_by='conv_id', sort_order=next_sort_order('conv_id')) }}"
                           role="menuitem">
                           æŒ‰å¯¹è¯IDæ’åº {% if sort_by == 'conv_id' %}{{ 'â†‘' if sort_order == 'asc' else 'â†“' }}{% endif %}
                        </a>
                        <a class="sort-item {% if sort_by == 'user_id' %}active{% endif %}" 
                           href="{{ url_for('viewer_conversations', search=search, sort_by='user_id', sort_order=next_sort_order('user_id')) }}"
                           role="menuitem">
                           æŒ‰ç”¨æˆ·æ’åº {% if sort_by == 'user_id' %}{{ 'â†‘' if sort_order == 'asc' else 'â†“' }}{% endif %}
                        </a>
                        <a class="sort-item {% if sort_by == 'character' %}active{% endif %}" 
                           href="{{ url_for('viewer_conversations', search=search, sort_by='character', sort_order=next_sort_order('character')) }}"
                           role="menuitem">
                           æŒ‰è§’è‰²æ’åº {% if sort_by == 'character' %}{{ 'â†‘' if sort_order == 'asc' else 'â†“' }}{% endif %}
                        </a>
                        <a class="sort-item {% if sort_by == 'turns' %}active{% endif %}" 
                           href="{{ url_for('viewer_conversations', search=search, sort_by='turns', sort_order=next_sort_order('turns')) }}"
                           role="menuitem">
                           æŒ‰è½®æ¬¡æ’åº {% if sort_by == 'turns' %}{{ 'â†‘' if sort_order == 'asc' else 'â†“' }}{% endif %}
                        </a>
                        <a class="sort-item {% if sort_by == 'create_at' %}active{% endif %}" 
                           href="{{ url_for('viewer_conversations', search=search, sort_by='create_at', sort_order=next_sort_order('create_at')) }}"
                           role="menuitem">
                           æŒ‰åˆ›å»ºæ—¶é—´æ’åº {% if sort_by == 'create_at' %}{{ 'â†‘' if sort_order == 'asc' else 'â†“' }}{% endif %}
                        </a>
                        <a class="sort-item {% if sort_by == 'update_at' %}active{% endif %}" 
                           href="{{ url_for('viewer_conversations', search=search, sort_by='update_at', sort_order=next_sort_order('update_at')) }}"
                           role="menuitem">
                           æŒ‰æ›´æ–°æ—¶é—´æ’åº {% if sort_by == 'update_at' %}{{ 'â†‘' if sort_order == 'asc' else 'â†“' }}{% endif %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¯¹è¯åˆ—è¡¨ -->
<div class="card">
    <div class="card-header">
        <div class="conversation-list-header">
            <div class="conversation-list-title">
                <span class="conversation-list-title-icon">ğŸ’¬</span> å¯¹è¯åˆ—è¡¨
                {% if conversations %}
                <span class="conversation-count-badge">{{ conversations|length }} ä¸ªå¯¹è¯</span>
                {% endif %}
            </div>
            
            {% if search %}
            <div class="search-status">
                æœç´¢ç»“æœ: "<span class="search-term">{{ search }}</span>"
                <span class="search-result-count">{{ conversations|length }}</span>
                <a href="{{ url_for('viewer_conversations') }}" class="filter-tag">
                    æ¸…é™¤ç­›é€‰ <span class="filter-tag-close">âœ•</span>
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="card-body">
        {% if conversations %}
        <div class="conversation-list">
            {% for conv in conversations %}
            <div class="conversation-card" data-id="{{ conv.conv_id }}">
                <div class="conversation-header">
                    <div class="conversation-id">{{ conv.conv_id }}</div>
                    
                    {% if conv.character %}
                    <div class="character-badge">
                        <span class="character-badge-icon">ğŸ‘¤</span> {{ conv.character }}
                    </div>
                    {% endif %}
                    
                    <div class="turns-badge">
                        <span class="turns-badge-icon">ğŸ’¬</span> 
                        <span class="turns-count">{{ conv.turns or 0 }}</span>
                        <span class="turns-text">è½®å¯¹è¯</span>
                    </div>
                    
                    <div class="conversation-time">
                        <span class="conversation-time-icon">ğŸ•’</span> 
                        åˆ›å»ºäº {{ conv.create_at|format_datetime if conv.create_at else 'æœªçŸ¥' }}
                        {% if conv.update_at and conv.update_at != conv.create_at %}
                        Â· æ›´æ–°äº {{ conv.update_at|format_datetime }}
                        {% endif %}
                    </div>
                </div>
                
                <div class="conversation-body">
                    <div class="conversation-user">
                        <div class="conversation-avatar">
                            {% if conv.first_name %}
                                {{ conv.first_name[0] | upper }}
                            {% else %}
                                ğŸ‘¤
                            {% endif %}
                        </div>
                        <div class="conversation-user-info">
                            <div class="conversation-user-name">{{ conv.first_name or conv.user_name or 'æœªçŸ¥ç”¨æˆ·' }}</div>
                            <div class="conversation-user-id">ID: {{ conv.user_id }}</div>
                        </div>
                    </div>
                    
                    <div class="conversation-details">
                        <div class="conversation-summary-modern" data-id="{{ conv.conv_id }}">
                            <div class="summary-header">
                                <i class="fas fa-quote-left summary-icon"></i>
                                <span class="summary-label">å¯¹è¯æ‘˜è¦</span>
                            </div>
                            {% if conv.summary %}
                            <div class="summary-content-modern">{{ conv.summary }}</div>
                            {% else %}
                            <div class="summary-placeholder-modern">
                                <i class="fas fa-info-circle"></i>
                                <span>æš‚æ— å¯¹è¯æ‘˜è¦</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="conversation-footer">
                    <div class="conversation-actions">
                        <a href="{{ url_for('viewer_dialogs', conv_id=conv.conv_id) }}" 
                           class="conversation-action-btn conversation-action-btn-primary" 
                           title="æŸ¥çœ‹å¯¹è¯è¯¦æƒ…">
                            <span class="conversation-action-btn-icon">ğŸ‘ï¸</span> æŸ¥çœ‹è¯¦æƒ…
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- åˆ†é¡µ -->
        {% if total_pages > 1 %}
        <div class="pagination-container">
            <div class="pagination" role="navigation" aria-label="åˆ†é¡µå¯¼èˆª">
                {% if page > 1 %}
                <a class="page-item page-prev" href="{{ url_for('viewer_conversations', page=page-1, search=search, sort_by=sort_by, sort_order=sort_order) }}" aria-label="ä¸Šä¸€é¡µ">
                    &laquo;
                </a>
                {% endif %}
                
                {% if page > 3 %}
                <a class="page-item" href="{{ url_for('viewer_conversations', page=1, search=search, sort_by=sort_by, sort_order=sort_order) }}" aria-label="ç¬¬1é¡µ">1</a>
                
                {% if page > 4 %}
                <span class="page-ellipsis" aria-hidden="true">...</span>
                {% endif %}
                {% endif %}
                
                {% for p in range(max(1, page-2), min(total_pages+1, page+3)) %}
                <a class="page-item {% if p == page %}active{% endif %}" 
                   href="{{ url_for('viewer_conversations', page=p, search=search, sort_by=sort_by, sort_order=sort_order) }}"
                   aria-label="ç¬¬{{ p }}é¡µ" 
                   {% if p == page %}aria-current="page"{% endif %}>
                    {{ p }}
                </a>
                {% endfor %}
                
                {% if page < total_pages - 2 %}
                {% if page < total_pages - 3 %}
                <span class="page-ellipsis" aria-hidden="true">...</span>
                {% endif %}
                
                <a class="page-item" href="{{ url_for('viewer_conversations', page=total_pages, search=search, sort_by=sort_by, sort_order=sort_order) }}" aria-label="ç¬¬{{ total_pages }}é¡µ">{{ total_pages }}</a>
                {% endif %}
                
                {% if page < total_pages %}
                <a class="page-item page-next" href="{{ url_for('viewer_conversations', page=page+1, search=search, sort_by=sort_by, sort_order=sort_order) }}" aria-label="ä¸‹ä¸€é¡µ">
                    &raquo;
                </a>
                {% endif %}
            </div>
            
            <div class="page-info">
                ç¬¬ {{ page }} é¡µï¼Œå…± {{ total_pages }} é¡µ
            </div>
        </div>
        {% endif %}
        
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ’¬</div>
            <h5 class="empty-title">æš‚æ— å¯¹è¯è®°å½•</h5>
            {% if search %}
            <p class="empty-text">æ²¡æœ‰æ‰¾åˆ°åŒ¹é… "<span class="search-term">{{ search }}</span>" çš„å¯¹è¯</p>
            <a href="{{ url_for('viewer_conversations') }}" class="empty-btn">
                <span class="empty-btn-icon">ğŸ”„</span> æ¸…é™¤æœç´¢
            </a>
            {% else %}
            <p class="empty-text">ç³»ç»Ÿä¸­è¿˜æ²¡æœ‰ä»»ä½•å¯¹è¯è®°å½•</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>


</div>

<script>
    // æ’åºèœå•åˆ‡æ¢å‡½æ•° - å°†ä½¿ç”¨sorting.jsä¸­çš„å¢å¼ºç‰ˆæœ¬
    function toggleSortMenu() {
        const menu = document.getElementById('sortMenu');
        const button = document.getElementById('sortDropdown');
        const isExpanded = menu.classList.toggle('show');
        button.setAttribute('aria-expanded', isExpanded);
        
        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
        if(isExpanded) {
            menu.classList.add('animate-dropdown');
        }
    }
</script>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/conversation.js') }}"></script>
<script src="{{ url_for('static', filename='js/search.js') }}"></script>
<script src="{{ url_for('static', filename='js/sorting.js') }}"></script>
{% endblock %}