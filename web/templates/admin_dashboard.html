{% extends "admin_base.html" %}

{% block title %}ä»ªè¡¨ç›˜ - CyberWaifu Bot ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block page_title %}ä»ªè¡¨ç›˜{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">ä»ªè¡¨ç›˜</li>
{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <!-- æ•°æ®æ¦‚è§ˆ -->
    <div class="stats-container">
        <div class="stat-card stat-card-users">
            <div class="stat-content">
                <h3 class="stat-title"><span class="stat-title-icon">ğŸ‘¥</span> æ€»ç”¨æˆ·æ•°</h3>
                <div class="stat-value">{{ stats.total_users }}</div>
                <div class="stat-desc">ç³»ç»Ÿä¸­æ³¨å†Œçš„ç”¨æˆ·æ€»æ•°</div>
            </div>
            <div class="stat-bg-icon">ğŸ‘¥</div>
        </div>
        
        <div class="stat-card stat-card-conversations">
            <div class="stat-content">
                <h3 class="stat-title"><span class="stat-title-icon">ğŸ’¬</span> æ€»å¯¹è¯æ•°</h3>
                <div class="stat-value">{{ stats.total_conversations }}</div>
                <div class="stat-desc">æ‰€æœ‰ç”¨æˆ·çš„å¯¹è¯æ€»æ•°</div>
            </div>
            <div class="stat-bg-icon">ğŸ’¬</div>
        </div>
        
        <div class="stat-card stat-card-messages">
            <div class="stat-content">
                <h3 class="stat-title"><span class="stat-title-icon">ğŸ‘ª</span> æ€»ç¾¤ç»„æ•°</h3>
                <div class="stat-value">{{ stats.total_groups }}</div>
                <div class="stat-desc">ç³»ç»Ÿä¸­çš„ç¾¤ç»„æ€»æ•°</div>
            </div>
            <div class="stat-bg-icon">ğŸ‘ª</div>
        </div>
        
        <div class="stat-card stat-card-today">
            <div class="stat-content">
                <h3 class="stat-title"><span class="stat-title-icon">ğŸ”„</span> æ´»è·ƒç”¨æˆ·</h3>
                <div class="stat-value">{{ stats.active_users }}</div>
                <div class="stat-desc">æœ€è¿‘æ´»è·ƒçš„ç”¨æˆ·æ•°é‡</div>
            </div>
            <div class="stat-bg-icon">ğŸ”„</div>
        </div>
    </div>

    <!-- æœ€è¿‘æ´»åŠ¨åŒºåŸŸ -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <span class="card-header-icon">ğŸ“Š</span>
                    <h2 class="card-header-title">æœ€è¿‘å¯¹è¯</h2>
                </div>
                <div class="card-header-actions">
                    <button class="btn btn-sm btn-outline refresh-data" aria-label="åˆ·æ–°æ•°æ®">
                        <span class="btn-icon">ğŸ”„</span> åˆ·æ–°
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if recent_conversations %}
            <div class="table-container">
                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="id">ID</th>
                            <th class="sortable" data-sort="user">ç”¨æˆ·</th>
                            <th class="sortable" data-sort="character">è§’è‰²</th>
                            <th class="sortable" data-sort="turns">è½®æ¬¡</th>
                            <th class="sortable" data-sort="time">æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for conv in recent_conversations %}
                        <tr class="table-row-interactive">
                            <td>{{ conv.conv_id }}</td>
                            <td>{{ conv.user_name }}</td>
                            <td>{{ conv.character }}</td>
                            <td>{{ conv.turns }}</td>
                            <td>{{ conv.update_at|format_datetime }}</td>
                            <td>
                                <a href="{{ url_for('dialogs', conv_id=conv.conv_id) }}" class="btn btn-sm btn-primary">æŸ¥çœ‹</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">ğŸ’¬</div>
                <p class="empty-title">æš‚æ— æœ€è¿‘å¯¹è¯</p>
                <p class="empty-desc">å¯¹è¯è®°å½•å°†åœ¨æœ‰æ–°æ¶ˆæ¯æ—¶æ˜¾ç¤º</p>
            </div>
            {% endif %}
        </div>
        <div class="card-footer">
            <a href="{{ url_for('conversations') }}" class="btn btn-link">æŸ¥çœ‹å…¨éƒ¨å¯¹è¯</a>
        </div>
    </div>

    <!-- æ´»è·ƒç”¨æˆ· -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <span class="card-header-icon">ğŸ†</span>
                    <h2 class="card-header-title">æ´»è·ƒç”¨æˆ·</h2>
                </div>
                <div class="card-header-actions">
                    <button class="btn btn-sm btn-outline refresh-data" aria-label="åˆ·æ–°æ•°æ®">
                        <span class="btn-icon">ğŸ”„</span> åˆ·æ–°
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if active_users %}
            <ul class="user-list">
                {% for user in active_users %}
                <li class="user-list-item">
                    <div class="user-avatar">{{ user.first_name[0] | upper }}</div>
                    <div class="user-info">
                        <div class="user-name">{{ user.first_name }}</div>
                        <div class="user-meta">{{ user.conversation_count }} ä¸ªå¯¹è¯</div>
                    </div>
                    <div class="user-action">
                        <a href="{{ url_for('user_detail', user_id=user.user_id) }}" class="btn btn-sm btn-outline">è¯¦æƒ…</a>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">ğŸ‘¤</div>
                <p class="empty-title">æš‚æ— æ´»è·ƒç”¨æˆ·</p>
                <p class="empty-desc">ç”¨æˆ·æ´»åŠ¨æ•°æ®å°†åœ¨æœ‰æ–°æ¶ˆæ¯æ—¶æ˜¾ç¤º</p>
            </div>
            {% endif %}
        </div>
        <div class="card-footer">
            <a href="{{ url_for('users') }}" class="btn btn-link">æŸ¥çœ‹å…¨éƒ¨ç”¨æˆ·</a>
        </div>
    </div>

    <!-- ç³»ç»ŸçŠ¶æ€åŒºåŸŸ -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex align-items-center">
                <span class="card-header-icon">âš™ï¸</span>
                <h2 class="card-header-title">ç³»ç»ŸçŠ¶æ€</h2>
            </div>
        </div>
        <div class="card-body">
            <div class="grid-container">
                <div class="grid-row">
                    <div class="grid-col-12 grid-col-md-6">
                        <div class="progress-container">
                            <div class="progress-label">CPU ä½¿ç”¨ç‡</div>
                            <div class="progress">
                                <div class="progress-bar" style="width: {{ system_stats.cpu_usage }}%">
                                    {{ system_stats.cpu_usage }}%
                                </div>
                            </div>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-label">å†…å­˜ä½¿ç”¨ç‡</div>
                            <div class="progress">
                                <div class="progress-bar" style="width: {{ system_stats.memory_usage }}%">
                                    {{ system_stats.memory_usage }}%
                                </div>
                            </div>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-label">ç£ç›˜ä½¿ç”¨ç‡</div>
                            <div class="progress">
                                <div class="progress-bar" style="width: {{ system_stats.disk_usage }}%">
                                    {{ system_stats.disk_usage }}%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid-col-12 grid-col-md-6">
                        <div class="info-list">
                            <div class="info-item">
                                <div class="info-label">ç³»ç»Ÿç‰ˆæœ¬</div>
                                <div class="info-value">{{ system_stats.version }}</div>
                            </div>
                            
                            <div class="info-item">
                                <div class="info-label">è¿è¡Œæ—¶é—´</div>
                                <div class="info-value">{{ system_stats.uptime }}</div>
                            </div>
                            
                            <div class="info-item">
                                <div class="info-label">æ•°æ®åº“å¤§å°</div>
                                <div class="info-value">{{ system_stats.db_size }}</div>
                            </div>
                            
                            <div class="info-item">
                                <div class="info-label">æœ€åæ›´æ–°</div>
                                <div class="info-value">{{ system_stats.last_update }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¿«é€Ÿæ“ä½œ -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex align-items-center">
                <span class="card-header-icon">âš¡</span>
                <h2 class="card-header-title">å¿«é€Ÿæ“ä½œ</h2>
            </div>
        </div>
        <div class="card-body">
            <div class="quick-actions">
                <div class="action-card action-card-primary">
                    <div class="action-icon">ğŸ‘¥</div>
                    <h3 class="action-title">ç”¨æˆ·ç®¡ç†</h3>
                    <p class="action-desc">ç®¡ç†æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯ï¼ŒæŸ¥çœ‹è¯¦ç»†èµ„æ–™å’Œå¯¹è¯å†å²</p>
                    <a href="{{ url_for('users') }}" class="btn btn-primary btn-with-icon">
                        <span class="btn-icon">ğŸ‘ï¸</span> ç®¡ç†ç”¨æˆ·
                    </a>
                </div>
                
                <div class="action-card action-card-success">
                    <div class="action-icon">ğŸ’¬</div>
                    <h3 class="action-title">å¯¹è¯ç®¡ç†</h3>
                    <p class="action-desc">æŸ¥çœ‹æ‰€æœ‰å¯¹è¯å†å²ï¼Œæœç´¢å’Œç­›é€‰æ¶ˆæ¯å†…å®¹</p>
                    <a href="{{ url_for('conversations') }}" class="btn btn-primary btn-with-icon">
                        <span class="btn-icon">ğŸ“œ</span> ç®¡ç†å¯¹è¯
                    </a>
                </div>
                
                <div class="action-card action-card-warning">
                    <div class="action-icon">âš™ï¸</div>
                    <h3 class="action-title">ç³»ç»Ÿé…ç½®</h3>
                    <p class="action-desc">ç®¡ç†ç³»ç»Ÿé…ç½®å’Œå‚æ•°è®¾ç½®</p>
                    <a href="{{ url_for('config_management') }}" class="btn btn-primary btn-with-icon">
                        <span class="btn-icon">ğŸ”§</span> é…ç½®ç³»ç»Ÿ
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // åˆå§‹åŒ–æ•°å­—åŠ¨ç”»
        setTimeout(() => {
            animateNumbers('.stat-value', 1500, true);
        }, 300);
        
        // æ·»åŠ éª¨æ¶å±åŠ è½½æ•ˆæœ
        addSkeletonLoading('.stat-card');
        
        // åˆå§‹åŒ–åˆ·æ–°æŒ‰é’®
        const refreshButtons = document.querySelectorAll('.refresh-data');
        refreshButtons.forEach(button => {
            button.addEventListener('click', function() {
                // æ¨¡æ‹Ÿæ•°æ®åˆ·æ–°
                button.classList.add('loading');
                button.disabled = true;
                
                // æ·»åŠ éª¨æ¶å±æ•ˆæœ
                addSkeletonLoading('.stat-card');
                
                // æ¨¡æ‹Ÿå»¶è¿Ÿåæ¢å¤
                setTimeout(() => {
                    button.classList.remove('loading');
                    button.disabled = false;
                    
                    // é‡æ–°è§¦å‘æ•°å­—åŠ¨ç”»
                    setTimeout(() => {
                        animateNumbers('.stat-value', 1500, true);
                    }, 500);
                }, 1500);
            });
        });
    });
</script>
{% endblock %}