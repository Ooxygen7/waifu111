{% extends "base.html" %}

{% block title %}全局搜索 - CyberWaifu Bot 后台管理系统{% endblock %}

{% block page_title %}全局搜索{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_glass.css') }}">
<style>
    .search-placeholder-wrapper {
        display: flex;
        justify-content: center;
        align-items: flex-start; /* Align to top */
        text-align: center;
        padding-top: 10vh; /* Use viewport height for padding */
        min-height: 60vh;
        color: #a9b1d6;
    }
    .search-placeholder {
        max-width: 600px;
    }
    .placeholder-icon {
        margin-bottom: 24px;
    }
    .placeholder-icon svg {
        width: 64px;
        height: 64px;
        color: #414868;
    }
    .placeholder-title {
        font-size: 2rem;
        font-weight: 500;
        color: #c0caf5;
        margin-bottom: 12px;
    }
    .placeholder-subtitle {
        font-size: 1rem;
        color: #7aa2f7;
        margin-bottom: 60px;
    }
    .placeholder-categories {
        display: flex;
        justify-content: center;
        gap: 50px;
        flex-wrap: wrap;
        padding-top: 30px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .category-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
    }
    .category-icon {
        font-size: 1.75rem;
        color: #7aa2f7;
    }
    .category-text {
        font-size: 0.9rem;
        color: #a9b1d6;
    }
    .collapsible-text .text-preview {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%; /* Ensure it doesn't overflow its container */
    }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper users-page">
    <!-- 搜索表单和结果统计 -->
    <div class="card card-glass">
        <div class="card-header">
            <div class="header-container">
                <div class="header-title">
                    <div class="header-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>
                    <div class="header-text">
                        <h3>全局搜索</h3>
                        <p class="header-subtitle">在所有数据中查找信息</p>
                    </div>
                </div>
                <div class="search-container">
                    <form method="GET" action="{{ url_for('admin.search') }}" class="search-form">
                        <div class="search-input-wrapper">
                            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <input type="text" name="q" class="search-input" placeholder="搜索用户、群组、对话..." value="{{ query or '' }}" aria-label="搜索" id="searchQuery" required>
                            <div class="search-loading" style="display: none;"></div>
                            {% if query %}
                            <a href="{{ url_for('admin.search') }}" class="clear-button" aria-label="清除搜索">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </a>
                            {% endif %}
                        </div>
                        <button type="submit" class="btn-glass" aria-label="搜索">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-button-icon"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            <span>搜索</span>
                        </button>
                    </form>
                    {% if query and results %}
                    {% set total_count = (results.dialogs|length) + (results.users|length) + (results.groups|length) + (results.conversations|length) %}
                    <div class="search-status">
                        <span>为 "<strong>{{ query }}</strong>" 找到 {{ total_count }} 个结果</span>
                        <a href="{{ url_for('admin.search') }}" class="clear-search-link">清除搜索</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 搜索结果 -->
    {% if query %}
        {% set total_results = (results.dialogs|length) + (results.users|length) + (results.groups|length) + (results.conversations|length) %}
        


        {% if total_results > 0 %}
            <!-- 私聊对话消息结果 -->
            {% if results.dialogs and results.dialogs|selectattr('type', 'equalto', 'private')|list %}
            {% set private_dialogs = results.dialogs|selectattr('type', 'equalto', 'private')|list %}
            {% set is_private_collapsed = private_dialogs|length > 20 %}
            <div class="card card-glass mb-4 collapsible-card">
                <div class="card-header" aria-expanded="{{ 'false' if is_private_collapsed else 'true' }}" aria-controls="privateDialogsCollapse" style="cursor: pointer;">
                    <div class="header-container">
                        <div class="header-title">
                            <div class="header-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>
                            <div class="header-text">
                                <h3>私聊对话消息</h3>
                                <span >{{ private_dialogs|length }}</span>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button class="btn-glass btn-icon btn-sm collapse-toggle" aria-label="折叠/展开">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse {{ 'show' if not is_private_collapsed else '' }}" id="privateDialogsCollapse">
                    <div class="card-body">
                        <div class="table-container">
                            <div class="table-scroll-wrapper">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%;">对话信息</th>
                                            <th style="width: 15%;">用户</th>
                                            <th style="width: 45%;">内容</th>
                                            <th style="width: 10%;">时间</th>
                                            <th style="width: 15%;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for dialog in private_dialogs %}
                                        <tr class="table-row-interactive">
                                            <td>
                                                <div class="stacked-info">
                                                    <div class="info-primary">{{ dialog.conv_id }}</div>
                                                    <div class="info-secondary">
                                                        {% if dialog.role == 'user' %}
                                                            <i class="fas fa-user"></i> 用户
                                                        {% else %}
                                                            <i class="fas fa-robot"></i> AI
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="user-info">
                                                    <div class="user-avatar">
                                                        <div class="avatar-image">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                                        </div>
                                                    </div>
                                                    <div class="user-details">
                                                        <div class="user-name">{{ (dialog.first_name or '') ~ ' ' ~ (dialog.last_name or '') }}</div>
                                                        <div class="user-id">@{{ dialog.user_name or dialog.user_id }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td style="white-space: normal; word-break: break-all;">
                                                {% set processed_content = (dialog.processed_content or dialog.raw_content or '')|string %}
                                                {% if processed_content|length > 50 %}
                                                    <div class="collapsible-text">
                                                        <div class="text-preview">{{ (processed_content[:50] + '...')|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                        <div class="text-full" style="display: none;">{{ processed_content|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                        <button class="btn-glass btn-text btn-sm toggle-text">展开</button>
                                                    </div>
                                                {% else %}
                                                    {{ processed_content|replace(query, '<mark>' + query + '</mark>')|safe }}
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="time-split">
                                                    <div class="time-date">{{ format_datetime(dialog.created_at).split(' ')[0] }}</div>
                                                    <div class="time-clock">{{ format_datetime(dialog.created_at).split(' ')[1].split('.')[0] }}</div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <a href="{{ url_for('admin.dialogs', conv_id=dialog.conv_id) }}#msg-{{ dialog.id }}" class="btn-glass btn-icon btn-sm" title="查看完整对话"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></a>
                                                    <button class="btn-glass btn-icon btn-sm" onclick="copyForwardCommand('{{ dialog.user_id }}', '{{ dialog.msg_id }}')" title="复制转发指令"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- 群聊消息结果 -->
            {% if results.dialogs and results.dialogs|selectattr('type', 'equalto', 'group')|list %}
            {% set group_dialogs = results.dialogs|selectattr('type', 'equalto', 'group')|list %}
            {% set is_group_collapsed = group_dialogs|length > 20 %}
            <div class="card card-glass mb-4 collapsible-card">
                <div class="card-header" aria-expanded="{{ 'false' if is_group_collapsed else 'true' }}" aria-controls="groupMessagesCollapse" style="cursor: pointer;">
                    <div class="header-container">
                        <div class="header-title">
                            <div class="header-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></div>
                            <div class="header-text">
                                <h3>群聊消息</h3>
                                <span >{{ group_dialogs|length }}</span>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button class="btn-glass btn-icon btn-sm collapse-toggle" aria-label="折叠/展开">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse {{ 'show' if not is_group_collapsed else '' }}" id="groupMessagesCollapse">
                    <div class="card-body">
                        <div class="table-container">
                            <div class="table-scroll-wrapper">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%;">群组/用户</th>
                                            <th style="width: 55%;">消息内容</th>
                                            <th style="width: 10%;">时间</th>
                                            <th style="width: 10%;">消息ID</th>
                                            <th style="width: 10%;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for dialog in group_dialogs %}
                                        <tr class="table-row-interactive">
                                            <td>
                                                <div class="stacked-info">
                                                    <div class="info-primary">{{ dialog.group_name or '-' }}</div>
                                                    <div class="info-secondary">{{ dialog.msg_user_name or '-' }}</div>
                                                </div>
                                            </td>
                                            <td style="white-space: normal; word-break: break-all;">
                                                {% set msg_text = (dialog.msg_text or '')|string %}
                                                {% set processed_response = (dialog.processed_response or dialog.raw_response or '')|string %}
                                                <div class="collapsible-text">
                                                    <div class="text-preview">
                                                        {{ (msg_text + ' -> ' + processed_response)[:80]|replace(query, '<mark>' + query + '</mark>')|safe }}
                                                        {% if (msg_text + processed_response)|length > 80 %}...{% endif %}
                                                    </div>
                                                    <div class="text-full" style="display: none;">
                                                        <strong>消息:</strong> {{ msg_text|replace(query, '<mark>' + query + '</mark>')|safe }}<br>
                                                        <strong>响应:</strong> {{ processed_response|replace(query, '<mark>' + query + '</mark>')|safe }}
                                                    </div>
                                                    {% if (msg_text + processed_response)|length > 80 %}
                                                        <button class="btn-glass btn-text btn-sm toggle-text">展开</button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <div class="time-split">
                                                    <div class="time-date">{{ format_datetime(dialog.create_at).split(' ')[0] }}</div>
                                                    <div class="time-clock">{{ format_datetime(dialog.create_at).split(' ')[1].split('.')[0] }}</div>
                                                </div>
                                            </td>
                                            <td><span >{{ dialog.msg_id or '-' }}</span></td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="btn-glass btn-icon btn-sm" onclick="jumpToGroupMessage('{{ dialog.group_id }}', '{{ dialog.msg_id }}')" title="查看群聊记录"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></button>
                                                    <button class="btn-glass btn-icon btn-sm" onclick="copyForwardCommand('{{ dialog.group_id }}', '{{ dialog.msg_id }}')" title="复制转发指令"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- 用户信息结果 -->
            {% if results.users %}
            <div class="card card-glass mb-4 collapsible-card">
                <div class="card-header" aria-expanded="true" aria-controls="userInfoCollapse" style="cursor: pointer;">
                    <div class="header-container">
                        <div class="header-title">
                            <div class="header-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></div>
                            <div class="header-text">
                                <h3>用户信息</h3>
                                <span >{{ results.users|length }}</span>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button class="btn-glass btn-icon btn-sm collapse-toggle" aria-label="折叠/展开">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="userInfoCollapse">
                    <div class="card-body">
                        <div class="table-container">
                            <div class="table-scroll-wrapper">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>用户ID</th>
                                            <th>用户名</th>
                                            <th>姓名</th>
                                            <th>对话数</th>
                                            <th>消息轮次</th>
                                            <th>注册时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user in results.users %}
                                        <tr class="table-row-interactive">
                                            <td><span >{{ user.uid }}</span></td>
                                            <td>
                                                <div class="user-info">
                                                    <div class="user-avatar">
                                                        <div class="avatar-image">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                                        </div>
                                                    </div>
                                                    <div class="user-details">
                                                        <span class="user-name">{{ (user.user_name or '未设置')|replace(query, '<mark>' + query + '</mark>')|safe }}</span>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{{ ((user.first_name or '') + ' ' + (user.last_name or ''))|replace(query, '<mark>' + query + '</mark>')|safe }}</td>
                                            <td><span class="data-value">{{ user.conversations or 0 }}</span></td>
                                            <td><span class="data-value">{{ user.dialog_turns or 0 }}</span></td>
                                            <td>
                                                <div class="time-split">
                                                    <div class="time-date">{{ format_datetime(user.create_at).split(' ')[0] }}</div>
                                                    <div class="time-clock">{{ format_datetime(user.create_at).split(' ')[1].split('.')[0] }}</div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <a href="{{ url_for('admin.conversations', search=user.uid) }}" class="btn-glass btn-icon btn-sm" title="查看对话"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></a>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- 群组信息结果 -->
            {% if results.groups %}
            <div class="card card-glass mb-4 collapsible-card">
                <div class="card-header" aria-expanded="true" aria-controls="groupInfoCollapse" style="cursor: pointer;">
                    <div class="header-container">
                        <div class="header-title">
                            <div class="header-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></div>
                            <div class="header-text">
                                <h3>群组信息</h3>
                                <span >{{ results.groups|length }}</span>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button class="btn-glass btn-icon btn-sm collapse-toggle" aria-label="折叠/展开">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="groupInfoCollapse">
                    <div class="card-body">
                        <div class="table-container">
                            <div class="table-scroll-wrapper">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>群组ID</th>
                                            <th>群组名称</th>
                                            <th>对话数</th>
                                            <th>调用次数</th>
                                            <th>角色</th>
                                            <th>状态</th>
                                            <th>更新时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for group in results.groups %}
                                        <tr class="table-row-interactive">
                                            <td><span >{{ group.group_id }}</span></td>
                                            <td>
                                                <div class="user-info">
                                                    <div class="user-avatar">
                                                        <div class="avatar-image">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                                                        </div>
                                                    </div>
                                                    <div class="user-details">
                                                        <span class="user-name">{{ (group.group_name or '未命名群组')|replace(query, '<mark>' + query + '</mark>')|safe }}</span>
                                                    </div>
                                                </div>
                                            </td>
                                            <td><span class="data-value">{{ group.dialog_count or 0 }}</span></td>
                                            <td><span class="data-value">{{ group.call_count or 0 }}</span></td>
                                            <td><span >{{ group.char or '未设置' }}</span></td>
                                            <td>
                                                {% if group.active %}
                                                    <span >活跃</span>
                                                {% else %}
                                                    <span >非活跃</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="time-split">
                                                    <div class="time-date">{{ format_datetime(group.update_time).split(' ')[0] }}</div>
                                                    <div class="time-clock">{{ format_datetime(group.update_time).split(' ')[1].split('.')[0] }}</div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <a href="{{ url_for('admin.group_dialogs', group_id=group.group_id) }}" class="btn-glass btn-icon btn-sm" title="查看群组对话"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></a>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- 对话记录结果 -->
            {% if results.conversations %}
            <div class="card card-glass mb-4 collapsible-card">
                <div class="card-header" aria-expanded="true" aria-controls="conversationsCollapse" style="cursor: pointer;">
                    <div class="header-container">
                        <div class="header-title">
                            <div class="header-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div>
                            <div class="header-text">
                                <h3>对话记录</h3>
                                <span >{{ results.conversations|length }}</span>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button class="btn-glass btn-icon btn-sm collapse-toggle" aria-label="折叠/展开">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="conversationsCollapse">
                    <div class="card-body">
                        <div class="table-container">
                            <div class="table-scroll-wrapper">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%;">用户</th>
                                            <th style="width: 15%;">对话信息</th>
                                            <th style="width: 5%;">轮数</th>
                                            <th style="width: 50%;">摘要</th>
                                            <th style="width: 15%;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for conv in results.conversations %}
                                        <tr class="table-row-interactive">
                                            <td>
                                                <div class="user-info">
                                                    <div class="user-avatar">
                                                        <div class="avatar-image">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                                        </div>
                                                    </div>
                                                    <div class="user-details">
                                                        <div class="user-name">{{ (conv.user_name or '未设置')|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                        <div class="user-id">{{ conv.user_id }}</div>
                                                        {% if conv.first_name or conv.last_name %}
                                                            <div class="user-real-name">{{ ((conv.first_name or '') + ' ' + (conv.last_name or ''))|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="stacked-info">
                                                    <div class="info-primary">{{ conv.conv_id }}</div>
                                                    <div class="info-secondary">{{ (conv.character or '未设置')|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                    <div class="info-tertiary">{{ (conv.preset or '默认')|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                </div>
                                            </td>
                                            <td><span class="data-value">{{ conv.turns or 0 }}</span></td>
                                            <td style="white-space: normal; word-break: break-all;" class="summary-cell">
                                               {% if conv.summary %}
                                                   <div class="collapsible-text">
                                                       <div class="text-preview">{{ (conv.summary[:50] + '...')|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                       <div class="text-full" style="display: none;">{{ conv.summary|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                       <button class="btn-glass btn-text btn-sm toggle-text">展开</button>
                                                   </div>
                                               {% else %}
                                                   <div class="summary-placeholder-modern">
                                                       <i class="fas fa-info-circle"></i>
                                                       <span>[无摘要]</span>
                                                   </div>
                                               {% endif %}
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <a href="{{ url_for('admin.dialogs', conv_id=conv.conv_id) }}" class="btn-glass btn-icon btn-sm" title="查看对话详情"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></a>
                                                    <button type="button" class="btn-glass btn-icon btn-sm generate-summary-btn" data-conv-id="{{ conv.conv_id }}" title="生成摘要"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L14.39 8.36L21 9.27L16.5 13.5L17.61 20.02L12 17.27L6.39 20.02L7.5 13.5L3 9.27L9.61 8.36L12 2z"></path></svg></button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        {% else %}
            <!-- 无搜索结果 -->
            <div class="card glass-card empty-state-card">
                <div class="card-body">
                    <div class="empty-state-content">
                        <div class="empty-state-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        </div>
                        <h3 class="empty-state-title">未找到相关结果</h3>
                        <p class="empty-state-text">请尝试使用其他关键词进行搜索</p>
                    </div>
                </div>
            </div>
        {% endif %}
    {% else %}
        <!-- NEW: Initial Search Page Placeholder -->
        <div class="search-placeholder-wrapper">
            <div class="search-placeholder">
                <div class="placeholder-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
                <h2 class="placeholder-title">全局搜索</h2>
                <p class="placeholder-subtitle">输入关键词可搜索用户、群组、对话及消息内容</p>
                
                <div class="placeholder-categories">
                    <div class="category-item">
                        <span class="category-icon"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></span>
                        <span class="category-text">私聊消息</span>
                    </div>
                    <div class="category-item">
                        <span class="category-icon"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></span>
                        <span class="category-text">群组消息</span>
                    </div>
                    <div class="category-item">
                        <span class="category-icon"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg></span>
                        <span class="category-text">用户信息</span>
                    </div>
                    <div class="category-item">
                        <span class="category-icon"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></span>
                        <span class="category-text">对话记录</span>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/search.js') }}"></script>
<script>
// 自动聚焦搜索框
$(document).ready(function() {
    // 自动聚焦搜索框
    const searchInput = $('#searchQuery');
    if (searchInput.length > 0 && !searchInput.val()) {
        searchInput.focus();
    }

    // 自定义卡片折叠功能
    $('.collapsible-card .card-header').on('click', function(e) {
        // 如果点击的是按钮或链接，则不触发折叠
        if ($(e.target).is('button, a, .btn-glass') || $(e.target).closest('button, a, .btn-glass').length) {
            return;
        }

        const card = $(this).closest('.collapsible-card');
        const body = card.find('.collapse');
        const icon = $(this).find('.collapse-icon');

        // 使用 slideToggle 实现平滑的展开/收起
        body.slideToggle(300, function() {
            // 切换图标的旋转状态
            if (body.is(':visible')) {
                icon.css('transform', 'rotate(0deg)');
                card.addClass('is-expanded');
            } else {
                icon.css('transform', 'rotate(-90deg)');
                card.removeClass('is-expanded');
            }
        });
    });

    // 为折叠按钮添加独立的点击事件
    $('.collapse-toggle').on('click', function(e) {
        e.stopPropagation(); // 阻止事件冒泡到 card-header
        
        const card = $(this).closest('.collapsible-card');
        const body = card.find('.collapse');
        const icon = $(this).find('.collapse-icon');

        body.slideToggle(300, function() {
            if (body.is(':visible')) {
                icon.css('transform', 'rotate(0deg)');
                card.addClass('is-expanded');
            } else {
                icon.css('transform', 'rotate(-90deg)');
                card.removeClass('is-expanded');
            }
        });
    });

    // 初始时，为所有卡片设置正确的图标状态
    $('.collapsible-card').each(function() {
        const card = $(this);
        const body = card.find('.collapse');
        const icon = card.find('.collapse-icon');
        if (body.hasClass('show')) {
            icon.css('transform', 'rotate(0deg)');
            card.addClass('is-expanded');
        } else {
            icon.css('transform', 'rotate(-90deg)');
            card.removeClass('is-expanded');
        }
    });

    // 使用jQuery重写文本展开/收起功能
    $('.data-table').on('click', '.toggle-text', function() {
        const button = $(this);
        const container = button.closest('.collapsible-text');
        const preview = container.find('.text-preview');
        const full = container.find('.text-full');

        if (full.is(':hidden')) {
            preview.hide();
            full.slideDown(300); // Use slideDown for smooth animation
            button.text('收起').addClass('expanded');
        } else {
            full.slideUp(300, function() { // Use slideUp for smooth animation
                preview.show();
            });
            button.text('展开').removeClass('expanded');
        }
    });

    // 生成摘要按钮点击事件
    $(document).on('click', '.generate-summary-btn', function () {
        const convId = $(this).data('conv-id');
        const button = $(this);

        if (button.hasClass('loading')) {
            return;
        }

        const originalIcon = button.html();
        button.prop('disabled', true).addClass('loading').html('<span class="btn-text">...</span>');

        $.ajax({
            url: '/api/generate_summary',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ conversation_id: convId }),
            success: function (response) {
                if (response.success) {
                    const summaryCell = button.closest('tr').find('.summary-cell');
                    const summary = response.summary || '';
                    const query = $('#searchQuery').val();
                    
                    // Function to safely highlight text
                    function highlight(text, term) {
                        if (!term) return text;
                        const regex = new RegExp(term.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi');
                        return text.replace(regex, '<mark>$&</mark>');
                    }

                    const highlightedSummary = highlight(summary, query);
                    const previewText = summary.length > 50 ? highlight(summary.substring(0, 50) + '...', query) : highlightedSummary;

                    const newSummaryHtml = `
                        <div class="collapsible-text">
                            <div class="text-preview">${previewText}</div>
                            <div class="text-full" style="display: none;">${highlightedSummary}</div>
                            <button class="btn-glass btn-text btn-sm toggle-text">展开</button>
                        </div>
                    `;
                    summaryCell.html(newSummaryHtml);

                    if (window.showToast) {
                        showToast('摘要生成成功！', 'success');
                    }
                } else {
                    if (window.showToast) {
                        showToast('摘要生成失败：' + (response.message || '未知错误'), 'error');
                    }
                }
            },
            error: function (xhr, status, error) {
                console.error('生成摘要请求失败:', error);
                if (window.showToast) {
                    showToast('请求失败，请稍后重试', 'error');
                }
            },
            complete: function () {
                button.prop('disabled', false).removeClass('loading').html(originalIcon);
            }
        });
    });
});

// 复制转发指令功能
function copyForwardCommand(targetId, msgId) {
    const command = `/fw ${targetId} ${msgId}`;
    
    // 使用现代的 Clipboard API
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(command).then(function() {
            showToast('转发指令已复制到剪贴板: ' + command, 'success');
        }).catch(function(err) {
            console.error('复制失败:', err);
            fallbackCopyTextToClipboard(command);
        });
    } else {
        // 降级方案
        fallbackCopyTextToClipboard(command);
    }
}

// 降级复制方案
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showToast('转发指令已复制到剪贴板: ' + text, 'success');
        } else {
            showToast('复制失败，请手动复制: ' + text, 'error');
        }
    } catch (err) {
        console.error('复制失败:', err);
        showToast('复制失败，请手动复制: ' + text, 'error');
    }
    
    document.body.removeChild(textArea);
}

// 显示提示消息
function showToast(message, type = 'info') {
    // 创建提示元素
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; opacity: 0; transition: opacity 0.3s;';
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // 显示动画
    setTimeout(() => {
        toast.style.opacity = '1';
    }, 10);
    
    // 自动隐藏
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
            if (toast.parentNode) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// 跳转到群聊消息（获取正确的页码）
function jumpToGroupMessage(groupId, msgId) {
    console.log('jumpToGroupMessage called with:', groupId, msgId);
    
    // 调用API获取消息所在的页码
    fetch(`/api/message_page/${groupId}/${msgId}`)
        .then(response => {
            console.log('API response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('API response data:', data);
            if (data.error) {
                console.error('获取消息页码失败:', data.error);
                // 如果API失败，回退到原来的方法
                const targetUrl = `{{ url_for('admin.group_dialogs', group_id='') }}${groupId}#msg-${msgId}`;
                console.log('Fallback URL:', targetUrl);
                window.location.href = targetUrl;
            } else {
                // 跳转到正确的页面，并在URL中添加目标消息ID
                const targetUrl = `{{ url_for('admin.group_dialogs', group_id='') }}${groupId}?page=${data.page}#msg-${msgId}`;
                console.log('Target URL:', targetUrl);
                window.location.href = targetUrl;
            }
        })
        .catch(error => {
            console.error('API请求失败:', error);
            // 如果请求失败，回退到原来的方法
            const targetUrl = `{{ url_for('admin.group_dialogs', group_id='') }}${groupId}#msg-${msgId}`;
            console.log('Error fallback URL:', targetUrl);
            window.location.href = targetUrl;
        });
}
</script>
{% endblock %}