{% extends "base.html" %}

{% block title %}å…¨å±€æœç´¢ - CyberWaifu Bot åå°ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block page_title %}å…¨å±€æœç´¢{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_glass.css') }}">
<style>
    .search-placeholder-wrapper {
        display: flex;
        justify-content: center;
        align-items: flex-start; /* Align to top */
        text-align: center;
        padding-top: 10vh; /* Use viewport height for padding */
        min-height: 60vh;
        color: #a9b1d6;
    }
    .search-placeholder {
        max-width: 600px;
    }
    .placeholder-icon {
        margin-bottom: 24px;
    }
    .placeholder-icon svg {
        width: 64px;
        height: 64px;
        color: #414868;
    }
    .placeholder-title {
        font-size: 2rem;
        font-weight: 500;
        color: #c0caf5;
        margin-bottom: 12px;
    }
    .placeholder-subtitle {
        font-size: 1rem;
        color: #7aa2f7;
        margin-bottom: 60px;
    }
    .placeholder-categories {
        display: flex;
        justify-content: center;
        gap: 50px;
        flex-wrap: wrap;
        padding-top: 30px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .category-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
    }
    .category-icon {
        font-size: 1.75rem;
        color: #7aa2f7;
    }
    .category-text {
        font-size: 0.9rem;
        color: #a9b1d6;
    }
    .collapsible-text .text-preview {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%; /* Ensure it doesn't overflow its container */
    }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper users-page">
    <!-- æœç´¢è¡¨å•å’Œç»“æœç»Ÿè®¡ -->
    <div class="card card-glass">
        <div class="card-header">
            <div class="header-container">
                <div class="header-title">
                    <div class="header-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>
                    <div class="header-text">
                        <h3>å…¨å±€æœç´¢</h3>
                        <p class="header-subtitle">åœ¨æ‰€æœ‰æ•°æ®ä¸­æŸ¥æ‰¾ä¿¡æ¯</p>
                    </div>
                </div>
                <div class="search-container">
                    <form method="GET" action="{{ url_for('admin.search') }}" class="search-form">
                        <div class="search-input-wrapper">
                            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            <input type="text" name="q" class="search-input" placeholder="æœç´¢ç”¨æˆ·ã€ç¾¤ç»„ã€å¯¹è¯..." value="{{ query or '' }}" aria-label="æœç´¢" id="searchQuery" required>
                            <div class="search-loading" style="display: none;"></div>
                            {% if query %}
                            <a href="{{ url_for('admin.search') }}" class="clear-button" aria-label="æ¸…é™¤æœç´¢">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </a>
                            {% endif %}
                        </div>
                        <button type="submit" class="btn-glass" aria-label="æœç´¢">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-button-icon"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            <span>æœç´¢</span>
                        </button>
                    </form>
                    {% if query and results %}
                    {% set total_count = (results.dialogs|length) + (results.users|length) + (results.groups|length) + (results.conversations|length) %}
                    <div class="search-status">
                        <span>ä¸º "<strong>{{ query }}</strong>" æ‰¾åˆ° {{ total_count }} ä¸ªç»“æœ</span>
                        <a href="{{ url_for('admin.search') }}" class="clear-search-link">æ¸…é™¤æœç´¢</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- æœç´¢ç»“æœ -->
    {% if query %}
        {% set total_results = (results.dialogs|length) + (results.users|length) + (results.groups|length) + (results.conversations|length) %}
        


        {% if total_results > 0 %}
            <!-- ç§èŠå¯¹è¯æ¶ˆæ¯ç»“æœ -->
            {% if results.dialogs and results.dialogs|selectattr('type', 'equalto', 'private')|list %}
            {% set private_dialogs = results.dialogs|selectattr('type', 'equalto', 'private')|list %}
            {% set is_private_collapsed = private_dialogs|length > 20 %}
            <div class="card card-glass mb-4 collapsible-card">
                <div class="card-header" aria-expanded="{{ 'false' if is_private_collapsed else 'true' }}" aria-controls="privateDialogsCollapse" style="cursor: pointer;">
                    <div class="header-container">
                        <div class="header-title">
                            <div class="header-icon">ğŸ‘¤</div>
                            <div class="header-text">
                                <h3>ç§èŠå¯¹è¯æ¶ˆæ¯</h3>
                                <span >{{ private_dialogs|length }}</span>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button class="btn-glass btn-icon btn-sm collapse-toggle" aria-label="æŠ˜å /å±•å¼€">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse {{ 'show' if not is_private_collapsed else '' }}" id="privateDialogsCollapse">
                    <div class="card-body">
                        <div class="table-container">
                            <div class="table-scroll-wrapper">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%;">å¯¹è¯ä¿¡æ¯</th>
                                            <th style="width: 15%;">ç”¨æˆ·</th>
                                            <th style="width: 45%;">å†…å®¹</th>
                                            <th style="width: 10%;">æ—¶é—´</th>
                                            <th style="width: 15%;">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for dialog in private_dialogs %}
                                        <tr class="table-row-interactive">
                                            <td>
                                                <div class="stacked-info">
                                                    <div class="info-primary">{{ dialog.conv_id }}</div>
                                                    <div class="info-secondary">
                                                        {% if dialog.role == 'user' %}
                                                            <i class="fas fa-user"></i> ç”¨æˆ·
                                                        {% else %}
                                                            <i class="fas fa-robot"></i> AI
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="user-info">
                                                    <div class="user-avatar">
                                                        <div class="avatar-image">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                                        </div>
                                                    </div>
                                                    <div class="user-details">
                                                        <div class="user-name">{{ (dialog.first_name or '') ~ ' ' ~ (dialog.last_name or '') }}</div>
                                                        <div class="user-id">@{{ dialog.user_name or dialog.user_id }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td style="white-space: normal; word-break: break-all;">
                                                {% set processed_content = (dialog.processed_content or dialog.raw_content or '')|string %}
                                                {% if processed_content|length > 50 %}
                                                    <div class="collapsible-text">
                                                        <div class="text-preview">{{ (processed_content[:50] + '...')|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                        <div class="text-full" style="display: none;">{{ processed_content|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                        <button class="btn-glass btn-text btn-sm toggle-text">å±•å¼€</button>
                                                    </div>
                                                {% else %}
                                                    {{ processed_content|replace(query, '<mark>' + query + '</mark>')|safe }}
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="time-split">
                                                    <div class="time-date">{{ format_datetime(dialog.created_at).split(' ')[0] }}</div>
                                                    <div class="time-clock">{{ format_datetime(dialog.created_at).split(' ')[1].split('.')[0] }}</div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <a href="{{ url_for('admin.dialogs', conv_id=dialog.conv_id) }}#msg-{{ dialog.id }}" class="btn-glass btn-icon btn-sm" title="æŸ¥çœ‹å®Œæ•´å¯¹è¯">ğŸ‘ï¸</a>
                                                    <button class="btn-glass btn-icon btn-sm" onclick="copyForwardCommand('{{ dialog.user_id }}', '{{ dialog.msg_id }}')" title="å¤åˆ¶è½¬å‘æŒ‡ä»¤">ğŸ“‹</button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- ç¾¤èŠæ¶ˆæ¯ç»“æœ -->
            {% if results.dialogs and results.dialogs|selectattr('type', 'equalto', 'group')|list %}
            {% set group_dialogs = results.dialogs|selectattr('type', 'equalto', 'group')|list %}
            {% set is_group_collapsed = group_dialogs|length > 20 %}
            <div class="card card-glass mb-4 collapsible-card">
                <div class="card-header" aria-expanded="{{ 'false' if is_group_collapsed else 'true' }}" aria-controls="groupMessagesCollapse" style="cursor: pointer;">
                    <div class="header-container">
                        <div class="header-title">
                            <div class="header-icon">ğŸ‘¥</div>
                            <div class="header-text">
                                <h3>ç¾¤èŠæ¶ˆæ¯</h3>
                                <span >{{ group_dialogs|length }}</span>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button class="btn-glass btn-icon btn-sm collapse-toggle" aria-label="æŠ˜å /å±•å¼€">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse {{ 'show' if not is_group_collapsed else '' }}" id="groupMessagesCollapse">
                    <div class="card-body">
                        <div class="table-container">
                            <div class="table-scroll-wrapper">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%;">ç¾¤ç»„/ç”¨æˆ·</th>
                                            <th style="width: 55%;">æ¶ˆæ¯å†…å®¹</th>
                                            <th style="width: 10%;">æ—¶é—´</th>
                                            <th style="width: 10%;">æ¶ˆæ¯ID</th>
                                            <th style="width: 10%;">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for dialog in group_dialogs %}
                                        <tr class="table-row-interactive">
                                            <td>
                                                <div class="stacked-info">
                                                    <div class="info-primary">{{ dialog.group_name or '-' }}</div>
                                                    <div class="info-secondary">{{ dialog.msg_user_name or '-' }}</div>
                                                </div>
                                            </td>
                                            <td style="white-space: normal; word-break: break-all;">
                                                {% set msg_text = (dialog.msg_text or '')|string %}
                                                {% set processed_response = (dialog.processed_response or dialog.raw_response or '')|string %}
                                                <div class="collapsible-text">
                                                    <div class="text-preview">
                                                        {{ (msg_text + ' -> ' + processed_response)[:80]|replace(query, '<mark>' + query + '</mark>')|safe }}
                                                        {% if (msg_text + processed_response)|length > 80 %}...{% endif %}
                                                    </div>
                                                    <div class="text-full" style="display: none;">
                                                        <strong>æ¶ˆæ¯:</strong> {{ msg_text|replace(query, '<mark>' + query + '</mark>')|safe }}<br>
                                                        <strong>å“åº”:</strong> {{ processed_response|replace(query, '<mark>' + query + '</mark>')|safe }}
                                                    </div>
                                                    {% if (msg_text + processed_response)|length > 80 %}
                                                        <button class="btn-glass btn-text btn-sm toggle-text">å±•å¼€</button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <div class="time-split">
                                                    <div class="time-date">{{ format_datetime(dialog.create_at).split(' ')[0] }}</div>
                                                    <div class="time-clock">{{ format_datetime(dialog.create_at).split(' ')[1].split('.')[0] }}</div>
                                                </div>
                                            </td>
                                            <td><span >{{ dialog.msg_id or '-' }}</span></td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="btn-glass btn-icon btn-sm" onclick="jumpToGroupMessage('{{ dialog.group_id }}', '{{ dialog.msg_id }}')" title="æŸ¥çœ‹ç¾¤èŠè®°å½•">ğŸ‘ï¸</button>
                                                    <button class="btn-glass btn-icon btn-sm" onclick="copyForwardCommand('{{ dialog.group_id }}', '{{ dialog.msg_id }}')" title="å¤åˆ¶è½¬å‘æŒ‡ä»¤">ğŸ“‹</button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- ç”¨æˆ·ä¿¡æ¯ç»“æœ -->
            {% if results.users %}
            <div class="card card-glass mb-4 collapsible-card">
                <div class="card-header" aria-expanded="true" aria-controls="userInfoCollapse" style="cursor: pointer;">
                    <div class="header-container">
                        <div class="header-title">
                            <div class="header-icon">ğŸ‘¥</div>
                            <div class="header-text">
                                <h3>ç”¨æˆ·ä¿¡æ¯</h3>
                                <span >{{ results.users|length }}</span>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button class="btn-glass btn-icon btn-sm collapse-toggle" aria-label="æŠ˜å /å±•å¼€">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="userInfoCollapse">
                    <div class="card-body">
                        <div class="table-container">
                            <div class="table-scroll-wrapper">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>ç”¨æˆ·ID</th>
                                            <th>ç”¨æˆ·å</th>
                                            <th>å§“å</th>
                                            <th>å¯¹è¯æ•°</th>
                                            <th>æ¶ˆæ¯è½®æ¬¡</th>
                                            <th>æ³¨å†Œæ—¶é—´</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user in results.users %}
                                        <tr class="table-row-interactive">
                                            <td><span >{{ user.uid }}</span></td>
                                            <td>
                                                <div class="user-info">
                                                    <div class="user-avatar">
                                                        <div class="avatar-image">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                                        </div>
                                                    </div>
                                                    <div class="user-details">
                                                        <span class="user-name">{{ (user.user_name or 'æœªè®¾ç½®')|replace(query, '<mark>' + query + '</mark>')|safe }}</span>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{{ ((user.first_name or '') + ' ' + (user.last_name or ''))|replace(query, '<mark>' + query + '</mark>')|safe }}</td>
                                            <td><span class="data-value">{{ user.conversations or 0 }}</span></td>
                                            <td><span class="data-value">{{ user.dialog_turns or 0 }}</span></td>
                                            <td>
                                                <div class="time-split">
                                                    <div class="time-date">{{ format_datetime(user.create_at).split(' ')[0] }}</div>
                                                    <div class="time-clock">{{ format_datetime(user.create_at).split(' ')[1].split('.')[0] }}</div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <a href="{{ url_for('admin.conversations', search=user.uid) }}" class="btn-glass btn-icon btn-sm" title="æŸ¥çœ‹å¯¹è¯">ğŸ’¬</a>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- ç¾¤ç»„ä¿¡æ¯ç»“æœ -->
            {% if results.groups %}
            <div class="card card-glass mb-4 collapsible-card">
                <div class="card-header" aria-expanded="true" aria-controls="groupInfoCollapse" style="cursor: pointer;">
                    <div class="header-container">
                        <div class="header-title">
                            <div class="header-icon">ğŸ‘¥</div>
                            <div class="header-text">
                                <h3>ç¾¤ç»„ä¿¡æ¯</h3>
                                <span >{{ results.groups|length }}</span>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button class="btn-glass btn-icon btn-sm collapse-toggle" aria-label="æŠ˜å /å±•å¼€">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="groupInfoCollapse">
                    <div class="card-body">
                        <div class="table-container">
                            <div class="table-scroll-wrapper">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>ç¾¤ç»„ID</th>
                                            <th>ç¾¤ç»„åç§°</th>
                                            <th>å¯¹è¯æ•°</th>
                                            <th>è°ƒç”¨æ¬¡æ•°</th>
                                            <th>è§’è‰²</th>
                                            <th>çŠ¶æ€</th>
                                            <th>æ›´æ–°æ—¶é—´</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for group in results.groups %}
                                        <tr class="table-row-interactive">
                                            <td><span >{{ group.group_id }}</span></td>
                                            <td>
                                                <div class="user-info">
                                                    <div class="user-avatar">
                                                        <div class="avatar-image">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                                                        </div>
                                                    </div>
                                                    <div class="user-details">
                                                        <span class="user-name">{{ (group.group_name or 'æœªå‘½åç¾¤ç»„')|replace(query, '<mark>' + query + '</mark>')|safe }}</span>
                                                    </div>
                                                </div>
                                            </td>
                                            <td><span class="data-value">{{ group.dialog_count or 0 }}</span></td>
                                            <td><span class="data-value">{{ group.call_count or 0 }}</span></td>
                                            <td><span >{{ group.char or 'æœªè®¾ç½®' }}</span></td>
                                            <td>
                                                {% if group.active %}
                                                    <span >æ´»è·ƒ</span>
                                                {% else %}
                                                    <span >éæ´»è·ƒ</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="time-split">
                                                    <div class="time-date">{{ format_datetime(group.update_time).split(' ')[0] }}</div>
                                                    <div class="time-clock">{{ format_datetime(group.update_time).split(' ')[1].split('.')[0] }}</div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <a href="{{ url_for('admin.group_dialogs', group_id=group.group_id) }}" class="btn-glass btn-icon btn-sm" title="æŸ¥çœ‹ç¾¤ç»„å¯¹è¯">ğŸ‘¥</a>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- å¯¹è¯è®°å½•ç»“æœ -->
            {% if results.conversations %}
            <div class="card card-glass mb-4 collapsible-card">
                <div class="card-header" aria-expanded="true" aria-controls="conversationsCollapse" style="cursor: pointer;">
                    <div class="header-container">
                        <div class="header-title">
                            <div class="header-icon">ğŸ’¬</div>
                            <div class="header-text">
                                <h3>å¯¹è¯è®°å½•</h3>
                                <span >{{ results.conversations|length }}</span>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button class="btn-glass btn-icon btn-sm collapse-toggle" aria-label="æŠ˜å /å±•å¼€">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="conversationsCollapse">
                    <div class="card-body">
                        <div class="table-container">
                            <div class="table-scroll-wrapper">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%;">ç”¨æˆ·</th>
                                            <th style="width: 15%;">å¯¹è¯ä¿¡æ¯</th>
                                            <th style="width: 5%;">è½®æ•°</th>
                                            <th style="width: 50%;">æ‘˜è¦</th>
                                            <th style="width: 15%;">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for conv in results.conversations %}
                                        <tr class="table-row-interactive">
                                            <td>
                                                <div class="user-info">
                                                    <div class="user-avatar">
                                                        <div class="avatar-image">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                                        </div>
                                                    </div>
                                                    <div class="user-details">
                                                        <div class="user-name">{{ (conv.user_name or 'æœªè®¾ç½®')|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                        <div class="user-id">{{ conv.user_id }}</div>
                                                        {% if conv.first_name or conv.last_name %}
                                                            <div class="user-real-name">{{ ((conv.first_name or '') + ' ' + (conv.last_name or ''))|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="stacked-info">
                                                    <div class="info-primary">{{ conv.conv_id }}</div>
                                                    <div class="info-secondary">{{ (conv.character or 'æœªè®¾ç½®')|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                    <div class="info-tertiary">{{ (conv.preset or 'é»˜è®¤')|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                </div>
                                            </td>
                                            <td><span class="data-value">{{ conv.turns or 0 }}</span></td>
                                            <td style="white-space: normal; word-break: break-all;" class="summary-cell">
                                               {% if conv.summary %}
                                                   <div class="collapsible-text">
                                                       <div class="text-preview">{{ (conv.summary[:50] + '...')|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                       <div class="text-full" style="display: none;">{{ conv.summary|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                       <button class="btn-glass btn-text btn-sm toggle-text">å±•å¼€</button>
                                                   </div>
                                               {% else %}
                                                   <div class="summary-placeholder-modern">
                                                       <i class="fas fa-info-circle"></i>
                                                       <span>[æ— æ‘˜è¦]</span>
                                                   </div>
                                               {% endif %}
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <a href="{{ url_for('admin.dialogs', conv_id=conv.conv_id) }}" class="btn-glass btn-icon btn-sm" title="æŸ¥çœ‹å¯¹è¯è¯¦æƒ…">ğŸ‘ï¸</a>
                                                    <button type="button" class="btn-glass btn-icon btn-sm generate-summary-btn" data-conv-id="{{ conv.conv_id }}" title="ç”Ÿæˆæ‘˜è¦">âœ¨</button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        {% else %}
            <!-- æ— æœç´¢ç»“æœ -->
            <div class="card glass-card empty-state-card">
                <div class="card-body">
                    <div class="empty-state-content">
                        <div class="empty-state-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        </div>
                        <h3 class="empty-state-title">æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</h3>
                        <p class="empty-state-text">è¯·å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯è¿›è¡Œæœç´¢</p>
                    </div>
                </div>
            </div>
        {% endif %}
    {% else %}
        <!-- NEW: Initial Search Page Placeholder -->
        <div class="search-placeholder-wrapper">
            <div class="search-placeholder">
                <div class="placeholder-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
                <h2 class="placeholder-title">å…¨å±€æœç´¢</h2>
                <p class="placeholder-subtitle">è¾“å…¥å…³é”®è¯å¯æœç´¢ç”¨æˆ·ã€ç¾¤ç»„ã€å¯¹è¯åŠæ¶ˆæ¯å†…å®¹</p>
                
                <div class="placeholder-categories">
                    <div class="category-item">
                        <span class="category-icon">ğŸ‘¤</span>
                        <span class="category-text">ç§èŠæ¶ˆæ¯</span>
                    </div>
                    <div class="category-item">
                        <span class="category-icon">ğŸ‘¥</span>
                        <span class="category-text">ç¾¤ç»„æ¶ˆæ¯</span>
                    </div>
                    <div class="category-item">
                        <span class="category-icon">ğŸ§‘â€ğŸ’»</span>
                        <span class="category-text">ç”¨æˆ·ä¿¡æ¯</span>
                    </div>
                    <div class="category-item">
                        <span class="category-icon">ğŸ’¬</span>
                        <span class="category-text">å¯¹è¯è®°å½•</span>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/search.js') }}"></script>
<script>
// è‡ªåŠ¨èšç„¦æœç´¢æ¡†
$(document).ready(function() {
    // è‡ªåŠ¨èšç„¦æœç´¢æ¡†
    const searchInput = $('#searchQuery');
    if (searchInput.length > 0 && !searchInput.val()) {
        searchInput.focus();
    }

    // è‡ªå®šä¹‰å¡ç‰‡æŠ˜å åŠŸèƒ½
    $('.collapsible-card .card-header').on('click', function(e) {
        // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®æˆ–é“¾æ¥ï¼Œåˆ™ä¸è§¦å‘æŠ˜å 
        if ($(e.target).is('button, a, .btn-glass') || $(e.target).closest('button, a, .btn-glass').length) {
            return;
        }

        const card = $(this).closest('.collapsible-card');
        const body = card.find('.collapse');
        const icon = $(this).find('.collapse-icon');

        // ä½¿ç”¨ slideToggle å®ç°å¹³æ»‘çš„å±•å¼€/æ”¶èµ·
        body.slideToggle(300, function() {
            // åˆ‡æ¢å›¾æ ‡çš„æ—‹è½¬çŠ¶æ€
            if (body.is(':visible')) {
                icon.css('transform', 'rotate(0deg)');
                card.addClass('is-expanded');
            } else {
                icon.css('transform', 'rotate(-90deg)');
                card.removeClass('is-expanded');
            }
        });
    });

    // ä¸ºæŠ˜å æŒ‰é’®æ·»åŠ ç‹¬ç«‹çš„ç‚¹å‡»äº‹ä»¶
    $('.collapse-toggle').on('click', function(e) {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ° card-header
        
        const card = $(this).closest('.collapsible-card');
        const body = card.find('.collapse');
        const icon = $(this).find('.collapse-icon');

        body.slideToggle(300, function() {
            if (body.is(':visible')) {
                icon.css('transform', 'rotate(0deg)');
                card.addClass('is-expanded');
            } else {
                icon.css('transform', 'rotate(-90deg)');
                card.removeClass('is-expanded');
            }
        });
    });

    // åˆå§‹æ—¶ï¼Œä¸ºæ‰€æœ‰å¡ç‰‡è®¾ç½®æ­£ç¡®çš„å›¾æ ‡çŠ¶æ€
    $('.collapsible-card').each(function() {
        const card = $(this);
        const body = card.find('.collapse');
        const icon = card.find('.collapse-icon');
        if (body.hasClass('show')) {
            icon.css('transform', 'rotate(0deg)');
            card.addClass('is-expanded');
        } else {
            icon.css('transform', 'rotate(-90deg)');
            card.removeClass('is-expanded');
        }
    });

    // ä½¿ç”¨jQueryé‡å†™æ–‡æœ¬å±•å¼€/æ”¶èµ·åŠŸèƒ½
    $('.data-table').on('click', '.toggle-text', function() {
        const button = $(this);
        const container = button.closest('.collapsible-text');
        const preview = container.find('.text-preview');
        const full = container.find('.text-full');

        if (full.is(':hidden')) {
            preview.hide();
            full.slideDown(300); // Use slideDown for smooth animation
            button.text('æ”¶èµ·').addClass('expanded');
        } else {
            full.slideUp(300, function() { // Use slideUp for smooth animation
                preview.show();
            });
            button.text('å±•å¼€').removeClass('expanded');
        }
    });

    // ç”Ÿæˆæ‘˜è¦æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    $(document).on('click', '.generate-summary-btn', function () {
        const convId = $(this).data('conv-id');
        const button = $(this);

        if (button.hasClass('loading')) {
            return;
        }

        const originalIcon = button.html();
        button.prop('disabled', true).addClass('loading').html('<span class="btn-text">...</span>');

        $.ajax({
            url: '/api/generate_summary',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ conversation_id: convId }),
            success: function (response) {
                if (response.success) {
                    const summaryCell = button.closest('tr').find('.summary-cell');
                    const summary = response.summary || '';
                    const query = $('#searchQuery').val();
                    
                    // Function to safely highlight text
                    function highlight(text, term) {
                        if (!term) return text;
                        const regex = new RegExp(term.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi');
                        return text.replace(regex, '<mark>$&</mark>');
                    }

                    const highlightedSummary = highlight(summary, query);
                    const previewText = summary.length > 50 ? highlight(summary.substring(0, 50) + '...', query) : highlightedSummary;

                    const newSummaryHtml = `
                        <div class="collapsible-text">
                            <div class="text-preview">${previewText}</div>
                            <div class="text-full" style="display: none;">${highlightedSummary}</div>
                            <button class="btn-glass btn-text btn-sm toggle-text">å±•å¼€</button>
                        </div>
                    `;
                    summaryCell.html(newSummaryHtml);

                    if (window.showToast) {
                        showToast('æ‘˜è¦ç”ŸæˆæˆåŠŸï¼', 'success');
                    }
                } else {
                    if (window.showToast) {
                        showToast('æ‘˜è¦ç”Ÿæˆå¤±è´¥ï¼š' + (response.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                    }
                }
            },
            error: function (xhr, status, error) {
                console.error('ç”Ÿæˆæ‘˜è¦è¯·æ±‚å¤±è´¥:', error);
                if (window.showToast) {
                    showToast('è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                }
            },
            complete: function () {
                button.prop('disabled', false).removeClass('loading').html(originalIcon);
            }
        });
    });
});

// å¤åˆ¶è½¬å‘æŒ‡ä»¤åŠŸèƒ½
function copyForwardCommand(targetId, msgId) {
    const command = `/fw ${targetId} ${msgId}`;
    
    // ä½¿ç”¨ç°ä»£çš„ Clipboard API
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(command).then(function() {
            showToast('è½¬å‘æŒ‡ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ' + command, 'success');
        }).catch(function(err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            fallbackCopyTextToClipboard(command);
        });
    } else {
        // é™çº§æ–¹æ¡ˆ
        fallbackCopyTextToClipboard(command);
    }
}

// é™çº§å¤åˆ¶æ–¹æ¡ˆ
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showToast('è½¬å‘æŒ‡ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ' + text, 'success');
        } else {
            showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶: ' + text, 'error');
        }
    } catch (err) {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶: ' + text, 'error');
    }
    
    document.body.removeChild(textArea);
}

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showToast(message, type = 'info') {
    // åˆ›å»ºæç¤ºå…ƒç´ 
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; opacity: 0; transition: opacity 0.3s;';
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => {
        toast.style.opacity = '1';
    }, 10);
    
    // è‡ªåŠ¨éšè—
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
            if (toast.parentNode) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// è·³è½¬åˆ°ç¾¤èŠæ¶ˆæ¯ï¼ˆè·å–æ­£ç¡®çš„é¡µç ï¼‰
function jumpToGroupMessage(groupId, msgId) {
    console.log('jumpToGroupMessage called with:', groupId, msgId);
    
    // è°ƒç”¨APIè·å–æ¶ˆæ¯æ‰€åœ¨çš„é¡µç 
    fetch(`/api/message_page/${groupId}/${msgId}`)
        .then(response => {
            console.log('API response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('API response data:', data);
            if (data.error) {
                console.error('è·å–æ¶ˆæ¯é¡µç å¤±è´¥:', data.error);
                // å¦‚æœAPIå¤±è´¥ï¼Œå›é€€åˆ°åŸæ¥çš„æ–¹æ³•
                const targetUrl = `{{ url_for('admin.group_dialogs', group_id='') }}${groupId}#msg-${msgId}`;
                console.log('Fallback URL:', targetUrl);
                window.location.href = targetUrl;
            } else {
                // è·³è½¬åˆ°æ­£ç¡®çš„é¡µé¢ï¼Œå¹¶åœ¨URLä¸­æ·»åŠ ç›®æ ‡æ¶ˆæ¯ID
                const targetUrl = `{{ url_for('admin.group_dialogs', group_id='') }}${groupId}?page=${data.page}#msg-${msgId}`;
                console.log('Target URL:', targetUrl);
                window.location.href = targetUrl;
            }
        })
        .catch(error => {
            console.error('APIè¯·æ±‚å¤±è´¥:', error);
            // å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œå›é€€åˆ°åŸæ¥çš„æ–¹æ³•
            const targetUrl = `{{ url_for('admin.group_dialogs', group_id='') }}${groupId}#msg-${msgId}`;
            console.log('Error fallback URL:', targetUrl);
            window.location.href = targetUrl;
        });
}
</script>
{% endblock %}