{% extends "base.html" %}

{% block title %}ÂÖ®Â±ÄÊêúÁ¥¢ - CyberWaifu Bot ÂêéÂè∞ÁÆ°ÁêÜÁ≥ªÁªü{% endblock %}

{% block page_title %}ÂÖ®Â±ÄÊêúÁ¥¢{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/search-table.css') }}">
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- ÊêúÁ¥¢Ë°®ÂçïÂíåÁªìÊûúÁªüËÆ° -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="search-container">
                <form method="GET" class="search-form">
                    <div class="search-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>
                    <input type="text" name="q" class="search-input" 
                           placeholder="ËæìÂÖ•ÂÖ≥ÈîÆËØçÊêúÁ¥¢Áî®Êà∑„ÄÅÁæ§ÁªÑ„ÄÅÂØπËØùËÆ∞ÂΩïÁ≠â..." value="{{ query }}"
                           aria-label="ÊêúÁ¥¢ÂÖ≥ÈîÆËØç" id="searchQuery" required>
                    <div class="search-loading"></div>
                    {% if query %}
                    <a href="{{ url_for('admin.search') }}" class="clear-button" aria-label="Ê∏ÖÈô§ÊêúÁ¥¢">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </a>
                    {% endif %}
                    <button type="submit" class="search-button" aria-label="ÊêúÁ¥¢">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </button>
                </form>
                
                <!-- ÊêúÁ¥¢Áä∂ÊÄÅÂíåÁªìÊûúÁªüËÆ° -->
                {% if query %}
                <div class="search-status-section mt-3">
                    <div class="search-keyword mb-3">
                        <span class="search-label">ÊêúÁ¥¢ÂÖ≥ÈîÆËØçÔºö</span>
                        <span class="search-term">{{ query }}</span>
                    </div>
                    
                    <!-- ÊêúÁ¥¢ÁªìÊûúÁªüËÆ° -->
                    {% if results %}
                    <div class="search-stats-compact">
                        <div class="stats-item">
                            <span class="stats-icon">üìä</span>
                            <span class="stats-number">{{ results.total_count or 0 }}</span>
                            <span class="stats-label">ÊÄªÁªìÊûú</span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-icon">üí¨</span>
                            <span class="stats-number">{{ (results.dialogs|selectattr('type', 'equalto', 'private')|list|length) or 0 }}</span>
                            <span class="stats-label">ÁßÅËÅäÊ∂àÊÅØ</span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-icon">üë•</span>
                            <span class="stats-number">{{ (results.dialogs|selectattr('type', 'equalto', 'group')|list|length) or 0 }}</span>
                            <span class="stats-label">Áæ§ËÅäÊ∂àÊÅØ</span>
                        </div>
                        <div class="stats-item">
                            <span class="stats-icon">üë§</span>
                            <span class="stats-number">{{ (results.users|length) or 0 }}</span>
                            <span class="stats-label">Áî®Êà∑‰ø°ÊÅØ</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ÊêúÁ¥¢ÁªìÊûú -->
    {% if query %}
        {% set total_results = (results.dialogs|length) + (results.users|length) + (results.groups|length) + (results.conversations|length) %}
        


        {% if total_results > 0 %}
            <!-- ÁßÅËÅäÂØπËØùÊ∂àÊÅØÁªìÊûú -->
            {% if results.dialogs and results.dialogs|selectattr('type', 'equalto', 'private')|list %}
            <div class="card mb-4 collapsible-card">
                <div class="card-header" data-bs-toggle="collapse" data-bs-target="#privateDialogsCollapse" aria-expanded="true" aria-controls="privateDialogsCollapse" style="cursor: pointer;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <span class="card-header-icon">üë§</span>
                            <h2 class="card-header-title">ÁßÅËÅäÂØπËØùÊ∂àÊÅØ</h2>
                            <span class="badge primary ml-sm">{{ results.dialogs|selectattr('type', 'equalto', 'private')|list|length }}</span>
                        </div>
                        <div class="card-header-actions">
                            <button class="btn btn-sm btn-outline refresh-data" aria-label="Âà∑Êñ∞Êï∞ÊçÆ" onclick="event.stopPropagation();">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <polyline points="1 20 1 14 7 14"></polyline>
                                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                                </svg>
                                Âà∑Êñ∞
                            </button>
                            <button class="btn btn-sm btn-outline collapse-toggle" aria-label="ÊäòÂè†/Â±ïÂºÄ">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="privateDialogsCollapse">
                <div class="card-body">
                    <div class="search-table-container">
                        <table class="search-data-table">
                            <thead>
                                <tr>
                                    <th>ÂØπËØùID</th>
                                    <th>ËßíËâ≤</th>
                                    <th>Áî®Êà∑ÂßìÂêç</th>
                                    <th>Áî®Êà∑ID</th>
                                    <th>Â§ÑÁêÜÂêéÂÜÖÂÆπ</th>
                                    <th>ËΩÆÊ¨°</th>
                                    <th>ÂàõÂª∫Êó∂Èó¥</th>
                                    <th>Ê∂àÊÅØID</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dialog in results.dialogs|selectattr('type', 'equalto', 'private') %}
                                <tr class="table-row-interactive">
                                    <td>
                                        <span class="badge primary">{{ dialog.conv_id }}</span>
                                    </td>
                                    <td>
                                        {% if dialog.role == 'user' %}
                                            <span class="badge info"><i class="fas fa-user"></i> Áî®Êà∑</span>
                                        {% else %}
                                            <span class="badge success"><i class="fas fa-robot"></i> AI</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="user-info">
                                            <div class="user-avatar">
                                                <div class="avatar-image">
                                                    {% if dialog.user_name %}
                                                        {{ dialog.user_name[0] }}
                                                    {% else %}
                                                        U
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="user-details">
                                                <span class="user-name">{{ (dialog.user_name or 'Êú™ËÆæÁΩÆ')|replace(query, '<mark>' + query + '</mark>')|safe }}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge secondary">{{ dialog.user_id or '-' }}</span>
                                    </td>
                                    <td>
                                        {% set processed_content = (dialog.processed_content or dialog.raw_content or '')|string %}
                                        {% if processed_content|length > 50 %}
                                            <div class="collapsible-text">
                                                <div class="text-preview">{{ (processed_content[:50] + '...')|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                <div class="text-full" style="display: none;">{{ processed_content|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                <button class="btn btn-text btn-sm toggle-text" onclick="toggleText(this)">Â±ïÂºÄ</button>
                                            </div>
                                        {% else %}
                                            {{ processed_content|replace(query, '<mark>' + query + '</mark>')|safe }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge secondary">{{ dialog.turn_order or '-' }}</span>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ format_datetime(dialog.created_at) }}</small>
                                    </td>
                                    <td>
                                        <span class="badge light">{{ dialog.msg_id or '-' }}</span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <a href="{{ url_for('admin.dialogs', conv_id=dialog.conv_id) }}#msg-{{ dialog.id }}"
                                               class="btn btn-icon btn-sm" title="Êü•ÁúãÂÆåÊï¥ÂØπËØù">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                                    <circle cx="12" cy="12" r="3"></circle>
                                                </svg>
                                            </a>
                                            <button class="btn btn-icon btn-sm" 
                                                    onclick="copyForwardCommand('{{ dialog.user_id }}', '{{ dialog.msg_id }}')"
                                                    title="Â§çÂà∂ËΩ¨ÂèëÊåá‰ª§">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Áæ§ËÅäÊ∂àÊÅØÁªìÊûú -->
            {% if results.dialogs and results.dialogs|selectattr('type', 'equalto', 'group')|list %}
            <div class="card mb-4 collapsible-card">
                <div class="card-header" data-bs-target="#groupMessagesCollapse" style="cursor: pointer;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <span class="card-header-icon">üë•</span>
                            <h2 class="card-header-title">Áæ§ËÅäÊ∂àÊÅØ</h2>
                            <span class="badge warning ml-sm">{{ results.dialogs|selectattr('type', 'equalto', 'group')|list|length }}</span>
                        </div>
                        <div class="card-header-actions">
                            <button class="btn btn-sm btn-outline refresh-data" aria-label="Âà∑Êñ∞Êï∞ÊçÆ" onclick="event.stopPropagation();">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <polyline points="1 20 1 14 7 14"></polyline>
                                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                                </svg>
                                Âà∑Êñ∞
                            </button>
                            <button class="btn btn-sm btn-outline collapse-toggle" aria-label="ÊäòÂè†/Â±ïÂºÄ">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="groupMessagesCollapse">
                    <div class="card-body">
                        <div class="search-table-container">
                        <table class="search-data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Áæ§ÁªÑÂêç</th>
                                    <th>Áî®Êà∑ÂßìÂêç</th>
                                    <th>Ê∂àÊÅØÊñáÊú¨</th>
                                    <th>Â§ÑÁêÜÂêéÂìçÂ∫î</th>
                                    <th>ÂàõÂª∫Êó∂Èó¥</th>
                                    <th>Ê∂àÊÅØID</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dialog in results.dialogs|selectattr('type', 'equalto', 'group') %}
                                <tr class="table-row-interactive">
                                    <td>
                                        <span class="badge secondary">{{ dialog.id or '-' }}</span>
                                    </td>
                                    <td>
                                        <span class="badge info">{{ dialog.group_name or '-' }}</span>
                                    </td>
                                    <td>
                                        <span class="badge success">{{ dialog.msg_user_name or '-' }}</span>
                                    </td>
                                    <td>
                                        {% set msg_text = (dialog.msg_text or '')|string %}
                                        {% if msg_text|length > 50 %}
                                            <div class="collapsible-text">
                                                <div class="text-preview">{{ (msg_text[:50] + '...')|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                <div class="text-full" style="display: none;">{{ msg_text|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                <button class="btn btn-text btn-sm toggle-text" onclick="toggleText(this)">Â±ïÂºÄ</button>
                                            </div>
                                        {% else %}
                                            {{ msg_text|replace(query, '<mark>' + query + '</mark>')|safe }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set processed_response = (dialog.processed_response or dialog.raw_response or '')|string %}
                                        {% if processed_response|length > 50 %}
                                            <div class="collapsible-text">
                                                <div class="text-preview">{{ (processed_response[:50] + '...')|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                <div class="text-full" style="display: none;">{{ processed_response|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                                <button class="btn btn-text btn-sm toggle-text" onclick="toggleText(this)">Â±ïÂºÄ</button>
                                            </div>
                                        {% else %}
                                            {{ processed_response|replace(query, '<mark>' + query + '</mark>')|safe }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ format_datetime(dialog.create_at) }}</small>
                                    </td>
                                    <td>
                                        <span class="badge light">{{ dialog.msg_id or '-' }}</span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-icon btn-sm" 
                                                    onclick="jumpToGroupMessage('{{ dialog.group_id }}', '{{ dialog.msg_id }}')"
                                                    title="Êü•ÁúãÁæ§ËÅäËÆ∞ÂΩï">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                                    <circle cx="12" cy="12" r="3"></circle>
                                                </svg>
                                            </button>
                                            <button class="btn btn-icon btn-sm" 
                                                    onclick="copyForwardCommand('{{ dialog.group_id }}', '{{ dialog.msg_id }}')"
                                                    title="Â§çÂà∂ËΩ¨ÂèëÊåá‰ª§">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Áî®Êà∑‰ø°ÊÅØÁªìÊûú -->
            {% if results.users %}
            <div class="card mb-4 collapsible-card">
                <div class="card-header" data-bs-target="#userInfoCollapse" style="cursor: pointer;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <span class="card-header-icon">üë•</span>
                            <h2 class="card-header-title">Áî®Êà∑‰ø°ÊÅØ</h2>
                            <span class="badge success ml-sm">{{ results.users|length }}</span>
                        </div>
                        <div class="card-header-actions">
                            <button class="btn btn-sm btn-outline refresh-data" aria-label="Âà∑Êñ∞Êï∞ÊçÆ" onclick="event.stopPropagation();">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <polyline points="1 20 1 14 7 14"></polyline>
                                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                                </svg>
                                Âà∑Êñ∞
                            </button>
                            <button class="btn btn-sm btn-outline collapse-toggle" aria-label="ÊäòÂè†/Â±ïÂºÄ">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="userInfoCollapse">
                    <div class="card-body">
                    <div class="search-table-container">
                        <table class="search-data-table">
                            <thead>
                                <tr>
                                    <th>Áî®Êà∑ID</th>
                                    <th>Áî®Êà∑Âêç</th>
                                    <th>ÂßìÂêç</th>
                                    <th>ÂØπËØùÊï∞</th>
                                    <th>Ê∂àÊÅØËΩÆÊ¨°</th>
                                    <th>Ê≥®ÂÜåÊó∂Èó¥</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in results.users %}
                                <tr class="table-row-interactive">
                                    <td>
                                        <span class="badge secondary">{{ user.uid }}</span>
                                    </td>
                                    <td>
                                        <div class="user-info">
                                            <div class="user-avatar">
                                                <div class="avatar-image">
                                                    {% if user.user_name %}
                                                        {{ user.user_name[0] }}
                                                    {% else %}
                                                        U
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="user-details">
                                                <span class="user-name">{{ (user.user_name or 'Êú™ËÆæÁΩÆ')|replace(query, '<mark>' + query + '</mark>')|safe }}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {{ ((user.first_name or '') + ' ' + (user.last_name or ''))|replace(query, '<mark>' + query + '</mark>')|safe }}
                                    </td>
                                    <td>
                                        <div class="stat-badge">
                                            <span class="stat-value">{{ user.conversations or 0 }}</span>
                                            <span class="stat-label">ÂØπËØù</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="stat-badge">
                                            <span class="stat-value">{{ user.dialog_turns or 0 }}</span>
                                            <span class="stat-label">Ê∂àÊÅØ</span>
                                        </div>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ format_datetime(user.create_at) }}</small>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <a href="{{ url_for('admin.conversations', search=user.uid) }}"
                                               class="btn btn-icon btn-sm" title="Êü•ÁúãÂØπËØù">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                                </svg>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Áæ§ÁªÑ‰ø°ÊÅØÁªìÊûú -->
            {% if results.groups %}
            <div class="card mb-4 collapsible-card">
                <div class="card-header" data-bs-target="#groupInfoCollapse" style="cursor: pointer;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <span class="card-header-icon">üë•</span>
                            <h2 class="card-header-title">Áæ§ÁªÑ‰ø°ÊÅØ</h2>
                            <span class="badge warning ml-sm">{{ results.groups|length }}</span>
                        </div>
                        <div class="card-header-actions">
                            <button class="btn btn-sm btn-outline refresh-data" aria-label="Âà∑Êñ∞Êï∞ÊçÆ" onclick="event.stopPropagation();">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <polyline points="1 20 1 14 7 14"></polyline>
                                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                                </svg>
                                Âà∑Êñ∞
                            </button>
                            <button class="btn btn-sm btn-outline collapse-toggle" aria-label="ÊäòÂè†/Â±ïÂºÄ">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="groupInfoCollapse">
                    <div class="card-body">
                    <div class="search-table-container">
                        <table class="search-data-table">
                            <thead>
                                <tr>
                                    <th>Áæ§ÁªÑID</th>
                                    <th>Áæ§ÁªÑÂêçÁß∞</th>
                                    <th>ÂØπËØùÊï∞</th>
                                    <th>Ë∞ÉÁî®Ê¨°Êï∞</th>
                                    <th>ËßíËâ≤</th>
                                    <th>Áä∂ÊÄÅ</th>
                                    <th>Êõ¥Êñ∞Êó∂Èó¥</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for group in results.groups %}
                                <tr class="table-row-interactive">
                                    <td>
                                        <span class="badge primary">{{ group.group_id }}</span>
                                    </td>
                                    <td>
                                        <div class="user-info">
                                            <div class="user-avatar">
                                                <div class="avatar-image">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                                        <circle cx="9" cy="7" r="4"></circle>
                                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                                    </svg>
                                                </div>
                                            </div>
                                            <div class="user-details">
                                                <span class="user-name">{{ (group.group_name or 'Êú™ÂëΩÂêçÁæ§ÁªÑ')|replace(query, '<mark>' + query + '</mark>')|safe }}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="stat-badge">
                                            <span class="stat-value">{{ group.dialog_count or 0 }}</span>
                                            <span class="stat-label">ÂØπËØù</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="stat-badge">
                                            <span class="stat-value">{{ group.call_count or 0 }}</span>
                                            <span class="stat-label">Ë∞ÉÁî®</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge info">{{ group.char or 'Êú™ËÆæÁΩÆ' }}</span>
                                    </td>
                                    <td>
                                        {% if group.active %}
                                            <span class="badge success">Ê¥ªË∑É</span>
                                        {% else %}
                                            <span class="badge danger">ÈùûÊ¥ªË∑É</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ format_datetime(group.update_time) }}</small>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <a href="{{ url_for('admin.group_dialogs', group_id=group.group_id) }}"
                                               class="btn btn-icon btn-sm" title="Êü•ÁúãÁæ§ÁªÑÂØπËØù">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                                </svg>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- ÂØπËØùËÆ∞ÂΩïÁªìÊûú -->
            {% if results.conversations %}
            <div class="card mb-4 collapsible-card">
                <div class="card-header" data-bs-target="#conversationsCollapse" style="cursor: pointer;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <span class="card-header-icon">üí¨</span>
                            <h2 class="card-header-title">ÂØπËØùËÆ∞ÂΩï</h2>
                            <span class="badge secondary ml-sm">{{ results.conversations|length }}</span>
                        </div>
                        <div class="card-header-actions">
                            <button class="btn btn-sm btn-outline refresh-data" aria-label="Âà∑Êñ∞Êï∞ÊçÆ" onclick="event.stopPropagation();">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <polyline points="1 20 1 14 7 14"></polyline>
                                    <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                                </svg>
                                Âà∑Êñ∞
                            </button>
                            <button class="btn btn-sm btn-outline collapse-toggle" aria-label="ÊäòÂè†/Â±ïÂºÄ">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="collapse-icon">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="conversationsCollapse">
                    <div class="card-body">
                    <div class="search-table-container">
                        <table class="search-data-table">
                            <thead>
                                <tr>
                                    <th>ÂØπËØùID</th>
                                    <th>Áî®Êà∑</th>
                                    <th>ËßíËâ≤ & È¢ÑËÆæ</th>
                                    <th>ÂØπËØùËΩÆÊï∞</th>
                                    <th>ÊëòË¶Å</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for conv in results.conversations %}
                                <tr class="table-row-interactive">
                                    <td>
                                        <span class="badge primary">{{ conv.conv_id }}</span>
                                    </td>
                                    <td>
                                        <div class="user-info">
                                            <div class="user-avatar">
                                                <div class="avatar-image">
                                                    {% if conv.user_name %}
                                                        {{ conv.user_name[0] }}
                                                    {% else %}
                                                        U
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="user-details">
                                                <span class="user-name">{{ (conv.user_name or 'Êú™ËÆæÁΩÆ')|replace(query, '<mark>' + query + '</mark>')|safe }}</span>
                                                <span class="user-id">{{ conv.user_id }}</span>
                                                {% if conv.first_name or conv.last_name %}
                                                    <span class="user-real-name">{{ ((conv.first_name or '') + ' ' + (conv.last_name or ''))|replace(query, '<mark>' + query + '</mark>')|safe }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="character-preset-cell">
                                            <span class="badge info">{{ (conv.character or 'Êú™ËÆæÁΩÆ')|replace(query, '<mark>' + query + '</mark>')|safe }}</span>
                                            <span class="badge warning">{{ (conv.preset or 'ÈªòËÆ§')|replace(query, '<mark>' + query + '</mark>')|safe }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="stat-badge">
                                            <span class="stat-value">{{ conv.turns or 0 }}</span>
                                            <span class="stat-label">ËΩÆÊ¨°</span>
                                        </div>
                                    </td>
                                    <td>
                                        {% if conv.summary %}
                                            <div class="summary-content-modern">{{ conv.summary|replace(query, '<mark>' + query + '</mark>')|safe }}</div>
                                        {% else %}
                                            <div class="summary-placeholder-modern">
                                                <i class="fas fa-info-circle"></i>
                                                <span>Êó†ÊëòË¶Å</span>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <a href="{{ url_for('admin.dialogs', conv_id=conv.conv_id) }}"
                                               class="btn btn-icon btn-sm" title="Êü•ÁúãÂØπËØùËØ¶ÊÉÖ">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                                    <circle cx="12" cy="12" r="3"></circle>
                                                </svg>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    </div>
                </div>
            </div>
            {% endif %}
        {% else %}
            <!-- Êó†ÊêúÁ¥¢ÁªìÊûú -->
            <div class="card mb-4">
                <div class="card-body text-center py-5">
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <h5 class="empty-title">Êú™ÊâæÂà∞Áõ∏ÂÖ≥ÁªìÊûú</h5>
                        <p class="empty-text">ËØ∑Â∞ùËØï‰ΩøÁî®ÂÖ∂‰ªñÂÖ≥ÈîÆËØçËøõË°åÊêúÁ¥¢</p>
                    </div>
                </div>
            </div>
        {% endif %}
    {% else %}
        <!-- ÊêúÁ¥¢ÊèêÁ§∫ -->
        <div class="card mb-4">
            <div class="card-body text-center py-5">
                <div class="empty-state">
                    <div class="empty-icon">üîç</div>
                    <h4 class="empty-title">ÂÖ®Â±ÄÊêúÁ¥¢</h4>
                    <p class="empty-text">ËæìÂÖ•ÂÖ≥ÈîÆËØçÊêúÁ¥¢Áî®Êà∑„ÄÅÁæ§ÁªÑ„ÄÅÂØπËØùËÆ∞ÂΩïÂíåÊ∂àÊÅØÂÜÖÂÆπ</p>
                    
                    <!-- ÊêúÁ¥¢ÂäüËÉΩ‰ªãÁªç -->
                    <div class="row justify-content-center mt-4">
                        <div class="col-md-10">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="card border-primary">
                                        <div class="card-body text-center">
                                            <i class="fas fa-comments text-primary" style="font-size: 2rem;"></i>
                                            <h6 class="mt-2">ÂØπËØùÊ∂àÊÅØ</h6>
                                            <small class="text-muted">ÊêúÁ¥¢ÂØπËØùÂÜÖÂÆπÂíåAIÂõûÂ§ç</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card border-success">
                                        <div class="card-body text-center">
                                            <i class="fas fa-users text-success" style="font-size: 2rem;"></i>
                                            <h6 class="mt-2">Áî®Êà∑‰ø°ÊÅØ</h6>
                                            <small class="text-muted">ÊêúÁ¥¢Áî®Êà∑ID„ÄÅÁî®Êà∑ÂêçÂíåÂßìÂêç</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card border-warning">
                                        <div class="card-body text-center">
                                            <i class="fas fa-object-group text-warning" style="font-size: 2rem;"></i>
                                            <h6 class="mt-2">Áæ§ÁªÑ‰ø°ÊÅØ</h6>
                                            <small class="text-muted">ÊêúÁ¥¢Áæ§ÁªÑIDÂíåÁæ§ÁªÑÂêçÁß∞</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="card border-secondary">
                                        <div class="card-body text-center">
                                            <i class="fas fa-comment-dots text-secondary" style="font-size: 2rem;"></i>
                                            <h6 class="mt-2">ÂØπËØùËÆ∞ÂΩï</h6>
                                            <small class="text-muted">ÊêúÁ¥¢ËßíËâ≤„ÄÅÈ¢ÑËÆæÂíåÊëòË¶Å</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÊêúÁ¥¢ÊäÄÂ∑ß -->
                    <div class="mt-4">
                        <h6 class="text-primary">ÊêúÁ¥¢ÁâπÊÄß</h6>
                        <div class="row justify-content-center">
                            <div class="col-md-8">
                                <div class="row">
                                    <div class="col-md-6">
                                        <ul class="list-unstyled text-start">
                                            <li><i class="fas fa-check-circle text-success"></i> ÂÖ®Â±ÄÊ®°Á≥äÊêúÁ¥¢Ôºå‰∏ÄÊ¨°ÊêúÁ¥¢ÊâÄÊúâÊï∞ÊçÆ</li>
                                            <li><i class="fas fa-check-circle text-success"></i> ÊêúÁ¥¢ÁªìÊûúÊåâÁ±ªÂûãÂàÜÁ±ªÂ±ïÁ§∫</li>
                                            <li><i class="fas fa-check-circle text-success"></i> ÊêúÁ¥¢ÁªìÊûú‰ºöÈ´ò‰∫ÆÊòæÁ§∫ÂÖ≥ÈîÆËØç</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <ul class="list-unstyled text-start">
                                            <li><i class="fas fa-check-circle text-success"></i> ÊØè‰∏™Á±ªÂûãÊúÄÂ§öÊòæÁ§∫50Êù°ÁªìÊûú</li>
                                            <li><i class="fas fa-check-circle text-success"></i> ÊîØÊåÅÊêúÁ¥¢Áî®Êà∑ID„ÄÅÁæ§ÁªÑIDÁ≠âÊï∞Â≠ó</li>
                                            <li><i class="fas fa-check-circle text-success"></i> ÂèØ‰ª•ÁÇπÂáªÁªìÊûúÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/search.js') }}"></script>
<script>
// Ëá™Âä®ËÅöÁÑ¶ÊêúÁ¥¢Ê°Ü
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchQuery');
    if (searchInput && !searchInput.value) {
        searchInput.focus();
    }
    
    // ÂàùÂßãÂåñÂç°ÁâáÊäòÂè†ÂäüËÉΩ
    initializeCardCollapse();
});

// ÂàùÂßãÂåñÂç°ÁâáÊäòÂè†ÂäüËÉΩ
function initializeCardCollapse() {
    // ‰∏∫ÊâÄÊúâÂç°ÁâáÂ§¥ÈÉ®Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
    document.querySelectorAll('.collapsible-card .card-header').forEach(header => {
        header.addEventListener('click', function(e) {
            // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊåâÈíÆÔºå‰∏çËß¶ÂèëÊäòÂè†
            if (e.target.closest('button')) {
                return;
            }
            
            const targetId = this.getAttribute('data-bs-target');
            if (targetId) {
                const targetElement = document.querySelector(targetId);
                const icon = this.querySelector('.collapse-icon');
                
                if (targetElement) {
                    if (targetElement.classList.contains('show')) {
                        targetElement.classList.remove('show');
                        if (icon) {
                            icon.style.transform = 'rotate(-90deg)';
                        }
                    } else {
                        targetElement.classList.add('show');
                        if (icon) {
                            icon.style.transform = 'rotate(0deg)';
                        }
                    }
                }
            }
        });
    });
    
    // ‰∏∫ÊäòÂè†ÊåâÈíÆÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
    document.querySelectorAll('.collapse-toggle').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const header = this.closest('.card-header');
            const targetId = header.getAttribute('data-bs-target');
            
            if (targetId) {
                const targetElement = document.querySelector(targetId);
                const icon = this.querySelector('.collapse-icon');
                
                if (targetElement) {
                    if (targetElement.classList.contains('show')) {
                        targetElement.classList.remove('show');
                        if (icon) {
                            icon.style.transform = 'rotate(-90deg)';
                        }
                    } else {
                        targetElement.classList.add('show');
                        if (icon) {
                            icon.style.transform = 'rotate(0deg)';
                        }
                    }
                }
            }
        });
    });
}

// ÊñáÊú¨Â±ïÂºÄ/Êî∂Ëµ∑ÂäüËÉΩ
function toggleText(button) {
    const container = button.closest('.collapsible-text');
    const preview = container.querySelector('.text-preview');
    const full = container.querySelector('.text-full');
    
    if (full.style.display === 'none' || full.style.display === '') {
        // Â±ïÂºÄ
        preview.style.display = 'none';
        full.style.display = 'block';
        button.textContent = 'Êî∂Ëµ∑';
        button.classList.add('expanded');
    } else {
        // Êî∂Ëµ∑
        preview.style.display = 'block';
        full.style.display = 'none';
        button.textContent = 'Â±ïÂºÄ';
        button.classList.remove('expanded');
    }
}

// Â§çÂà∂ËΩ¨ÂèëÊåá‰ª§ÂäüËÉΩ
function copyForwardCommand(targetId, msgId) {
    const command = `/fw ${targetId} ${msgId}`;
    
    // ‰ΩøÁî®Áé∞‰ª£ÁöÑ Clipboard API
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(command).then(function() {
            showToast('ËΩ¨ÂèëÊåá‰ª§Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø: ' + command, 'success');
        }).catch(function(err) {
            console.error('Â§çÂà∂Â§±Ë¥•:', err);
            fallbackCopyTextToClipboard(command);
        });
    } else {
        // ÈôçÁ∫ßÊñπÊ°à
        fallbackCopyTextToClipboard(command);
    }
}

// ÈôçÁ∫ßÂ§çÂà∂ÊñπÊ°à
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showToast('ËΩ¨ÂèëÊåá‰ª§Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø: ' + text, 'success');
        } else {
            showToast('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂: ' + text, 'error');
        }
    } catch (err) {
        console.error('Â§çÂà∂Â§±Ë¥•:', err);
        showToast('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂: ' + text, 'error');
    }
    
    document.body.removeChild(textArea);
}

// ÊòæÁ§∫ÊèêÁ§∫Ê∂àÊÅØ
function showToast(message, type = 'info') {
    // ÂàõÂª∫ÊèêÁ§∫ÂÖÉÁ¥†
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; opacity: 0; transition: opacity 0.3s;';
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // ÊòæÁ§∫Âä®Áîª
    setTimeout(() => {
        toast.style.opacity = '1';
    }, 10);
    
    // Ëá™Âä®ÈöêËóè
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
            if (toast.parentNode) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// Ë∑≥ËΩ¨Âà∞Áæ§ËÅäÊ∂àÊÅØÔºàËé∑ÂèñÊ≠£Á°ÆÁöÑÈ°µÁ†ÅÔºâ
function jumpToGroupMessage(groupId, msgId) {
    console.log('jumpToGroupMessage called with:', groupId, msgId);
    
    // Ë∞ÉÁî®APIËé∑ÂèñÊ∂àÊÅØÊâÄÂú®ÁöÑÈ°µÁ†Å
    fetch(`/api/message_page/${groupId}/${msgId}`)
        .then(response => {
            console.log('API response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('API response data:', data);
            if (data.error) {
                console.error('Ëé∑ÂèñÊ∂àÊÅØÈ°µÁ†ÅÂ§±Ë¥•:', data.error);
                // Â¶ÇÊûúAPIÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞ÂéüÊù•ÁöÑÊñπÊ≥ï
                const targetUrl = `{{ url_for('admin.group_dialogs', group_id='') }}${groupId}#msg-${msgId}`;
                console.log('Fallback URL:', targetUrl);
                window.location.href = targetUrl;
            } else {
                // Ë∑≥ËΩ¨Âà∞Ê≠£Á°ÆÁöÑÈ°µÈù¢ÔºåÂπ∂Âú®URL‰∏≠Ê∑ªÂä†ÁõÆÊ†áÊ∂àÊÅØID
                const targetUrl = `{{ url_for('admin.group_dialogs', group_id='') }}${groupId}?page=${data.page}#msg-${msgId}`;
                console.log('Target URL:', targetUrl);
                window.location.href = targetUrl;
            }
        })
        .catch(error => {
            console.error('APIËØ∑Ê±ÇÂ§±Ë¥•:', error);
            // Â¶ÇÊûúËØ∑Ê±ÇÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞ÂéüÊù•ÁöÑÊñπÊ≥ï
            const targetUrl = `{{ url_for('admin.group_dialogs', group_id='') }}${groupId}#msg-${msgId}`;
            console.log('Error fallback URL:', targetUrl);
            window.location.href = targetUrl;
        });
}
</script>
{% endblock %}