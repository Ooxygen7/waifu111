{% extends "admin_base.html" %}

{% block title %}å¯¹è¯è®°å½• - CyberWaifu Bot ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block page_title %}å¯¹è¯è®°å½•{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">å¯¹è¯è®°å½•</li>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-body">
        <div class="filter-container">
            <!-- æœç´¢æ¡† -->
            <div class="search-container">
                <form method="GET" class="search-form">
                    <div class="search-icon">ğŸ”</div>
                    <input type="text" name="search" value="{{ search }}" class="search-input" 
                           placeholder="æœç´¢ç”¨æˆ·åã€ç”¨æˆ·ID..." aria-label="æœç´¢å¯¹è¯">
                    {% if search %}
                    <a href="{{ url_for('conversations') }}" class="clear-button" aria-label="æ¸…é™¤æœç´¢">âœ•</a>
                    {% endif %}
                    <button type="submit" class="search-button" aria-label="æœç´¢">
                        <span class="search-button-text">æœç´¢</span>
                    </button>
                </form>
            </div>
            
            <!-- æ’åºé€‰é¡¹ -->
            <div class="sort-container">
                <div class="sort-dropdown">
                    <button class="filter-button" id="sortDropdown" onclick="toggleSortMenu()" aria-haspopup="true" aria-expanded="false">
                        <span class="filter-button-icon">â†•ï¸</span> æ’åºæ–¹å¼
                        <span class="dropdown-arrow">â–¼</span>
                    </button>
                    <div class="sort-menu" id="sortMenu" role="menu">
                        <a class="sort-item {% if sort_by == 'conv_id' %}active{% endif %}" 
                           href="{{ url_for('conversations', search=search, sort_by='conv_id', sort_order=next_sort_order('conv_id')) }}"
                           role="menuitem">
                           æŒ‰å¯¹è¯IDæ’åº {% if sort_by == 'conv_id' %}{{ 'â†‘' if sort_order == 'asc' else 'â†“' }}{% endif %}
                        </a>
                        <a class="sort-item {% if sort_by == 'user_id' %}active{% endif %}" 
                           href="{{ url_for('conversations', search=search, sort_by='user_id', sort_order=next_sort_order('user_id')) }}"
                           role="menuitem">
                           æŒ‰ç”¨æˆ·æ’åº {% if sort_by == 'user_id' %}{{ 'â†‘' if sort_order == 'asc' else 'â†“' }}{% endif %}
                        </a>
                        <a class="sort-item {% if sort_by == 'character' %}active{% endif %}" 
                           href="{{ url_for('conversations', search=search, sort_by='character', sort_order=next_sort_order('character')) }}"
                           role="menuitem">
                           æŒ‰è§’è‰²æ’åº {% if sort_by == 'character' %}{{ 'â†‘' if sort_order == 'asc' else 'â†“' }}{% endif %}
                        </a>
                        <a class="sort-item {% if sort_by == 'turns' %}active{% endif %}" 
                           href="{{ url_for('conversations', search=search, sort_by='turns', sort_order=next_sort_order('turns')) }}"
                           role="menuitem">
                           æŒ‰è½®æ¬¡æ’åº {% if sort_by == 'turns' %}{{ 'â†‘' if sort_order == 'asc' else 'â†“' }}{% endif %}
                        </a>
                        <a class="sort-item {% if sort_by == 'create_at' %}active{% endif %}" 
                           href="{{ url_for('conversations', search=search, sort_by='create_at', sort_order=next_sort_order('create_at')) }}"
                           role="menuitem">
                           æŒ‰åˆ›å»ºæ—¶é—´æ’åº {% if sort_by == 'create_at' %}{{ 'â†‘' if sort_order == 'asc' else 'â†“' }}{% endif %}
                        </a>
                        <a class="sort-item {% if sort_by == 'update_at' %}active{% endif %}" 
                           href="{{ url_for('conversations', search=search, sort_by='update_at', sort_order=next_sort_order('update_at')) }}"
                           role="menuitem">
                           æŒ‰æ›´æ–°æ—¶é—´æ’åº {% if sort_by == 'update_at' %}{{ 'â†‘' if sort_order == 'asc' else 'â†“' }}{% endif %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¯¹è¯åˆ—è¡¨ -->
<div class="card">
    <div class="card-header">
        <div class="conversation-list-header">
            <div class="conversation-list-title">
                <span class="conversation-list-title-icon">ğŸ’¬</span> å¯¹è¯åˆ—è¡¨
                {% if conversations %}
                <span class="conversation-count-badge">{{ conversations|length }} ä¸ªå¯¹è¯</span>
                {% endif %}
            </div>
            
            {% if search %}
            <div class="search-status">
                æœç´¢ç»“æœ: "<span class="search-term">{{ search }}</span>"
                <span class="search-result-count">{{ conversations|length }}</span>
                <a href="{{ url_for('conversations') }}" class="filter-tag">
                    æ¸…é™¤ç­›é€‰ <span class="filter-tag-close">âœ•</span>
                </a>
            </div>
            {% endif %}
            
            {% if conversations %}
            <div class="batch-actions">
                <div class="batch-select">
                    <input type="checkbox" id="selectAll" class="checkbox-input" aria-label="é€‰æ‹©æ‰€æœ‰å¯¹è¯">
                    <label for="selectAll" class="checkbox-label">å…¨é€‰</label>
                </div>
                <div class="selection-counter">å·²é€‰æ‹© 0 é¡¹</div>
                <button class="btn btn-sm btn-danger batch-action disabled" data-action="delete" disabled>
                    <i class="fas fa-trash-alt"></i> æ‰¹é‡åˆ é™¤
                </button>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="card-body">
        {% if conversations %}
        <div class="conversation-list">
            {% for conv in conversations %}
            <div class="conversation-card" data-id="{{ conv.conv_id }}">
                <div class="conversation-header">
                    <div class="conversation-select">
                        <input type="checkbox" id="conv-{{ conv.conv_id }}" class="item-checkbox checkbox-input" value="{{ conv.conv_id }}" aria-label="é€‰æ‹©å¯¹è¯ {{ conv.conv_id }}">
                        <label for="conv-{{ conv.conv_id }}" class="checkbox-label"></label>
                    </div>
                    
                    <div class="conversation-id">{{ conv.conv_id }}</div>
                    
                    {% if conv.character %}
                    <div class="character-badge">
                        <span class="character-badge-icon">ğŸ‘¤</span> {{ conv.character }}
                    </div>
                    {% endif %}
                    
                    <div class="turns-badge">
                        <span class="turns-badge-icon">ğŸ’¬</span> {{ conv.turns or 0 }} è½®å¯¹è¯
                    </div>
                    
                    <div class="conversation-time">
                        <span class="conversation-time-icon">ğŸ•’</span> 
                        åˆ›å»ºäº {{ conv.create_at|format_datetime if conv.create_at else 'æœªçŸ¥' }}
                        {% if conv.update_at and conv.update_at != conv.create_at %}
                        Â· æ›´æ–°äº {{ conv.update_at|format_datetime }}
                        {% endif %}
                    </div>
                </div>
                
                <div class="conversation-body">
                    <div class="conversation-user">
                        <div class="conversation-avatar">
                            {% if conv.first_name %}
                                {{ conv.first_name[0] | upper }}
                            {% else %}
                                ğŸ‘¤
                            {% endif %}
                        </div>
                        <div class="conversation-user-info">
                            <div class="conversation-user-name">{{ conv.first_name or conv.user_name or 'æœªçŸ¥ç”¨æˆ·' }}</div>
                            <div class="conversation-user-id">ID: {{ conv.user_id }}</div>
                        </div>
                    </div>
                    
                    <div class="conversation-details">
                        <div class="conversation-summary" data-id="{{ conv.conv_id }}">
                            {% if conv.summary %}
                            <div class="summary-content">{{ conv.summary }}</div>
                            {% else %}
                            <div class="conversation-summary-placeholder">æš‚æ— å¯¹è¯æ‘˜è¦</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="conversation-footer">
                    <div class="conversation-actions">
                        <a href="{{ url_for('dialogs', conv_id=conv.conv_id) }}" 
                           class="conversation-action-btn conversation-action-btn-primary" 
                           title="æŸ¥çœ‹å¯¹è¯è¯¦æƒ…">
                            <span class="conversation-action-btn-icon">ğŸ‘ï¸</span> æŸ¥çœ‹è¯¦æƒ…
                        </a>
                        <button class="conversation-action-btn" 
                                data-confirm="ç¡®å®šè¦åˆ é™¤æ­¤å¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚"
                                data-action="delete"
                                data-id="{{ conv.conv_id }}"
                                title="åˆ é™¤å¯¹è¯">
                            <span class="conversation-action-btn-icon">ğŸ—‘ï¸</span> åˆ é™¤
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- åˆ†é¡µ -->
        {% if total_pages > 1 %}
        <div class="pagination-container">
            <div class="pagination" role="navigation" aria-label="åˆ†é¡µå¯¼èˆª">
                {% if page > 1 %}
                <a class="page-item page-prev" href="{{ url_for('conversations', page=page-1, search=search, sort_by=sort_by, sort_order=sort_order) }}" aria-label="ä¸Šä¸€é¡µ">
                    &laquo;
                </a>
                {% endif %}
                
                {% if page > 3 %}
                <a class="page-item" href="{{ url_for('conversations', page=1, search=search, sort_by=sort_by, sort_order=sort_order) }}" aria-label="ç¬¬1é¡µ">1</a>
                
                {% if page > 4 %}
                <span class="page-ellipsis" aria-hidden="true">...</span>
                {% endif %}
                {% endif %}
                
                {% for p in range(max(1, page-2), min(total_pages+1, page+3)) %}
                <a class="page-item {% if p == page %}active{% endif %}" 
                   href="{{ url_for('conversations', page=p, search=search, sort_by=sort_by, sort_order=sort_order) }}"
                   aria-label="ç¬¬{{ p }}é¡µ" 
                   {% if p == page %}aria-current="page"{% endif %}>
                    {{ p }}
                </a>
                {% endfor %}
                
                {% if page < total_pages - 2 %}
                {% if page < total_pages - 3 %}
                <span class="page-ellipsis" aria-hidden="true">...</span>
                {% endif %}
                
                <a class="page-item" href="{{ url_for('conversations', page=total_pages, search=search, sort_by=sort_by, sort_order=sort_order) }}" aria-label="ç¬¬{{ total_pages }}é¡µ">{{ total_pages }}</a>
                {% endif %}
                
                {% if page < total_pages %}
                <a class="page-item page-next" href="{{ url_for('conversations', page=page+1, search=search, sort_by=sort_by, sort_order=sort_order) }}" aria-label="ä¸‹ä¸€é¡µ">
                    &raquo;
                </a>
                {% endif %}
            </div>
            
            <div class="page-info">
                ç¬¬ {{ page }} é¡µï¼Œå…± {{ total_pages }} é¡µ
            </div>
        </div>
        {% endif %}
        
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ğŸ’¬</div>
            <h5 class="empty-title">æš‚æ— å¯¹è¯è®°å½•</h5>
            {% if search %}
            <p class="empty-text">æ²¡æœ‰æ‰¾åˆ°åŒ¹é… "<span class="search-term">{{ search }}</span>" çš„å¯¹è¯</p>
            <a href="{{ url_for('conversations') }}" class="empty-btn">
                <span class="empty-btn-icon">ğŸ”„</span> æ¸…é™¤æœç´¢
            </a>
            {% else %}
            <p class="empty-text">ç³»ç»Ÿä¸­è¿˜æ²¡æœ‰ä»»ä½•å¯¹è¯è®°å½•</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- ç»Ÿè®¡ä¿¡æ¯ -->
{% if conversations %}
<div class="stats-container">
    <div class="stats-card">
        <div class="stats-grid">
            <div class="stat-item">
                <h5 class="stat-value primary">{{ conversations|length }}</h5>
                <small class="stat-label">å½“å‰é¡µå¯¹è¯æ•°</small>
            </div>
            <div class="stat-item">
                <h5 class="stat-value success">{{ conversations|map(attribute='turns')|select('number')|sum or 0 }}</h5>
                <small class="stat-label">å½“å‰é¡µæ€»è½®æ¬¡</small>
            </div>
            <div class="stat-item">
                <h5 class="stat-value info">{{ conversations|selectattr('character')|list|length }}</h5>
                <small class="stat-label">å·²è®¾ç½®è§’è‰²çš„å¯¹è¯</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
<div class="modal" id="deleteModal" role="dialog" aria-labelledby="deleteModalTitle" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalTitle">ç¡®è®¤åˆ é™¤</h5>
                <button type="button" class="modal-close" aria-label="å…³é—­" data-dismiss="modal">
                    <span aria-hidden="true">Ã—</span>
                </button>
            </div>
            <div class="modal-body">
                <p>æ‚¨ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">åˆ é™¤</button>
            </div>
        </div>
    </div>
</div>

<!-- æ‰¹é‡åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
<div class="modal" id="batchDeleteModal" role="dialog" aria-labelledby="batchDeleteModalTitle" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchDeleteModalTitle">ç¡®è®¤æ‰¹é‡åˆ é™¤</h5>
                <button type="button" class="modal-close" aria-label="å…³é—­" data-dismiss="modal">
                    <span aria-hidden="true">Ã—</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>æ‚¨ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ <span class="batch-count">0</span> ä¸ªå¯¹è¯å—ï¼Ÿ</p>
                    <p class="mt-2"><strong>è­¦å‘Šï¼š</strong> æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œåˆ é™¤åæ•°æ®å°†æ— æ³•æ¢å¤ã€‚</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" id="confirmBatchDelete">
                    <i class="fas fa-trash-alt"></i> ç¡®è®¤åˆ é™¤
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/conversation.js') }}"></script>
<script src="{{ url_for('static', filename='js/conversation-search.js') }}"></script>
<script src="{{ url_for('static', filename='js/sorting.js') }}"></script>
<script src="{{ url_for('static', filename='js/modal-dialog.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin-conversation.js') }}"></script>
<script>
    // æ’åºèœå•åˆ‡æ¢å‡½æ•°
    function toggleSortMenu() {
        const menu = document.getElementById('sortMenu');
        const button = document.getElementById('sortDropdown');
        const isExpanded = menu.classList.toggle('show');
        button.setAttribute('aria-expanded', isExpanded);
        
        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
        if(isExpanded) {
            menu.classList.add('animate-dropdown');
        }
    }
</script>
{% endblock %}