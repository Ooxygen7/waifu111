{% extends "admin_base.html" %}

{% block title %}对话记录 - CyberWaifu Bot 管理系统{% endblock %}

{% block page_title %}对话记录{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">对话记录</li>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-body">
        <div class="filter-container">
            <!-- 搜索框 -->
            <div class="search-container">
                <form method="GET" class="search-form">
                    <div class="search-icon">🔍</div>
                    <input type="text" name="search" value="{{ search }}" class="search-input" 
                           placeholder="搜索用户名、用户ID..." aria-label="搜索对话">
                    {% if search %}
                    <a href="{{ url_for('conversations') }}" class="clear-button" aria-label="清除搜索">✕</a>
                    {% endif %}
                    <button type="submit" class="search-button" aria-label="搜索">
                        <span class="search-button-text">搜索</span>
                    </button>
                </form>
            </div>
            
            <!-- 排序选项 -->
            <div class="sort-container">
                <div class="sort-dropdown">
                    <button class="filter-button" id="sortDropdown" onclick="toggleSortMenu()" aria-haspopup="true" aria-expanded="false">
                        <span class="filter-button-icon">↕️</span> 排序方式
                        <span class="dropdown-arrow">▼</span>
                    </button>
                    <div class="sort-menu" id="sortMenu" role="menu">
                        <a class="sort-item {% if sort_by == 'conv_id' %}active{% endif %}" 
                           href="{{ url_for('conversations', search=search, sort_by='conv_id', sort_order=next_sort_order('conv_id')) }}"
                           role="menuitem">
                           按对话ID排序 {% if sort_by == 'conv_id' %}{{ '↑' if sort_order == 'asc' else '↓' }}{% endif %}
                        </a>
                        <a class="sort-item {% if sort_by == 'user_id' %}active{% endif %}" 
                           href="{{ url_for('conversations', search=search, sort_by='user_id', sort_order=next_sort_order('user_id')) }}"
                           role="menuitem">
                           按用户排序 {% if sort_by == 'user_id' %}{{ '↑' if sort_order == 'asc' else '↓' }}{% endif %}
                        </a>
                        <a class="sort-item {% if sort_by == 'character' %}active{% endif %}" 
                           href="{{ url_for('conversations', search=search, sort_by='character', sort_order=next_sort_order('character')) }}"
                           role="menuitem">
                           按角色排序 {% if sort_by == 'character' %}{{ '↑' if sort_order == 'asc' else '↓' }}{% endif %}
                        </a>
                        <a class="sort-item {% if sort_by == 'turns' %}active{% endif %}" 
                           href="{{ url_for('conversations', search=search, sort_by='turns', sort_order=next_sort_order('turns')) }}"
                           role="menuitem">
                           按轮次排序 {% if sort_by == 'turns' %}{{ '↑' if sort_order == 'asc' else '↓' }}{% endif %}
                        </a>
                        <a class="sort-item {% if sort_by == 'create_at' %}active{% endif %}" 
                           href="{{ url_for('conversations', search=search, sort_by='create_at', sort_order=next_sort_order('create_at')) }}"
                           role="menuitem">
                           按创建时间排序 {% if sort_by == 'create_at' %}{{ '↑' if sort_order == 'asc' else '↓' }}{% endif %}
                        </a>
                        <a class="sort-item {% if sort_by == 'update_at' %}active{% endif %}" 
                           href="{{ url_for('conversations', search=search, sort_by='update_at', sort_order=next_sort_order('update_at')) }}"
                           role="menuitem">
                           按更新时间排序 {% if sort_by == 'update_at' %}{{ '↑' if sort_order == 'asc' else '↓' }}{% endif %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 对话列表 -->
<div class="card">
    <div class="card-header">
        <div class="conversation-list-header">
            <div class="conversation-list-title">
                <span class="conversation-list-title-icon">💬</span> 对话列表
                {% if conversations %}
                <span class="conversation-count-badge">{{ conversations|length }} 个对话</span>
                {% endif %}
            </div>
            
            {% if search %}
            <div class="search-status">
                搜索结果: "<span class="search-term">{{ search }}</span>"
                <span class="search-result-count">{{ conversations|length }}</span>
                <a href="{{ url_for('conversations') }}" class="filter-tag">
                    清除筛选 <span class="filter-tag-close">✕</span>
                </a>
            </div>
            {% endif %}
            
            {% if conversations %}
            <div class="batch-actions">
                <div class="batch-select">
                    <input type="checkbox" id="selectAll" class="checkbox-input" aria-label="选择所有对话">
                    <label for="selectAll" class="checkbox-label">全选</label>
                </div>
                <div class="selection-counter">已选择 0 项</div>
                <button class="btn btn-sm btn-danger batch-action disabled" data-action="delete" disabled>
                    <i class="fas fa-trash-alt"></i> 批量删除
                </button>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="card-body">
        {% if conversations %}
        <div class="conversation-list">
            {% for conv in conversations %}
            <div class="conversation-card" data-id="{{ conv.conv_id }}">
                <div class="conversation-header">
                    <div class="conversation-select">
                        <input type="checkbox" id="conv-{{ conv.conv_id }}" class="item-checkbox checkbox-input" value="{{ conv.conv_id }}" aria-label="选择对话 {{ conv.conv_id }}">
                        <label for="conv-{{ conv.conv_id }}" class="checkbox-label"></label>
                    </div>
                    
                    <div class="conversation-id">{{ conv.conv_id }}</div>
                    
                    {% if conv.character %}
                    <div class="character-badge">
                        <span class="character-badge-icon">👤</span> {{ conv.character }}
                    </div>
                    {% endif %}
                    
                    <div class="turns-badge">
                        <span class="turns-badge-icon">💬</span> {{ conv.turns or 0 }} 轮对话
                    </div>
                    
                    <div class="conversation-time">
                        <span class="conversation-time-icon">🕒</span> 
                        创建于 {{ conv.create_at|format_datetime if conv.create_at else '未知' }}
                        {% if conv.update_at and conv.update_at != conv.create_at %}
                        · 更新于 {{ conv.update_at|format_datetime }}
                        {% endif %}
                    </div>
                </div>
                
                <div class="conversation-body">
                    <div class="conversation-user">
                        <div class="conversation-avatar">
                            {% if conv.first_name %}
                                {{ conv.first_name[0] | upper }}
                            {% else %}
                                👤
                            {% endif %}
                        </div>
                        <div class="conversation-user-info">
                            <div class="conversation-user-name">{{ conv.first_name or conv.user_name or '未知用户' }}</div>
                            <div class="conversation-user-id">ID: {{ conv.user_id }}</div>
                        </div>
                    </div>
                    
                    <div class="conversation-details">
                        <div class="conversation-summary" data-id="{{ conv.conv_id }}">
                            {% if conv.summary %}
                            <div class="summary-content">{{ conv.summary }}</div>
                            {% else %}
                            <div class="conversation-summary-placeholder">暂无对话摘要</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="conversation-footer">
                    <div class="conversation-actions">
                        <a href="{{ url_for('dialogs', conv_id=conv.conv_id) }}" 
                           class="conversation-action-btn conversation-action-btn-primary" 
                           title="查看对话详情">
                            <span class="conversation-action-btn-icon">👁️</span> 查看详情
                        </a>
                        <button class="conversation-action-btn" 
                                data-confirm="确定要删除此对话吗？此操作不可撤销。"
                                data-action="delete"
                                data-id="{{ conv.conv_id }}"
                                title="删除对话">
                            <span class="conversation-action-btn-icon">🗑️</span> 删除
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- 分页 -->
        {% if total_pages > 1 %}
        <div class="pagination-container">
            <div class="pagination" role="navigation" aria-label="分页导航">
                {% if page > 1 %}
                <a class="page-item page-prev" href="{{ url_for('conversations', page=page-1, search=search, sort_by=sort_by, sort_order=sort_order) }}" aria-label="上一页">
                    &laquo;
                </a>
                {% endif %}
                
                {% if page > 3 %}
                <a class="page-item" href="{{ url_for('conversations', page=1, search=search, sort_by=sort_by, sort_order=sort_order) }}" aria-label="第1页">1</a>
                
                {% if page > 4 %}
                <span class="page-ellipsis" aria-hidden="true">...</span>
                {% endif %}
                {% endif %}
                
                {% for p in range(max(1, page-2), min(total_pages+1, page+3)) %}
                <a class="page-item {% if p == page %}active{% endif %}" 
                   href="{{ url_for('conversations', page=p, search=search, sort_by=sort_by, sort_order=sort_order) }}"
                   aria-label="第{{ p }}页" 
                   {% if p == page %}aria-current="page"{% endif %}>
                    {{ p }}
                </a>
                {% endfor %}
                
                {% if page < total_pages - 2 %}
                {% if page < total_pages - 3 %}
                <span class="page-ellipsis" aria-hidden="true">...</span>
                {% endif %}
                
                <a class="page-item" href="{{ url_for('conversations', page=total_pages, search=search, sort_by=sort_by, sort_order=sort_order) }}" aria-label="第{{ total_pages }}页">{{ total_pages }}</a>
                {% endif %}
                
                {% if page < total_pages %}
                <a class="page-item page-next" href="{{ url_for('conversations', page=page+1, search=search, sort_by=sort_by, sort_order=sort_order) }}" aria-label="下一页">
                    &raquo;
                </a>
                {% endif %}
            </div>
            
            <div class="page-info">
                第 {{ page }} 页，共 {{ total_pages }} 页
            </div>
        </div>
        {% endif %}
        
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">💬</div>
            <h5 class="empty-title">暂无对话记录</h5>
            {% if search %}
            <p class="empty-text">没有找到匹配 "<span class="search-term">{{ search }}</span>" 的对话</p>
            <a href="{{ url_for('conversations') }}" class="empty-btn">
                <span class="empty-btn-icon">🔄</span> 清除搜索
            </a>
            {% else %}
            <p class="empty-text">系统中还没有任何对话记录</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- 统计信息 -->
{% if conversations %}
<div class="stats-container">
    <div class="stats-card">
        <div class="stats-grid">
            <div class="stat-item">
                <h5 class="stat-value primary">{{ conversations|length }}</h5>
                <small class="stat-label">当前页对话数</small>
            </div>
            <div class="stat-item">
                <h5 class="stat-value success">{{ conversations|map(attribute='turns')|select('number')|sum or 0 }}</h5>
                <small class="stat-label">当前页总轮次</small>
            </div>
            <div class="stat-item">
                <h5 class="stat-value info">{{ conversations|selectattr('character')|list|length }}</h5>
                <small class="stat-label">已设置角色的对话</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 删除确认模态框 -->
<div class="modal" id="deleteModal" role="dialog" aria-labelledby="deleteModalTitle" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalTitle">确认删除</h5>
                <button type="button" class="modal-close" aria-label="关闭" data-dismiss="modal">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <p>您确定要删除这个对话吗？此操作不可撤销。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">删除</button>
            </div>
        </div>
    </div>
</div>

<!-- 批量删除确认模态框 -->
<div class="modal" id="batchDeleteModal" role="dialog" aria-labelledby="batchDeleteModalTitle" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchDeleteModalTitle">确认批量删除</h5>
                <button type="button" class="modal-close" aria-label="关闭" data-dismiss="modal">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>您确定要删除选中的 <span class="batch-count">0</span> 个对话吗？</p>
                    <p class="mt-2"><strong>警告：</strong> 此操作不可撤销，删除后数据将无法恢复。</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmBatchDelete">
                    <i class="fas fa-trash-alt"></i> 确认删除
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/conversation.js') }}"></script>
<script src="{{ url_for('static', filename='js/conversation-search.js') }}"></script>
<script src="{{ url_for('static', filename='js/sorting.js') }}"></script>
<script src="{{ url_for('static', filename='js/modal-dialog.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin-conversation.js') }}"></script>
<script>
    // 排序菜单切换函数
    function toggleSortMenu() {
        const menu = document.getElementById('sortMenu');
        const button = document.getElementById('sortDropdown');
        const isExpanded = menu.classList.toggle('show');
        button.setAttribute('aria-expanded', isExpanded);
        
        // 添加动画效果
        if(isExpanded) {
            menu.classList.add('animate-dropdown');
        }
    }
</script>
{% endblock %}