{% extends "base.html" %}
{% set page_has_custom_scripts = true %}

{% block title %}群组对话 - CyberWaifu Bot 后台管理系统{% endblock %}

{% block page_title %}
群组对话
<small class="text-muted">群组ID: {{ group.group_id }}</small>
{% endblock %}

{% block content %}
<body data-group-id="{{ group.group_id }}">
<div class="content-wrapper dialogs-page">
    <!-- 群组信息卡片 (可折叠) -->
    <div class="glass-card collapsible-card" id="groupDetailsCard">
        <div class="card-header collapsible-header">
            <div class="header-title">
                <i class="fas fa-info-circle header-icon"></i>
                <h3 class="card-title-text">群组信息</h3>
                <span class="header-subtitle text-muted">ID: {{ group.group_id }}</span>
            </div>
            <div class="header-actions">
                <a href="{{ url_for('admin.groups') }}" class="btn btn-glass btn-sm header-action-btn" title="返回群组列表">
                    <i class="fas fa-arrow-left"></i> <span>返回</span>
                </a>
                <button class="btn btn-glass btn-sm btn-icon" id="toggleDetailsBtn" title="折叠/展开">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="card-body collapsible-content">
            <div class="details-grid">
                <div class="detail-item"><span class="detail-label"><i class="fas fa-users fa-fw"></i> 群组名称</span> <span>{{ group.group_name or '未命名群组' }}</span></div>
                <div class="detail-item"><span class="detail-label"><i class="fas fa-check-circle fa-fw"></i> 状态</span>
                    {% if group.active %}
                        <span class="badge success">活跃</span>
                    {% else %}
                        <span class="badge danger">非活跃</span>
                    {% endif %}
                </div>
                <div class="detail-item"><span class="detail-label"><i class="fas fa-user-tag fa-fw"></i> 角色</span>
                    {% if group.char %}
                        <span class="badge info">{{ group.char }}</span>
                    {% else %}
                        <span class="text-muted">未设置</span>
                    {% endif %}
                </div>
                <div class="detail-item"><span class="detail-label"><i class="fas fa-cogs fa-fw"></i> 预设</span>
                    {% if group.preset %}
                        <span class="badge warning">{{ group.preset }}</span>
                    {% else %}
                        <span class="text-muted">未设置</span>
                    {% endif %}
                </div>
                <div class="detail-item"><span class="detail-label"><i class="fas fa-chart-line fa-fw"></i> 调用次数</span> <span class="badge success">{{ group.call_count or 0 }}</span></div>
                <div class="detail-item"><span class="detail-label"><i class="fas fa-percentage fa-fw"></i> 触发几率</span>
                    {% if group.rate %}
                        <span class="badge primary">{{ "%.2f"|format(group.rate) }}</span>
                    {% else %}
                        <span class="text-muted">未设置</span>
                    {% endif %}
                </div>
                <div class="detail-item"><span class="detail-label"><i class="fas fa-sign-in-alt fa-fw"></i> 输入Token</span> <span class="badge primary">{{ "{:,}".format(group.input_token or 0) }}</span></div>
                <div class="detail-item"><span class="detail-label"><i class="fas fa-sign-out-alt fa-fw"></i> 输出Token</span> <span class="badge success">{{ "{:,}".format(group.output_token or 0) }}</span></div>
                <div class="detail-item full-width"><span class="detail-label"><i class="far fa-calendar-plus fa-fw"></i> 创建时间</span> <span class="text-muted">{{ group.create_at or '未知' }}</span></div>
                <div class="detail-item full-width"><span class="detail-label"><i class="far fa-calendar-check fa-fw"></i> 更新时间</span> <span class="text-muted">{{ group.update_time or '未知' }}</span></div>
            </div>
        </div>
    </div>

    {% if dialogs %}
    <!-- 对话内容 -->
    <div class="glass-card chat-history-card">
        <div class="card-header">
            <div class="header-title">
                <i class="fas fa-comments header-icon"></i>
                <h3 class="card-title-text">
                    对话记录
                    {% if search %}
                        <span class="header-subtitle">(搜索结果: {{ dialogs|length }} 条)</span>
                        <span class="search-keyword-display">关键词: "{{ search }}"</span>
                    {% else %}
                        <span class="header-subtitle">(共 {{ dialogs|length }} 条)</span>
                    {% endif %}
                </h3>
            </div>
            <div class="header-actions">
                <form method="GET" class="search-form">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" name="search" class="search-input" placeholder="搜索消息..."
                               value="{{ search or '' }}" aria-label="搜索消息内容">
                        {% if search %}
                        <a href="{{ url_for('admin.group_dialogs', group_id=group.group_id) }}" class="clear-button"
                           title="清除搜索">
                            <i class="fas fa-times"></i>
                        </a>
                        {% endif %}
                    </div>
                    <button type="submit" class="btn btn-glass btn-primary btn-sm">
                        <i class="fas fa-search"></i> <span>搜索</span>
                    </button>
                </form>
            </div>
        </div>
        <div class="card-body">
            {% if search and dialogs %}
            <div class="search-notice">
                <i class="fas fa-info-circle"></i>
                点击任意搜索结果可跳转到完整对话页面查看上下文
            </div>
            {% endif %}
            <div class="message-list" id="messageList">
                {% for dialog in dialogs %}
                <!-- 用户消息 -->
                <div class="message-bubble-container user-message"
                     id="msg-{{ dialog.msg_id }}"
                     data-dialog-id="{{ dialog.msg_id }}"
                     data-raw-content="{{ dialog.msg_text | e }}"
                     data-processed-content="{{ dialog.msg_text | e }}"
                     data-turn="{{ loop.index }}"
                     data-time="{{ format_datetime(dialog.create_at) }}"
                     data-msg-id="{{ dialog.msg_id or '' }}"
                     data-role="user"
                     data-user-name="{{ dialog.msg_user_name or '未知用户' }}"
                     data-original-page="{{ dialog.original_page or 1 }}">
                    <div class="message-row user-message">
                        <div class="message-bubble user-bubble" tabindex="0" aria-label="用户消息，轮次 {{ loop.index }}">
                            <div class="sender-name">{{ dialog.msg_user_name or '未知用户' }}</div>
                            <div class="message-content">
                                {{ dialog.msg_text | replace('\n', '<br>') | highlight_search_keyword(search) | safe }}
                            </div>
                            <div class="message-time">
                                <i class="fas fa-clock fa-xs"></i> {{ format_datetime(dialog.create_at) }}
                            </div>
                            {% if session.user_role == 'admin' %}
                            <button class="forward-btn" title="复制转发命令" aria-label="复制转发命令">
                                <i class="fas fa-share"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if dialog.trigger_type and dialog.processed_response %}
                <!-- AI回复消息 -->
                <div class="message-bubble-container ai-message"
                     id="msg-ai-{{ dialog.msg_id }}"
                     data-dialog-id="{{ dialog.msg_id }}"
                     data-raw-content="{{ dialog.raw_response | e }}"
                     data-processed-content="{{ dialog.processed_response | e }}"
                     data-turn="{{ loop.index }}"
                     data-time="{{ format_datetime(dialog.create_at) }}"
                     data-msg-id="{{ dialog.msg_id or '' }}"
                     data-role="AI"
                     data-user-name="AI助手"
                     data-original-page="{{ dialog.original_page or 1 }}">
                    <div class="message-row ai-message">
                        <div class="message-bubble ai-bubble" tabindex="0" aria-label="AI消息，轮次 {{ loop.index }}">
                            <div class="sender-name">AI助手</div>
                            <div class="message-content">
                                {{ dialog.processed_response | replace('\n', '<br>') | highlight_search_keyword(search) | safe }}
                            </div>
                            <div class="message-time">
                                <i class="fas fa-clock fa-xs"></i> {{ format_datetime(dialog.create_at) }}
                            </div>
                             {% if session.user_role == 'admin' %}
                             <button class="forward-btn" title="复制转发命令" aria-label="复制转发命令">
                                <i class="fas fa-share"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% if total_pages > 1 %}
    <div class="pagination-wrapper">
        <div class="pagination-info">
            第 {{ page }} 页 / 共 {{ total_pages }} 页
        </div>
        <div class="pagination-controls">
            {% if page > 1 %}
            <a href="{{ url_for('admin.group_dialogs', group_id=group.group_id, page=1, search=search) }}" class="btn btn-glass pagination-btn" title="第一页"><i class="fas fa-angle-double-left"></i></a>
            <a href="{{ url_for('admin.group_dialogs', group_id=group.group_id, page=page-1, search=search) }}" class="btn btn-glass pagination-btn" title="上一页"><i class="fas fa-angle-left"></i></a>
            {% endif %}

            {% for p in range(max(1, page-2), min(total_pages+1, page+3)) %}
            <a href="{{ url_for('admin.group_dialogs', group_id=group.group_id, page=p, search=search) }}" class="btn btn-glass pagination-number {{ 'active' if p == page else '' }}">{{ p }}</a>
            {% endfor %}

            {% if page < total_pages %}
            <a href="{{ url_for('admin.group_dialogs', group_id=group.group_id, page=page+1, search=search) }}" class="btn btn-glass pagination-btn" title="下一页"><i class="fas fa-angle-right"></i></a>
            <a href="{{ url_for('admin.group_dialogs', group_id=group.group_id, page=total_pages, search=search) }}" class="btn btn-glass pagination-btn" title="最后一页"><i class="fas fa-angle-double-right"></i></a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- 空状态显示 -->
    <div class="empty-state">
        <div class="empty-content">
            <i class="fas fa-comments empty-icon"></i>
            <h5 class="empty-title">暂无对话记录</h5>
            {% if search %}
            <p class="empty-message">没有找到匹配 "{{ search }}" 的对话内容</p>
            <a href="{{ url_for('admin.group_dialogs', group_id=group.group_id) }}" class="clear-search-button">清除搜索</a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- 消息详情模态框 -->
</div>
<!-- 消息详情模态框 -->
<div class="modal-overlay" id="messageDetailModal" aria-hidden="true">
    <div class="modal-container" role="dialog" aria-labelledby="messageDetailModalLabel" aria-modal="true">
        <div class="modal-header">
            <h2 class="modal-title" id="messageDetailModalLabel">
                <i class="fas fa-info-circle"></i> 消息详情
            </h2>
            <button class="modal-close" aria-label="关闭模态框">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="detail-card">
                <div class="message-meta-container collapsible-card collapsed" id="modalMetaCard">
                    <div class="meta-header collapsible-header">
                        <h3 class="section-title"><i class="fas fa-info-circle"></i> 消息元数据</h3>
                        <button class="btn btn-glass btn-sm btn-icon" title="折叠/展开"><i class="fas fa-chevron-up"></i></button>
                    </div>
                    <div class="message-meta collapsible-content">
                        <div class="meta-item"><span class="meta-label">发送者:</span> <span class="meta-value" id="modal-sender"></span></div>
                        <div class="meta-item"><span class="meta-label">角色:</span> <span class="meta-value" id="modal-role"></span></div>
                        <div class="meta-item"><span class="meta-label">轮次:</span> <span class="meta-value" id="modal-turn"></span></div>
                        <div class="meta-item"><span class="meta-label">时间:</span> <span class="meta-value" id="modal-time"></span></div>
                        <div class="meta-item"><span class="meta-label">消息ID:</span> <span class="meta-value" id="modal-msg-id"></span></div>
                    </div>
                </div>
                <div class="detail-section">
                    <h3 class="section-title"><i class="fas fa-code"></i> 原始内容</h3>
                    <div class="content-display raw-content" id="modal-raw-content"></div>
                </div>
                <div class="detail-section">
                    <h3 class="section-title"><i class="fas fa-cogs"></i> 处理后内容</h3>
                    <div class="content-display processed-content" id="modal-processed-content"></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
                <button class="btn btn-glass modal-close-btn">
                <i class="fas fa-times"></i>
                <span>关闭</span>
            </button>
        </div>
    </div>
</div>
</body>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_glass.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/group_dialogs.css') }}">
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/group_dialogs.js') }}" defer></script>
{% endblock %}