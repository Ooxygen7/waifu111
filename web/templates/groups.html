{% extends "base.html" %}

{% block title %}Áæ§ÁªÑÁÆ°ÁêÜ - CyberWaifu Bot ÂêéÂè∞ÁÆ°ÁêÜÁ≥ªÁªü{% endblock %}

{% block page_title %}Áæ§ÁªÑÁÆ°ÁêÜ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_glass.css') }}">
{% endblock %}

{% block content %}
<div class="content-wrapper users-page page-groups">
    <div class="card">
        <div class="card-header">
            <div class="header-container">
                <div class="header-title">
                    <h3><i class="icon">üë•</i> Áæ§ÁªÑÁÆ°ÁêÜ</h3>
                </div>
                <div class="search-container">
                    <form method="GET" action="{{ url_for('admin.groups') }}" class="search-form">
                        <div class="search-input-wrapper">
                            <div class="search-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </div>
                            <input type="text" name="search" class="search-input" placeholder="ÊêúÁ¥¢Áæ§ÁªÑÂêçÁß∞..."
                                value="{{ search_term or '' }}" aria-label="ÊêúÁ¥¢Áæ§ÁªÑ">
                            {% if search_term %}
                            <a href="{{ url_for('admin.groups') }}" class="clear-button" aria-label="Ê∏ÖÈô§ÊêúÁ¥¢">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </a>
                            {% endif %}
                        </div>
                        <button type="submit" class="btn-glass" aria-label="ÊêúÁ¥¢">
                            <span>ÊêúÁ¥¢</span>
                        </button>
                    </form>
                    {% if search_term %}
                    <div class="search-status">
                        <span>ÊâæÂà∞‰∏é "<strong>{{ search_term }}</strong>" Áõ∏ÂÖ≥ÁöÑÁªìÊûú</span>
                        <a href="{{ url_for('admin.groups') }}" class="clear-search-link">Ê∏ÖÈô§ÊêúÁ¥¢</a>
                    </div>
                    {% endif %}
                </div>
            </div>

        </div>
        <div class="card-body">
            {% if groups %}
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <!-- Hidden Group ID Column -->
                            <th class="sortable" data-sort="text">
                                <a href="{{ url_for('admin.groups', search=search_term, sort_by='group_name', sort_order=next_sort_order('group_name')) }}"
                                    class="sort-link"><span>Áæ§ÁªÑÂêçÁß∞</span><span class="sort-indicator"></span></a>
                            </th>
                            <th class="sortable" data-sort="number">
                                <a href="{{ url_for('admin.groups', search=search_term, sort_by='call_count', sort_order=next_sort_order('call_count')) }}"
                                    class="sort-link"><span>Ë∞ÉÁî®Ê¨°Êï∞</span><span class="sort-indicator"></span></a>
                            </th>
                            <th>ËßíËâ≤/API</th>
                            <th class="sortable" data-sort="number">
                                <a href="{{ url_for('admin.groups', search=search_term, sort_by='rate', sort_order=next_sort_order('rate')) }}"
                                    class="sort-link"><span>Ëß¶ÂèëÂá†Áéá</span><span class="sort-indicator"></span></a>
                            </th>
                            <th>Token‰ΩøÁî®</th>
                            <th class="sortable" data-sort="date">
                                <a href="{{ url_for('admin.groups', search=search_term, sort_by='update_time', sort_order=next_sort_order('update_time')) }}"
                                    class="sort-link"><span>Êõ¥Êñ∞Êó∂Èó¥</span><span class="sort-indicator"></span></a>
                            </th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for group in groups %}
                        <tr class="table-row-interactive" data-group-id="{{ group.group_id }}">
                            <td>
                                <div class="user-info">
                                    <div class="user-avatar">
                                        <div class="avatar-image">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                                <circle cx="12" cy="7" r="4"></circle>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="user-details">
                                        <span class="user-name">{{ group.group_name or 'Êú™ÂëΩÂêçÁæ§ÁªÑ' }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div>{{ "{:,}".format(group.call_count or 0) }} Ê¨°</div>
                            </td>
                            <td>
                                <div class="stacked-badges">
                                    <span>{{ group.char or 'Êú™ËÆæÁΩÆ' }}</span>
                                    <span>{{ group.api or 'ÈªòËÆ§' }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="rate-indicator">
                                    <div class="rate-bar">
                                        <div class="rate-fill" style="width: {{ (group.rate or 0) * 100 }}%"></div>
                                    </div>
                                    <span class="rate-text">{{ "%.1f"|format((group.rate or 0) * 100) }}%</span>
                                </div>
                            </td>
                            <td>
                                <div class="token-stats">
                                    <div class="token-item">
                                        <span class="token-label">ËæìÂÖ•</span>
                                        <span class="token-value text-primary">{{ "{:,}".format(group.input_token or 0)
                                            }}</span>
                                    </div>
                                    <div class="token-item">
                                        <span class="token-label">ËæìÂá∫</span>
                                        <span class="token-value text-success">{{ "{:,}".format(group.output_token or 0)
                                            }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="date-info">
                                    <span class="date-value">{{ format_datetime(group.update_time).split(' ')[0]
                                        }}</span>
                                    <span class="date-time text-muted">{{ format_datetime(group.update_time).split('
                                        ')[1] }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button type="button" class="btn-glass view-group-btn" title="Êü•ÁúãËØ¶ÊÉÖ"
                                        data-group-id="{{ group.group_id }}">
                                        <span>‚ÑπÔ∏è</span>
                                    </button>
                                    <button type="button" class="btn-glass edit-group-btn" title="ÁºñËæëÁæ§ÁªÑ"
                                        data-group-id="{{ group.group_id }}">
                                        <span>‚úèÔ∏è</span>
                                    </button>
                                    <a href="{{ url_for('admin.group_dialogs', group_id=group.group_id) }}"
                                        class="btn-glass" title="Êü•ÁúãÂØπËØù">
                                        <span>üí¨</span>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if total_pages > 1 %}
            <div class="pagination-wrapper">
                <div class="pagination-info">
                    <span class="pagination-text">ÊòæÁ§∫Á¨¨ {{ (page-1)*per_page + 1 }} - {{ page*per_page if page*per_page <=
                            total_groups else total_groups }} Êù°ÔºåÂÖ± {{ total_groups }} Êù°ËÆ∞ÂΩï</span>
                </div>
                <div class="pagination-controls">
                    {% if page > 1 %}
                    <a href="{{ url_for('admin.groups', page=page-1, search=search_term, sort_by=sort_by, sort_order=sort_order) }}"
                        class="btn-glass pagination-btn pagination-prev" aria-label="‰∏ä‰∏ÄÈ°µ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        <span>‰∏ä‰∏ÄÈ°µ</span>
                    </a>
                    {% else %}
                    <span class="btn-glass pagination-btn pagination-prev disabled">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        <span>‰∏ä‰∏ÄÈ°µ</span>
                    </span>
                    {% endif %}
                    <div class="pagination-numbers">
                        {% for p in range(1, total_pages + 1) %}
                        {% if p == page %}
                        <span class="btn-glass pagination-number active">{{ p }}</span>
                        {% elif p <= 3 or p> total_pages - 3 or (p >= page - 2 and p <= page + 2) %} <a
                                href="{{ url_for('admin.groups', page=p, search=search_term, sort_by=sort_by, sort_order=sort_order) }}"
                                class="btn-glass pagination-number">{{ p }}</a>
                                {% elif p == 4 or p == total_pages - 3 %}
                                <span class="pagination-ellipsis">‚Ä¶</span>
                                {% endif %}
                                {% endfor %}
                    </div>
                    {% if page < total_pages %} <a
                        href="{{ url_for('admin.groups', page=page+1, search=search_term, sort_by=sort_by, sort_order=sort_order) }}"
                        class="btn-glass pagination-btn pagination-next" aria-label="‰∏ã‰∏ÄÈ°µ">
                        <span>‰∏ã‰∏ÄÈ°µ</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                        </a>
                        {% else %}
                        <span class="btn-glass pagination-btn pagination-next disabled">
                            <span>‰∏ã‰∏ÄÈ°µ</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </span>
                        {% endif %}
                </div>
            </div>
            {% endif %}

            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <h3 class="empty-state-title">ÊöÇÊó†Áæ§ÁªÑÊï∞ÊçÆ</h3>
                <p class="empty-state-description">
                    {% if search_term %}
                    Ê≤°ÊúâÊâæÂà∞ÂåÖÂê´ "{{ search_term }}" ÁöÑÁæ§ÁªÑ
                    {% else %}
                    Á≥ªÁªü‰∏≠ËøòÊ≤°Êúâ‰ªª‰ΩïÁæ§ÁªÑÊï∞ÊçÆ
                    {% endif %}
                </p>
                {% if search_term %}
                <a href="{{ url_for('admin.groups') }}" class="btn btn-primary btn-sm mt-2">Ê∏ÖÈô§ÊêúÁ¥¢Êù°‰ª∂</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}

{% block modals %}
<!-- Áæ§ÁªÑËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
<div class="modal-overlay" id="groupDetailModal">
    <div class="modal-container modal-large">
        <div class="modal-header">
            <div class="modal-title-section">
                <div class="modal-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <div class="modal-title-text">
                    <h3 class="modal-title">Áæ§ÁªÑËØ¶ÊÉÖ</h3>
                    <p class="modal-subtitle">Êü•ÁúãÁæ§ÁªÑÁöÑËØ¶ÁªÜ‰ø°ÊÅØÂíåÁªüËÆ°Êï∞ÊçÆ</p>
                </div>
            </div>
            <button class="modal-close" aria-label="ÂÖ≥Èó≠">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div id="groupDetailContent" class="user-detail-content">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <span>Âä†ËΩΩ‰∏≠...</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#" id="viewGroupDialogsBtn" class="btn-glass btn-primary">Êü•ÁúãÂØπËØù</a>
        </div>
    </div>
</div>

<!-- ÁºñËæëÁæ§ÁªÑÊ®°ÊÄÅÊ°Ü -->
<div class="modal-overlay" id="groupEditModal">
    <div class="modal-container modal-large">
        <div class="modal-header">
            <div class="modal-title-section">
                <div class="modal-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <div class="modal-title-text">
                    <h3 class="modal-title">ÁºñËæëÁæ§ÁªÑ</h3>
                    <p class="modal-subtitle">‰øÆÊîπÁæ§ÁªÑÁöÑÂü∫Êú¨‰ø°ÊÅØÂíåÈÖçÁΩÆ</p>
                </div>
            </div>
            <button class="modal-close" aria-label="ÂÖ≥Èó≠">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <form id="groupEditForm" class="modern-form">
                <input type="hidden" id="editGroupId" name="group_id">
                <div class="form-sections">
                    <!-- Section 1: Basic Info -->
                    <div class="form-section">
                        <div class="section-header">
                            <h4 class="section-title">Âü∫Êú¨‰ø°ÊÅØ</h4>
                        </div>
                        <div class="form-group">
                            <label for="editGroupName" class="form-label">Áæ§ÁªÑÂêçÁß∞</label>
                            <input type="text" id="editGroupName" name="group_name" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="editActive" class="form-label">Áä∂ÊÄÅ</label>
                            <div class="custom-select-wrapper">
                                <select class="original-select" id="editActive" name="active">
                                    <option value="1">Ê¥ªË∑É</option>
                                    <option value="0">ÈùûÊ¥ªË∑É</option>
                                </select>
                                <!-- Custom select will be generated by JS -->
                            </div>
                        </div>
                    </div>
                    <!-- Section 2: Core Config -->
                    <div class="form-section">
                        <div class="section-header">
                            <h4 class="section-title">Ê†∏ÂøÉÈÖçÁΩÆ</h4>
                        </div>
                        <div class="form-group">
                            <label for="editRate" class="form-label">Ëß¶ÂèëÂá†Áéá (0-1)</label>
                            <input type="number" id="editRate" name="rate" class="form-input" step="0.01" min="0"
                                max="1">
                        </div>
                        <div class="form-group">
                            <label for="editChar" class="form-label">ËßíËâ≤</label>
                            <input type="text" id="editChar" name="char" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="editApi" class="form-label">API</label>
                            <input type="text" id="editApi" name="api" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="editPreset" class="form-label">È¢ÑËÆæ</label>
                            <input type="text" id="editPreset" name="preset" class="form-input">
                        </div>
                    </div>
                    <!-- Section 3: Content Rules -->
                    <div class="form-section">
                        <div class="section-header">
                            <h4 class="section-title">ÂÜÖÂÆπËßÑÂàô</h4>
                        </div>
                        <div class="form-group">
                            <label for="editKeywords" class="form-label">ÂÖ≥ÈîÆËØç (ÈÄóÂè∑ÂàÜÈöî)</label>
                            <textarea id="editKeywords" name="keywords" class="form-input" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="editDisabledTopics" class="form-label">Á¶ÅÁî®ËØùÈ¢ò (ÈÄóÂè∑ÂàÜÈöî)</label>
                            <textarea id="editDisabledTopics" name="disabled_topics" class="form-input"
                                rows="3"></textarea>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" id="saveGroupChangesBtn" class="btn-glass btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                <span>‰øùÂ≠òÊõ¥Êîπ</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/admin_groups.js') }}"></script>
{% endblock %}