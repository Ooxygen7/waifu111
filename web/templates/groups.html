{% extends "base.html" %}

{% block title %}Áæ§ÁªÑÁÆ°ÁêÜ - CyberWaifu Bot ÂêéÂè∞ÁÆ°ÁêÜÁ≥ªÁªü{% endblock %}

{% block page_title %}Áæ§ÁªÑÁÆ°ÁêÜ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_glass.css') }}">
{% endblock %}

{% block content %}
<div class="content-wrapper users-page page-groups">
    <div class="card">
        <div class="card-header">
            <div class="header-container">
                <div class="header-title">
                    <h3><i class="icon">üë•</i> Áæ§ÁªÑÁÆ°ÁêÜ</h3>
                </div>
                <div class="search-container">
                    <form method="GET" action="{{ url_for('admin.groups') }}" class="search-form">
                        <div class="search-input-wrapper">
                            <div class="search-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            </div>
                            <input type="text" name="search" class="search-input" placeholder="ÊêúÁ¥¢Áæ§ÁªÑÂêçÁß∞..." value="{{ search_term or '' }}" aria-label="ÊêúÁ¥¢Áæ§ÁªÑ">
                            {% if search_term %}
                            <a href="{{ url_for('admin.groups') }}" class="clear-button" aria-label="Ê∏ÖÈô§ÊêúÁ¥¢">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </a>
                            {% endif %}
                        </div>
                        <button type="submit" class="btn-glass search-button" aria-label="ÊêúÁ¥¢">
                            <span>ÊêúÁ¥¢</span>
                        </button>
                    </form>
                    {% if search_term %}
                    <div class="search-status">
                        <span>ÊâæÂà∞‰∏é "<strong>{{ search_term }}</strong>" Áõ∏ÂÖ≥ÁöÑÁªìÊûú</span>
                        <a href="{{ url_for('admin.groups') }}" class="clear-search-link">Ê∏ÖÈô§ÊêúÁ¥¢</a>
                    </div>
                    {% endif %}
                </div>
            </div>
            
        </div>
        <div class="card-body">
            {% if groups %}
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <!-- Hidden Group ID Column -->
                            <th class="sortable" data-sort="text">
                                <a href="{{ url_for('admin.groups', search=search_term, sort_by='group_name', sort_order=next_sort_order('group_name')) }}" class="sort-link"><span>Áæ§ÁªÑÂêçÁß∞</span><span class="sort-indicator"></span></a>
                            </th>
                            <th class="sortable" data-sort="number">
                                <a href="{{ url_for('admin.groups', search=search_term, sort_by='call_count', sort_order=next_sort_order('call_count')) }}" class="sort-link"><span>Ë∞ÉÁî®Ê¨°Êï∞</span><span class="sort-indicator"></span></a>
                            </th>
                            <th>ËßíËâ≤/API</th>
                            <th class="sortable" data-sort="number">
                                <a href="{{ url_for('admin.groups', search=search_term, sort_by='rate', sort_order=next_sort_order('rate')) }}" class="sort-link"><span>Ëß¶ÂèëÂá†Áéá</span><span class="sort-indicator"></span></a>
                            </th>
                            <th>Token‰ΩøÁî®</th>
                            <th class="sortable" data-sort="date">
                                <a href="{{ url_for('admin.groups', search=search_term, sort_by='update_time', sort_order=next_sort_order('update_time')) }}" class="sort-link"><span>Êõ¥Êñ∞Êó∂Èó¥</span><span class="sort-indicator"></span></a>
                            </th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for group in groups %}
                        <tr class="table-row-interactive" data-group-id="{{ group.group_id }}">
                            <td>
                                <div class="user-info">
                                    <div class="user-avatar">
                                        <div class="avatar-image">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                                <circle cx="12" cy="7" r="4"></circle>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="user-details">
                                        <span class="user-name">{{ group.group_name or 'Êú™ÂëΩÂêçÁæ§ÁªÑ' }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div>{{ "{:,}".format(group.call_count or 0) }} Ê¨°</div>
                            </td>
                            <td>
                                <div class="stacked-badges">
                                    <span>{{ group.char or 'Êú™ËÆæÁΩÆ' }}</span>
                                    <span>{{ group.api or 'ÈªòËÆ§' }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="rate-indicator">
                                    <div class="rate-bar">
                                        <div class="rate-fill" style="width: {{ (group.rate or 0) * 100 }}%"></div>
                                    </div>
                                    <span class="rate-text">{{ "%.1f"|format((group.rate or 0) * 100) }}%</span>
                                </div>
                            </td>
                            <td>
                                <div class="token-stats">
                                    <div class="token-item">
                                        <span class="token-label">ËæìÂÖ•</span>
                                        <span class="token-value text-primary">{{ "{:,}".format(group.input_token or 0) }}</span>
                                    </div>
                                    <div class="token-item">
                                        <span class="token-label">ËæìÂá∫</span>
                                        <span class="token-value text-success">{{ "{:,}".format(group.output_token or 0) }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="date-info">
                                    <span class="date-value">{{ format_datetime(group.update_time).split(' ')[0] }}</span>
                                    <span class="date-time text-muted">{{ format_datetime(group.update_time).split(' ')[1] }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button type="button" class="btn-glass view-group-btn" title="Êü•ÁúãËØ¶ÊÉÖ">
                                        <span>‚ÑπÔ∏è</span>
                                    </button>
                                    <button type="button" class="btn-glass edit-group-btn" title="ÁºñËæëÁæ§ÁªÑ">
                                        <span>‚úèÔ∏è</span>
                                    </button>
                                    <a href="{{ url_for('admin.group_dialogs', group_id=group.group_id) }}" class="btn-glass" title="Êü•ÁúãÂØπËØù">
                                        <span>üí¨</span>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            {% if total_pages > 1 %}
            <div class="pagination-wrapper">
                <div class="pagination-info">
                    <span class="pagination-text">ÊòæÁ§∫Á¨¨ {{ (page-1)*per_page + 1 }} - {{ page*per_page if page*per_page <= total_groups else total_groups }} Êù°ÔºåÂÖ± {{ total_groups }} Êù°ËÆ∞ÂΩï</span>
                </div>
                <div class="pagination-controls">
                    {% if page > 1 %}
                        <a href="{{ url_for('admin.groups', page=page-1, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" class="btn-glass pagination-btn pagination-prev" aria-label="‰∏ä‰∏ÄÈ°µ">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                            <span>‰∏ä‰∏ÄÈ°µ</span>
                        </a>
                    {% else %}
                        <span class="btn-glass pagination-btn pagination-prev disabled">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                            <span>‰∏ä‰∏ÄÈ°µ</span>
                        </span>
                    {% endif %}
                    <div class="pagination-numbers">
                        {% for p in range(1, total_pages + 1) %}
                            {% if p == page %}
                                <span class="btn-glass pagination-number active">{{ p }}</span>
                            {% elif p <= 3 or p > total_pages - 3 or (p >= page - 2 and p <= page + 2) %}
                                <a href="{{ url_for('admin.groups', page=p, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" class="btn-glass pagination-number">{{ p }}</a>
                            {% elif p == 4 or p == total_pages - 3 %}
                                <span class="pagination-ellipsis">‚Ä¶</span>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% if page < total_pages %}
                        <a href="{{ url_for('admin.groups', page=page+1, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" class="btn-glass pagination-btn pagination-next" aria-label="‰∏ã‰∏ÄÈ°µ">
                            <span>‰∏ã‰∏ÄÈ°µ</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </a>
                    {% else %}
                        <span class="btn-glass pagination-btn pagination-next disabled">
                            <span>‰∏ã‰∏ÄÈ°µ</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                </div>
                <h3 class="empty-state-title">ÊöÇÊó†Áæ§ÁªÑÊï∞ÊçÆ</h3>
                <p class="empty-state-description">
                    {% if search_term %}
                    Ê≤°ÊúâÊâæÂà∞ÂåÖÂê´ "{{ search_term }}" ÁöÑÁæ§ÁªÑ
                    {% else %}
                    Á≥ªÁªü‰∏≠ËøòÊ≤°Êúâ‰ªª‰ΩïÁæ§ÁªÑÊï∞ÊçÆ
                    {% endif %}
                </p>
                {% if search_term %}
                <a href="{{ url_for('admin.groups') }}" class="btn btn-primary btn-sm mt-2">Ê∏ÖÈô§ÊêúÁ¥¢Êù°‰ª∂</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Edit Group Modal -->
    <div class="modal-overlay" id="editGroupModal" style="display: none;">
        <div class="modal-container glass-modal">
            <div class="modal-header">
                <h3 class="modal-title">ÁºñËæëÁæ§ÁªÑ</h3>
                <button class="modal-close-btn" aria-label="ÂÖ≥Èó≠">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="editGroupForm" class="edit-user-form">
                    <input type="hidden" id="editGroupId" name="group_id">
                    <div class="form-layout">
                        <!-- Card 1: Basic Info -->
                        <div class="form-card">
                            <div class="form-card-header">Âü∫Êú¨‰ø°ÊÅØ</div>
                            <div class="form-card-body">
                                <div class="form-group">
                                    <label for="editGroupName">Áæ§ÁªÑÂêçÁß∞</label>
                                    <input type="text" id="editGroupName" name="group_name" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="editActive">Áä∂ÊÄÅ</label>
                                    <div class="custom-select-wrapper">
                                        <select id="editActive" name="active" class="form-control">
                                            <option value="1">Ê¥ªË∑É</option>
                                            <option value="0">ÈùûÊ¥ªË∑É</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Card 2: Core Config -->
                        <div class="form-card">
                            <div class="form-card-header">Ê†∏ÂøÉÈÖçÁΩÆ</div>
                            <div class="form-card-body">
                                <div class="form-group">
                                    <label for="editRate">Ëß¶ÂèëÂá†Áéá (0-1)</label>
                                    <input type="number" id="editRate" name="rate" class="form-control" step="0.01" min="0" max="1">
                                </div>
                                <div class="form-group">
                                    <label for="editChar">ËßíËâ≤</label>
                                    <input type="text" id="editChar" name="char" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="editApi">API</label>
                                    <input type="text" id="editApi" name="api" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="editPreset">È¢ÑËÆæ</label>
                                    <input type="text" id="editPreset" name="preset" class="form-control">
                                </div>
                            </div>
                        </div>
                        <!-- Card 3: Content Rules -->
                        <div class="form-card">
                            <div class="form-card-header">ÂÜÖÂÆπËßÑÂàô</div>
                            <div class="form-card-body">
                                <div class="form-group">
                                    <label for="editKeywords">ÂÖ≥ÈîÆËØç (ÈÄóÂè∑ÂàÜÈöî)</label>
                                    <textarea id="editKeywords" name="keywords" class="form-control" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="editDisabledTopics">Á¶ÅÁî®ËØùÈ¢ò (ÈÄóÂè∑ÂàÜÈöî)</label>
                                    <textarea id="editDisabledTopics" name="disabled_topics" class="form-control" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close-btn">ÂèñÊ∂à</button>
                <button type="submit" form="editGroupForm" class="btn btn-primary">
                    <span class="btn-text">‰øùÂ≠òÊõ¥Êîπ</span>
                    <span class="spinner"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- View Group Modal -->
    <div class="modal-overlay" id="viewGroupModal" style="display: none;">
        <div class="modal-container glass-modal">
            <div class="modal-header">
                <h3 class="modal-title">Áæ§ÁªÑËØ¶ÊÉÖ</h3>
                <button class="modal-close-btn" aria-label="ÂÖ≥Èó≠">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <div id="viewGroupContent">
                    <!-- Content will be loaded here by JavaScript -->
                    <div class="loading-state active">
                        <div class="spinner"></div>
                        <p>Ê≠£Âú®Âä†ËΩΩÁæ§ÁªÑÊï∞ÊçÆ...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                 <a href="#" id="viewGroupDialogsLink" class="btn btn-primary">Êü•ÁúãÂØπËØù</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/admin_groups.js') }}"></script>
{% endblock %}