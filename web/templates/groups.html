{% extends "base.html" %}

{% block title %}Áæ§ÁªÑÁÆ°ÁêÜ - CyberWaifu Bot ÂêéÂè∞ÁÆ°ÁêÜÁ≥ªÁªü{% endblock %}

{% block page_title %}Áæ§ÁªÑÁÆ°ÁêÜ{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="card">
        <div class="card-header">
            <div class="header-container">
                <div class="header-title">
                    <h3><i class="icon">üë•</i> Áæ§ÁªÑÁÆ°ÁêÜ</h3>
                </div>
                <div class="search-container">
                    <form method="GET" class="search-form">
                        <div class="search-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        </div>
                        <input type="text" name="search" class="search-input" 
                               placeholder="ÊêúÁ¥¢Áæ§ÁªÑID„ÄÅÂêçÁß∞..." value="{{ search_term }}"
                               aria-label="ÊêúÁ¥¢Áæ§ÁªÑ">
                        <div class="search-loading"></div>
                        {% if search_term %}
                        <a href="{{ url_for('admin.groups') }}" class="clear-button" aria-label="Ê∏ÖÈô§ÊêúÁ¥¢">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </a>
                        {% endif %}
                        <button type="submit" class="search-button" aria-label="ÊêúÁ¥¢">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        </button>
                    </form>
                    {% if search_term %}
                    <div class="search-status">ÊâæÂà∞‰∏é "{{ search_term }}" Áõ∏ÂÖ≥ÁöÑÁªìÊûú</div>
                    {% endif %}
                </div>
            </div>
            
        </div>
        <div class="card-body">
            {% if groups %}
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="number">
                                <a href="{{ url_for('admin.groups', search=search_term, sort_by='group_id', sort_order=next_sort_order('group_id')) }}"
                                   class="sort-link" aria-label="ÊåâÁæ§ÁªÑIDÊéíÂ∫è">
                                    <span>Áæ§ÁªÑID</span>
                                    <span class="sort-indicator">
                                        {% if sort_by == 'group_id' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                                {% if sort_order == 'asc' %}
                                                <polyline points="18 15 12 9 6 15"></polyline>
                                                {% else %}
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                                {% endif %}
                                            </svg>
                                        {% else %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                                <polyline points="19 12 12 19 5 12"></polyline>
                                            </svg>
                                        {% endif %}
                                    </span>
                                </a>
                            </th>
                            <th class="sortable" data-sort="text">
                                <a href="{{ url_for('admin.groups', search=search_term, sort_by='group_name', sort_order=next_sort_order('group_name')) }}"
                                   class="sort-link" aria-label="ÊåâÁæ§ÁªÑÂêçÁß∞ÊéíÂ∫è">
                                    <span>Áæ§ÁªÑÂêçÁß∞</span>
                                    <span class="sort-indicator">
                                        {% if sort_by == 'group_name' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                                {% if sort_order == 'asc' %}
                                                <polyline points="18 15 12 9 6 15"></polyline>
                                                {% else %}
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                                {% endif %}
                                            </svg>
                                        {% else %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                                <polyline points="19 12 12 19 5 12"></polyline>
                                            </svg>
                                        {% endif %}
                                    </span>
                                </a>
                            </th>
                            <th class="sortable" data-sort="number">
                                <a href="{{ url_for('admin.groups', search=search_term, sort_by='call_count', sort_order=next_sort_order('call_count')) }}"
                                   class="sort-link" aria-label="ÊåâË∞ÉÁî®Ê¨°Êï∞ÊéíÂ∫è">
                                    <span>Ë∞ÉÁî®Ê¨°Êï∞</span>
                                    <span class="sort-indicator">
                                        {% if sort_by == 'call_count' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                                {% if sort_order == 'asc' %}
                                                <polyline points="18 15 12 9 6 15"></polyline>
                                                {% else %}
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                                {% endif %}
                                            </svg>
                                        {% else %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                                <polyline points="19 12 12 19 5 12"></polyline>
                                            </svg>
                                        {% endif %}
                                    </span>
                                </a>
                            </th>
                            <th>ËßíËâ≤</th>
                            <th>API</th>
                            <th>È¢ÑËÆæ</th>
                            <th class="sortable" data-sort="number">
                                <a href="{{ url_for('admin.groups', search=search_term, sort_by='rate', sort_order=next_sort_order('rate')) }}"
                                   class="sort-link" aria-label="ÊåâËß¶ÂèëÂá†ÁéáÊéíÂ∫è">
                                    <span>Ëß¶ÂèëÂá†Áéá</span>
                                    <span class="sort-indicator">
                                        {% if sort_by == 'rate' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                                {% if sort_order == 'asc' %}
                                                <polyline points="18 15 12 9 6 15"></polyline>
                                                {% else %}
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                                {% endif %}
                                            </svg>
                                        {% else %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                                <polyline points="19 12 12 19 5 12"></polyline>
                                            </svg>
                                        {% endif %}
                                    </span>
                                </a>
                            </th>
                            <th>Token‰ΩøÁî®</th>
                            <th class="sortable" data-sort="text">
                                <a href="{{ url_for('admin.groups', search=search_term, sort_by='active', sort_order=next_sort_order('active')) }}"
                                   class="sort-link" aria-label="ÊåâÁä∂ÊÄÅÊéíÂ∫è">
                                    <span>Áä∂ÊÄÅ</span>
                                    <span class="sort-indicator">
                                        {% if sort_by == 'active' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                                {% if sort_order == 'asc' %}
                                                <polyline points="18 15 12 9 6 15"></polyline>
                                                {% else %}
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                                {% endif %}
                                            </svg>
                                        {% else %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                                <polyline points="19 12 12 19 5 12"></polyline>
                                            </svg>
                                        {% endif %}
                                    </span>
                                </a>
                            </th>
                            <th class="sortable" data-sort="date">
                                <a href="{{ url_for('admin.groups', search=search_term, sort_by='update_time', sort_order=next_sort_order('update_time')) }}"
                                   class="sort-link" aria-label="ÊåâÊõ¥Êñ∞Êó∂Èó¥ÊéíÂ∫è">
                                    <span>Êõ¥Êñ∞Êó∂Èó¥</span>
                                    <span class="sort-indicator">
                                        {% if sort_by == 'update_time' %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                                {% if sort_order == 'asc' %}
                                                <polyline points="18 15 12 9 6 15"></polyline>
                                                {% else %}
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                                {% endif %}
                                            </svg>
                                        {% else %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                                <polyline points="19 12 12 19 5 12"></polyline>
                                            </svg>
                                        {% endif %}
                                    </span>
                                </a>
                            </th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for group in groups %}
                        <tr class="table-row-interactive">
                            <td>
                                <span class="badge primary group-id">{{ group.group_id }}</span>
                            </td>
                            <td>
                                <div class="user-info">
                                    <div class="user-avatar">
                                        <div class="avatar-image">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                                <circle cx="12" cy="7" r="4"></circle>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="user-details">
                                        <span class="user-name">{{ group.group_name or 'Êú™ÂëΩÂêçÁæ§ÁªÑ' }}</span>
                                        {% if group.active %}
                                        <span class="user-status active" title="Ê¥ªË∑ÉÁæ§ÁªÑ"></span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="stat-badge">
                                    <span class="stat-value">{{ "{:,}".format(group.call_count or 0) }}</span>
                                    <span class="stat-label">Ê¨°</span>
                                </div>
                            </td>
                            <td>
                                <span class="badge info">{{ group.char or 'Êú™ËÆæÁΩÆ' }}</span>
                            </td>
                            <td>
                                <span class="badge secondary">{{ group.api or 'ÈªòËÆ§' }}</span>
                            </td>
                            <td>
                                <span class="badge warning">{{ group.preset or 'ÈªòËÆ§' }}</span>
                            </td>
                            <td>
                                <div class="rate-indicator">
                                    <div class="rate-bar">
                                        <div class="rate-fill" style="width: {{ (group.rate or 0) * 100 }}%"></div>
                                    </div>
                                    <span class="rate-text">{{ "%.1f"|format((group.rate or 0) * 100) }}%</span>
                                </div>
                            </td>
                            <td>
                                <div class="token-stats">
                                    <div class="token-item">
                                        <span class="token-label">ËæìÂÖ•</span>
                                        <span class="token-value text-primary">{{ "{:,}".format(group.input_token or 0) }}</span>
                                    </div>
                                    <div class="token-item">
                                        <span class="token-label">ËæìÂá∫</span>
                                        <span class="token-value text-success">{{ "{:,}".format(group.output_token or 0) }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if group.active %}
                                    <span class="badge success">Ê¥ªË∑É</span>
                                {% else %}
                                    <span class="badge danger">ÈùûÊ¥ªË∑É</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="date-info">
                                    <span class="date-value">{{ format_datetime(group.update_time).split(' ')[0] }}</span>
                                    <span class="date-time text-muted">{{ format_datetime(group.update_time).split(' ')[1] }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-icon btn-sm view-group-btn"
                                            data-group-id="{{ group.group_id }}"
                                            title="Êü•ÁúãËØ¶ÊÉÖ">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    <button type="button" class="btn btn-icon btn-sm edit-group-btn"
                                            data-group-id="{{ group.group_id }}"
                                            title="ÁºñËæëÁæ§ÁªÑ">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <a href="{{ url_for('admin.group_dialogs', group_id=group.group_id) }}"
                                       class="btn btn-icon btn-sm" title="Êü•ÁúãÂØπËØù">
                                        <i class="fas fa-comments"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- ÂàÜÈ°µ -->
            {% if total_pages > 1 %}
            <div class="pagination-container">
                <div class="pagination-info">
                    ÊòæÁ§∫Á¨¨ <span class="text-primary">{{ (page - 1) * per_page + 1 }}</span> Ëá≥ 
                    <span class="text-primary">{{ min(page * per_page, total_groups) }}</span> Êù°Ôºå
                    ÂÖ± <span class="text-primary">{{ total_groups }}</span> Êù°ËÆ∞ÂΩï
                </div>
                <div class="pagination">
                    {% if page > 1 %}
                    <a class="page-item" href="{{ url_for('admin.groups', page=1, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="Á¨¨‰∏ÄÈ°µ" title="Á¨¨‰∏ÄÈ°µ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="11 17 6 12 11 7"></polyline>
                            <polyline points="18 17 13 12 18 7"></polyline>
                        </svg>
                    </a>
                    <a class="page-item" href="{{ url_for('admin.groups', page=page-1, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="‰∏ä‰∏ÄÈ°µ" title="‰∏ä‰∏ÄÈ°µ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    </a>
                    {% else %}
                    <span class="page-item disabled" aria-disabled="true">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="11 17 6 12 11 7"></polyline>
                            <polyline points="18 17 13 12 18 7"></polyline>
                        </svg>
                    </span>
                    <span class="page-item disabled" aria-disabled="true">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    </span>
                    {% endif %}
                    
                    {% for p in range(max(1, page-2), min(total_pages+1, page+3)) %}
                    <a class="page-item {{ 'active' if p == page else '' }}" href="{{ url_for('admin.groups', page=p, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="Á¨¨{{ p }}È°µ" {% if p == page %}aria-current="page"{% endif %}>
                        {{ p }}
                    </a>
                    {% endfor %}
                    
                    {% if page < total_pages %}
                    <a class="page-item" href="{{ url_for('admin.groups', page=page+1, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="‰∏ã‰∏ÄÈ°µ" title="‰∏ã‰∏ÄÈ°µ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </a>
                    <a class="page-item" href="{{ url_for('admin.groups', page=total_pages, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="ÊúÄÂêé‰∏ÄÈ°µ" title="ÊúÄÂêé‰∏ÄÈ°µ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="13 17 18 12 13 7"></polyline>
                            <polyline points="6 17 11 12 6 7"></polyline>
                        </svg>
                    </a>
                    {% else %}
                    <span class="page-item disabled" aria-disabled="true">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </span>
                    <span class="page-item disabled" aria-disabled="true">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="13 17 18 12 13 7"></polyline>
                            <polyline points="6 17 11 12 6 7"></polyline>
                        </svg>
                    </span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <h5 class="empty-title">ÊöÇÊó†Áæ§ÁªÑÊï∞ÊçÆ</h5>
                {% if search_term %}
                <p class="empty-text">Ê≤°ÊúâÊâæÂà∞ÂåπÈÖç "<span class="search-highlight">{{ search_term }}</span>" ÁöÑÁæ§ÁªÑ</p>
                <a href="{{ url_for('admin.groups') }}" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-xs">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    Ê∏ÖÈô§ÊêúÁ¥¢
                </a>
                {% else %}
                <p class="empty-text">Á≥ªÁªü‰∏≠ËøòÊ≤°Êúâ‰ªª‰ΩïÁæ§ÁªÑÊï∞ÊçÆ</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Áæ§ÁªÑËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
    <div class="modal-overlay" id="groupDetailModal" style="display: none;">
        <div class="modal-container modal-large">
            <div class="modal-header">
                <div class="modal-title-section">
                    <div class="modal-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>
                    </div>
                    <div class="modal-title-text">
                        <h3 class="modal-title">Áæ§ÁªÑËØ¶ÊÉÖ</h3>
                        <p class="modal-subtitle">Êü•ÁúãÁæ§ÁªÑÁöÑËØ¶ÁªÜ‰ø°ÊÅØÂíåÈÖçÁΩÆ</p>
                    </div>
                </div>
                <button class="modal-close" onclick="closeModal('groupDetailModal')" aria-label="ÂÖ≥Èó≠">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div id="groupDetailContent" class="group-detail-content">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <span>Âä†ËΩΩ‰∏≠...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÁºñËæëÁæ§ÁªÑÊ®°ÊÄÅÊ°Ü -->
    <div id="editGroupModal" class="modal">
        <div class="modal-overlay" onclick="closeModal('editGroupModal')"></div>
        <div class="modal-container modern-modal">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> ÁºñËæëÁæ§ÁªÑ</h5>
                <button type="button" class="modal-close" onclick="closeModal('editGroupModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editGroupForm">
                    <input type="hidden" id="editGroupId">
                    
                    <div class="form-row">
                        <div class="form-group col-md-8">
                            <label for="editGroupName"><i class="fas fa-tag"></i> Áæ§ÁªÑÂêçÁß∞</label>
                            <input type="text" class="form-control modern-input" id="editGroupName" placeholder="ËØ∑ËæìÂÖ•Áæ§ÁªÑÂêçÁß∞">
                        </div>
                        <div class="form-group col-md-4">
                            <label for="editActive"><i class="fas fa-toggle-on"></i> Áä∂ÊÄÅ</label>
                            <select class="form-control modern-select" id="editActive">
                                <option value="1">Ê¥ªË∑É</option>
                                <option value="0">ÈùûÊ¥ªË∑É</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="editRate"><i class="fas fa-star"></i> Ëß¶ÂèëÂá†Áéá (0-1)</label>
                            <input type="number" class="form-control modern-input" id="editRate" step="any" min="0" max="1" placeholder="0.00">
                        </div>
                        <div class="form-group col-md-4">
                            <label for="editChar"><i class="fas fa-user"></i> ËßíËâ≤</label>
                            <input type="text" class="form-control modern-input" id="editChar" placeholder="ËßíËâ≤ÂêçÁß∞">
                        </div>
                        <div class="form-group col-md-4">
                            <label for="editApi"><i class="fas fa-plug"></i> API</label>
                            <input type="text" class="form-control modern-input" id="editApi" placeholder="APIÈÖçÁΩÆ">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="editPreset"><i class="fas fa-cogs"></i> È¢ÑËÆæ</label>
                        <input type="text" class="form-control modern-input" id="editPreset" placeholder="È¢ÑËÆæÈÖçÁΩÆ">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="editKeywords"><i class="fas fa-tags"></i> ÂÖ≥ÈîÆËØç</label>
                            <textarea class="form-control modern-textarea" id="editKeywords" rows="3" placeholder="Áî®ÈÄóÂè∑ÂàÜÈöîÂ§ö‰∏™ÂÖ≥ÈîÆËØç"></textarea>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="editDisabledTopics"><i class="fas fa-ban"></i> Á¶ÅÁî®ËØùÈ¢ò</label>
                            <textarea class="form-control modern-textarea" id="editDisabledTopics" rows="3" placeholder="Áî®ÈÄóÂè∑ÂàÜÈöîÂ§ö‰∏™Á¶ÅÁî®ËØùÈ¢ò"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modern-btn" onclick="closeModal('editGroupModal')">
                    <i class="fas fa-times"></i> ÂèñÊ∂à
                </button>
                <button type="button" class="btn btn-primary modern-btn" onclick="saveGroupChanges()">
                    <i class="fas fa-save"></i> ‰øùÂ≠òÊõ¥Êîπ
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    /* Áé∞‰ª£ÂåñÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
    }
    
    .modal.show {
        display: block;
    }
    
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 1001;
        animation: fadeIn 0.3s ease;
    }
    
    .modal-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--card-bg, #1a1d29);
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        border: 1px solid var(--border-color, #2d3748);
        z-index: 1002;
        max-width: 90vw;
        max-height: 90vh;
        overflow: hidden;
        animation: slideIn 0.3s ease;
    }
    
    .modern-modal {
        width: 800px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .modal-large {
        width: 800px;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translate(-50%, -48%) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
    }
    
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 24px 32px;
        border-bottom: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .modal-title i {
        font-size: 1.2rem;
        opacity: 0.9;
    }
    
    .modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    
    .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
    }
    
    .modal-body {
        padding: 32px;
        max-height: 60vh;
        overflow-y: auto;
        background: var(--card-bg, #1a1d29);
        color: var(--text-color, #e2e8f0);
    }
    
    .modal-footer {
        padding: 24px 32px;
        border-top: 1px solid var(--border-color, #2d3748);
        background: var(--card-bg, #1a1d29);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }
    
    /* Áé∞‰ª£ÂåñË°®ÂçïÊ†∑Âºè */
    .form-row {
        display: flex;
        flex-wrap: wrap;
        margin: 0 -8px;
    }
    
    .form-group {
        margin-bottom: 24px;
        padding: 0 8px;
    }
    
    .col-md-4 {
        flex: 0 0 33.333333%;
        max-width: 33.333333%;
    }
    
    .col-md-6 {
        flex: 0 0 50%;
        max-width: 50%;
    }
    
    .col-md-8 {
        flex: 0 0 66.666667%;
        max-width: 66.666667%;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-color, #e2e8f0);
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .form-group label i {
        color: #667eea;
        font-size: 0.85rem;
    }
    
    .modern-input, .modern-select, .modern-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border-color, #2d3748);
        border-radius: 10px;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        background: var(--input-bg, #2d3748);
        color: var(--text-color, #e2e8f0);
        box-sizing: border-box;
    }
    
    .modern-input:focus, .modern-select:focus, .modern-textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        background: var(--input-focus-bg, #374151);
    }
    
    .modern-input:hover, .modern-select:hover, .modern-textarea:hover {
        border-color: var(--border-hover, #4a5568);
    }
    
    .modern-textarea {
        resize: vertical;
        min-height: 80px;
        font-family: inherit;
    }
    
    .modern-btn {
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.95rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        min-width: 120px;
        justify-content: center;
    }
    
    .btn-primary.modern-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary.modern-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary.modern-btn {
        background: var(--secondary-bg, #2d3748);
        color: var(--text-color, #e2e8f0);
        border: 2px solid var(--border-color, #4a5568);
    }
    
    .btn-secondary.modern-btn:hover {
        background: var(--secondary-hover, #374151);
        transform: translateY(-1px);
    }
    
    /* ÂìçÂ∫îÂºèËÆæËÆ° */
    @media (max-width: 768px) {
        .modern-modal {
            width: 95vw;
            margin: 20px;
        }
        
        .modal-container {
            top: 20px;
            transform: translateX(-50%);
            position: absolute;
        }
        
        .col-md-4, .col-md-6, .col-md-8 {
            flex: 0 0 100%;
            max-width: 100%;
        }
        
        .modal-header, .modal-body, .modal-footer {
            padding: 20px;
        }
        
        .form-row {
            margin: 0;
        }
        
        .form-group {
            padding: 0;
        }
    }
</style>
<script src="{{ url_for('static', filename='js/search.js') }}"></script>
<script src="{{ url_for('static', filename='js/user-table.js') }}"></script>
<script src="{{ url_for('static', filename='js/user-filter.js') }}"></script>
<script>
// Áæ§ÁªÑÊï∞ÊçÆÂ≠òÂÇ®
let groupsData = {{ groups|tojson|safe }};

// ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÂáΩÊï∞
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÂáΩÊï∞
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
}

// ‰øùÂ≠òÁæ§ÁªÑÊõ¥ÊîπÂáΩÊï∞
function saveGroupChanges() {
    const groupId = document.getElementById('editGroupId').value;
    const groupName = document.getElementById('editGroupName').value;
    const active = document.getElementById('editActive').value;
    const char = document.getElementById('editChar').value;
    const api = document.getElementById('editApi').value;
    const preset = document.getElementById('editPreset').value;
    const rate = document.getElementById('editRate').value;
    const keywords = document.getElementById('editKeywords').value;
    const disabledTopics = document.getElementById('editDisabledTopics').value;
    
    const data = {
        group_name: groupName,
        active: parseInt(active),
        char: char,
        api: api,
        preset: preset,
        rate: parseFloat(rate) || 0,
        keywords: keywords,
        disabled_topics: disabledTopics
    };
    
    fetch(`/api/groups/${groupId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Áæ§ÁªÑ‰ø°ÊÅØÊõ¥Êñ∞ÊàêÂäüÔºÅ');
            closeModal('editGroupModal');
            location.reload(); // Âà∑Êñ∞È°µÈù¢‰ª•ÊòæÁ§∫Êõ¥Êñ∞ÂêéÁöÑÊï∞ÊçÆ
        } else {
            alert('Êõ¥Êñ∞Â§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Êõ¥Êñ∞Â§±Ë¥•ÔºöÁΩëÁªúÈîôËØØ');
    });
}

function viewGroupDetail(groupId) {
    const modal = document.getElementById('groupDetailModal');
    const content = document.getElementById('groupDetailContent');
    
    // ‰ªéÁæ§ÁªÑÊï∞ÊçÆ‰∏≠Êü•ÊâæÁæ§ÁªÑ‰ø°ÊÅØ
    const group = groupsData.find(g => g.group_id === groupId);
    
    if (!group) {
        content.innerHTML = '<div class="alert alert-danger">Áæ§ÁªÑ‰ø°ÊÅØ‰∏çÂ≠òÂú®</div>';
        modal.classList.add('show');
        return;
    }
    
    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modal.style.display = 'block';
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
    
    // Êõ¥Êñ∞Ê®°ÊÄÅÊ°ÜÊ†áÈ¢ò
    const titleLabel = document.querySelector('#groupDetailModal .modal-title');
    if (titleLabel) {
        titleLabel.textContent = `Áæ§ÁªÑËØ¶ÊÉÖ - ${group.group_name || 'Êú™ÂëΩÂêçÁæ§ÁªÑ'}`;
    }
    
    // Ëß£ÊûêÊàêÂëòÂàóË°®
    let membersList = [];
    if (group.members_list) {
        membersList = group.members_list.split(',').filter(m => m.trim());
    }
    
    // Ëß£ÊûêÂÖ≥ÈîÆËØç
    let keywords = [];
    if (group.keywords) {
        try {
            keywords = JSON.parse(group.keywords);
        } catch (e) {
            keywords = group.keywords.split(',').filter(k => k.trim());
        }
    }
    
    // Ëß£ÊûêÁ¶ÅÁî®ËØùÈ¢ò
    let disabledTopics = [];
    if (group.disabled_topics) {
        try {
            disabledTopics = JSON.parse(group.disabled_topics);
        } catch (e) {
            disabledTopics = group.disabled_topics.split(',').filter(t => t.trim());
        }
    }
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-primary"><i class="fas fa-info-circle"></i> Âü∫Êú¨‰ø°ÊÅØ</h6>
                <table class="table table-borderless table-sm">
                    <tr><td><strong>Áæ§ÁªÑID:</strong></td><td><span class="badge primary">${group.group_id}</span></td></tr>
                    <tr><td><strong>Áæ§ÁªÑÂêçÁß∞:</strong></td><td>${group.group_name || 'Êú™ÂëΩÂêçÁæ§ÁªÑ'}</td></tr>
                    <tr><td><strong>ÊàêÂëòÊï∞Èáè:</strong></td><td><span class="badge info">${membersList.length} ‰∫∫</span></td></tr>
                    <tr><td><strong>Ë∞ÉÁî®Ê¨°Êï∞:</strong></td><td><span class="badge success">${group.call_count || 0}</span></td></tr>
                    <tr><td><strong>Áä∂ÊÄÅ:</strong></td><td>
                        ${group.active ? '<span class="badge success">Ê¥ªË∑É</span>' : '<span class="badge danger">ÈùûÊ¥ªË∑É</span>'}
                    </td></tr>
                    <tr><td><strong>Êõ¥Êñ∞Êó∂Èó¥:</strong></td><td>${group.update_time || 'Êú™Áü•'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="text-success"><i class="fas fa-cog"></i> ÈÖçÁΩÆ‰ø°ÊÅØ</h6>
                <table class="table table-borderless table-sm">
                    <tr><td><strong>ËßíËâ≤:</strong></td><td><span class="badge info">${group.char || 'Êú™ËÆæÁΩÆ'}</span></td></tr>
                    <tr><td><strong>API:</strong></td><td><span class="badge secondary">${group.api || 'ÈªòËÆ§'}</span></td></tr>
                    <tr><td><strong>È¢ÑËÆæ:</strong></td><td><span class="badge warning">${group.preset || 'ÈªòËÆ§'}</span></td></tr>
                    <tr><td><strong>ËØÑÂàÜ:</strong></td><td>
                        ${group.rate ? 
                            (group.rate * 100 >= 80 ? `<span class="badge success">${(group.rate * 100).toFixed(1)}%</span>` :
                             group.rate * 100 >= 60 ? `<span class="badge warning">${(group.rate * 100).toFixed(1)}%</span>` :
                             `<span class="badge danger">${(group.rate * 100).toFixed(1)}%</span>`) :
                            '<span class="badge secondary">Êú™ËØÑÂàÜ</span>'}
                    </td></tr>
                </table>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-warning"><i class="fas fa-bar-chart"></i> Token ‰ΩøÁî®ÁªüËÆ°</h6>
                <table class="table table-borderless table-sm">
                    <tr><td><strong>ËæìÂÖ•Token:</strong></td><td><span class="text-primary">${(group.input_token || 0).toLocaleString()}</span></td></tr>
                    <tr><td><strong>ËæìÂá∫Token:</strong></td><td><span class="text-success">${(group.output_token || 0).toLocaleString()}</span></td></tr>
                    <tr><td><strong>ÊÄªËÆ°Token:</strong></td><td><span class="text-info">${((group.input_token || 0) + (group.output_token || 0)).toLocaleString()}</span></td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="text-info"><i class="fas fa-users"></i> ÊàêÂëòÂàóË°®</h6>
                <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                    ${membersList.length > 0 ? 
                        membersList.map(member => `<span class="badge primary me-1 mb-1">${member}</span>`).join('') :
                        '<span class="text-muted">ÊöÇÊó†ÊàêÂëò</span>'}
                </div>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-primary"><i class="fas fa-tags"></i> ÂÖ≥ÈîÆËØç</h6>
                <div class="border rounded p-2" style="max-height: 100px; overflow-y: auto;">
                    ${keywords.length > 0 ? 
                        keywords.map(keyword => `<span class="badge primary me-1 mb-1">${keyword}</span>`).join('') :
                        '<span class="text-muted">ÊöÇÊó†ÂÖ≥ÈîÆËØç</span>'}
                </div>
            </div>
            <div class="col-md-6">
                <h6 class="text-danger"><i class="fas fa-ban"></i> Á¶ÅÁî®ËØùÈ¢ò</h6>
                <div class="border rounded p-2" style="max-height: 100px; overflow-y: auto;">
                    ${disabledTopics.length > 0 ? 
                        disabledTopics.map(topic => `<span class="badge danger me-1 mb-1">${topic}</span>`).join('') :
                        '<span class="text-muted">ÊöÇÊó†Á¶ÅÁî®ËØùÈ¢ò</span>'}
                </div>
            </div>
        </div>
        <div class="mt-3">
            <a href="/group_dialogs/${group.group_id}" class="btn btn-primary">
                <i class="fas fa-comments"></i> Êü•ÁúãÁæ§ÁªÑÂØπËØù
            </a>
        </div>
    `;
    
    modal.classList.add('show');
}

function editGroup(groupId) {
    const modal = document.getElementById('editGroupModal');
    const group = groupsData.find(g => g.group_id === groupId);
    
    if (!group) {
        alert('Áæ§ÁªÑ‰ø°ÊÅØ‰∏çÂ≠òÂú®');
        return;
    }
    
    // Â°´ÂÖÖË°®ÂçïÊï∞ÊçÆ
    const editGroupId = document.getElementById('editGroupId');
    const editGroupName = document.getElementById('editGroupName');
    const editActive = document.getElementById('editActive');
    const editChar = document.getElementById('editChar');
    const editApi = document.getElementById('editApi');
    const editPreset = document.getElementById('editPreset');
    const editRate = document.getElementById('editRate');
    const editKeywords = document.getElementById('editKeywords');
    const editDisabledTopics = document.getElementById('editDisabledTopics');
    
    if (editGroupId) editGroupId.value = group.group_id;
    if (editGroupName) editGroupName.value = group.group_name || '';
    if (editActive) editActive.value = group.active ? '1' : '0';
    if (editChar) editChar.value = group.char || '';
    if (editApi) editApi.value = group.api || '';
    if (editPreset) editPreset.value = group.preset || '';
    if (editRate) editRate.value = group.rate || '';
    if (editKeywords) editKeywords.value = group.keywords || '';
    if (editDisabledTopics) editDisabledTopics.value = group.disabled_topics || '';
    
    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modal.style.display = 'block';
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
    
    // Êõ¥Êñ∞Ê®°ÊÄÅÊ°ÜÊ†áÈ¢ò
    const editTitleLabel = document.querySelector('#editGroupModal .modal-title');
    if (editTitleLabel) {
        editTitleLabel.innerHTML = `<i class="fas fa-edit"></i> ÁºñËæëÁæ§ÁªÑ - ${group.group_name || 'Êú™ÂëΩÂêçÁæ§ÁªÑ'}`;
    }
}

// ‰∫ã‰ª∂ÁõëÂê¨Âô®
document.addEventListener('DOMContentLoaded', function() {
    // Êü•ÁúãËØ¶ÊÉÖÊåâÈíÆ
    document.querySelectorAll('.view-group-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const groupId = parseInt(this.dataset.groupId, 10);
            viewGroupDetail(groupId);
        });
    });
    
    // ÁºñËæëÊåâÈíÆ
    document.querySelectorAll('.edit-group-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const groupId = parseInt(this.dataset.groupId, 10);
            editGroup(groupId);
        });
    });
    
    // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
    document.getElementById('groupDetailModal').addEventListener('click', function(e) {
        if (e.target === this || e.target.classList.contains('modal-overlay')) {
            closeModal('groupDetailModal');
        }
    });
    
    document.getElementById('editGroupModal').addEventListener('click', function(e) {
        if (e.target === this || e.target.classList.contains('modal-overlay')) {
            closeModal('editGroupModal');
        }
    });
    
    // ÈòªÊ≠¢Ê®°ÊÄÅÊ°ÜÂÜÖÂÆπÂå∫ÂüüÁöÑÁÇπÂáª‰∫ã‰ª∂ÂÜíÊ≥°
    document.querySelectorAll('.modal-container').forEach(container => {
        container.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });
    
    // ESCÈîÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal('groupDetailModal');
            closeModal('editGroupModal');
        }
    });
});
</script>
{% endblock %}