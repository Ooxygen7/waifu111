{% extends "base.html" %}

{% block title %}群组管理 - CyberWaifu Bot 后台管理系统{% endblock %}

{% block page_title %}群组管理{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_glass.css') }}">
{% endblock %}

{% block content %}
<div class="content-wrapper users-page page-groups">
    <div class="card">
        <div class="card-header">
            <div class="header-container">
                <div class="header-title">
                    <h3><i class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></i> 群组列表</h3>
                </div>
                <div class="search-container">
                    <form method="GET" action="{{ url_for('admin.groups') }}" class="search-form">
                        <div class="search-input-wrapper">
                            <div class="search-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                            </div>
                            <input type="text" name="search" class="search-input" placeholder="搜索群组名称..."
                                value="{{ search_term or '' }}" aria-label="搜索群组">
                            {% if search_term %}
                            <a href="{{ url_for('admin.groups') }}" class="clear-button" aria-label="清除搜索">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </a>
                            {% endif %}
                        </div>
                        <button type="submit" class="btn-glass" aria-label="搜索">
                            <span>搜索</span>
                        </button>
                    </form>
                    {% if search_term %}
                    <div class="search-status">
                        <span>找到与 "<strong>{{ search_term }}</strong>" 相关的结果</span>
                        <a href="{{ url_for('admin.groups') }}" class="clear-search-link">清除搜索</a>
                    </div>
                    {% endif %}
                </div>
            </div>

        </div>
        <div class="card-body">
            {% if groups %}
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <!-- Hidden Group ID Column -->
                            <th class="sortable" data-sort="text">
                                <a href="{{ url_for('admin.groups', search=search_term, sort_by='group_name', sort_order=next_sort_order('group_name')) }}"
                                    class="sort-link"><span>群组名称</span><span class="sort-indicator"></span></a>
                            </th>
                            <th class="sortable" data-sort="number">
                                <a href="{{ url_for('admin.groups', search=search_term, sort_by='call_count', sort_order=next_sort_order('call_count')) }}"
                                    class="sort-link"><span>调用次数</span><span class="sort-indicator"></span></a>
                            </th>
                            <th>角色/API</th>
                            <th class="sortable" data-sort="number">
                                <a href="{{ url_for('admin.groups', search=search_term, sort_by='rate', sort_order=next_sort_order('rate')) }}"
                                    class="sort-link"><span>触发几率</span><span class="sort-indicator"></span></a>
                            </th>
                            <th>Token使用</th>
                            <th class="sortable" data-sort="date">
                                <a href="{{ url_for('admin.groups', search=search_term, sort_by='update_time', sort_order=next_sort_order('update_time')) }}"
                                    class="sort-link"><span>更新时间</span><span class="sort-indicator"></span></a>
                            </th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for group in groups %}
                        <tr class="table-row-interactive" data-group-id="{{ group.group_id }}">
                            <td>
                                <div class="user-info">
                                    <div class="user-avatar">
                                        <div class="avatar-image">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                                <circle cx="12" cy="7" r="4"></circle>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="user-details">
                                        <span class="user-name">{{ group.group_name or '未命名群组' }}</span>
                                        {% if group.has_profile %}
                                        <span class="profile-indicator" title="存在用户画像">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div>{{ "{:,}".format(group.call_count or 0) }} 次</div>
                            </td>
                            <td>
                                <div class="stacked-badges">
                                    <span>{{ group.char or '未设置' }}</span>
                                    <span>{{ group.api or '默认' }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="rate-indicator">
                                    <div class="rate-bar">
                                        <div class="rate-fill" style="width: {{ (group.rate or 0) * 100 }}%"></div>
                                    </div>
                                    <span class="rate-text">{{ "%.1f"|format((group.rate or 0) * 100) }}%</span>
                                </div>
                            </td>
                            <td>
                                <div class="token-stats">
                                    <div class="token-item">
                                        <span class="token-label">输入</span>
                                        <span class="token-value text-primary">{{ "{:,}".format(group.input_token or 0)
                                            }}</span>
                                    </div>
                                    <div class="token-item">
                                        <span class="token-label">输出</span>
                                        <span class="token-value text-success">{{ "{:,}".format(group.output_token or 0)
                                            }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="date-info">
                                    <span class="date-value">{{ format_datetime(group.update_time).split(' ')[0]
                                        }}</span>
                                    <span class="date-time text-muted">{{ format_datetime(group.update_time).split('
                                        ')[1] }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button type="button" class="btn-glass view-group-btn" title="查看详情"
                                        data-group-id="{{ group.group_id }}">
                                        <span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg></span>
                                    </button>
                                    {% if session.user_role == 'admin' %}
                                    <button type="button" class="btn-glass edit-group-btn" title="编辑群组"
                                        data-group-id="{{ group.group_id }}">
                                        <span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></span>
                                    </button>
                                    {% endif %}
                                    <button type="button" class="btn-glass view-profile-btn" title="查看用户画像"
                                       data-group-id="{{ group.group_id }}">
                                        <span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></span>
                                    </button>
                                    <a href="{{ url_for('admin.group_dialogs', group_id=group.group_id) }}"
                                        class="btn-glass" title="查看对话">
                                        <span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></span>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if total_pages > 1 %}
            <div class="pagination-wrapper">
                <div class="pagination-info">
                    <span class="pagination-text">显示第 {{ (page-1)*per_page + 1 }} - {{ page*per_page if page*per_page <=
                            total_groups else total_groups }} 条，共 {{ total_groups }} 条记录</span>
                </div>
                <div class="pagination-controls">
                    {% if page > 1 %}
                    <a href="{{ url_for('admin.groups', page=page-1, search=search_term, sort_by=sort_by, sort_order=sort_order) }}"
                        class="btn-glass pagination-btn pagination-prev" aria-label="上一页">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        <span>上一页</span>
                    </a>
                    {% else %}
                    <span class="btn-glass pagination-btn pagination-prev disabled">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        <span>上一页</span>
                    </span>
                    {% endif %}
                    <div class="pagination-numbers">
                        {% for p in range(1, total_pages + 1) %}
                        {% if p == page %}
                        <span class="btn-glass pagination-number active">{{ p }}</span>
                        {% elif p <= 3 or p> total_pages - 3 or (p >= page - 2 and p <= page + 2) %} <a
                                href="{{ url_for('admin.groups', page=p, search=search_term, sort_by=sort_by, sort_order=sort_order) }}"
                                class="btn-glass pagination-number">{{ p }}</a>
                                {% elif p == 4 or p == total_pages - 3 %}
                                <span class="pagination-ellipsis">…</span>
                                {% endif %}
                                {% endfor %}
                    </div>
                    {% if page < total_pages %} <a
                        href="{{ url_for('admin.groups', page=page+1, search=search_term, sort_by=sort_by, sort_order=sort_order) }}"
                        class="btn-glass pagination-btn pagination-next" aria-label="下一页">
                        <span>下一页</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                        </a>
                        {% else %}
                        <span class="btn-glass pagination-btn pagination-next disabled">
                            <span>下一页</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </span>
                        {% endif %}
                </div>
            </div>
            {% endif %}

            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <h3 class="empty-state-title">暂无群组数据</h3>
                <p class="empty-state-description">
                    {% if search_term %}
                    没有找到包含 "{{ search_term }}" 的群组
                    {% else %}
                    系统中还没有任何群组数据
                    {% endif %}
                </p>
                {% if search_term %}
                <a href="{{ url_for('admin.groups') }}" class="btn btn-primary btn-sm mt-2">清除搜索条件</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}

{% block modals %}
<!-- 群组详情模态框 -->
<div class="modal-overlay" id="groupDetailModal">
    <div class="modal-container modal-large">
        <div class="modal-header">
            <div class="modal-title-section">
                <div class="modal-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <div class="modal-title-text">
                    <h3 class="modal-title">群组详情</h3>
                    <p class="modal-subtitle">查看群组的详细信息和统计数据</p>
                </div>
            </div>
            <button class="modal-close" aria-label="关闭">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div id="groupDetailContent" class="user-detail-content">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <span>加载中...</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#" id="viewGroupDialogsBtn" class="btn-glass btn-primary">查看对话</a>
        </div>
    </div>
</div>

{% if session.user_role == 'admin' %}
<!-- 编辑群组模态框 -->
<div class="modal-overlay" id="groupEditModal">
    <div class="modal-container modal-large">
        <div class="modal-header">
            <div class="modal-title-section">
                <div class="modal-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <div class="modal-title-text">
                    <h3 class="modal-title">编辑群组</h3>
                    <p class="modal-subtitle">修改群组的基本信息和配置</p>
                </div>
            </div>
            <button class="modal-close" aria-label="关闭">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <form id="groupEditForm" class="modern-form">
                <input type="hidden" id="editGroupId" name="group_id">
                <div class="form-sections">
                    <!-- Section 1: Basic Info -->
                    <div class="form-section">
                        <div class="section-header">
                            <h4 class="section-title">基本信息</h4>
                        </div>
                        <div class="form-group">
                            <label for="editGroupName" class="form-label">群组名称</label>
                            <input type="text" id="editGroupName" name="group_name" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="editActive" class="form-label">状态</label>
                            <div class="custom-select-wrapper">
                                <select class="original-select" id="editActive" name="active">
                                    <option value="1">活跃</option>
                                    <option value="0">非活跃</option>
                                </select>
                                <!-- Custom select will be generated by JS -->
                            </div>
                        </div>
                    </div>
                    <!-- Section 2: Core Config -->
                    <div class="form-section">
                        <div class="section-header">
                            <h4 class="section-title">核心配置</h4>
                        </div>
                        <div class="form-group">
                            <label for="editRate" class="form-label">触发几率 (0-1)</label>
                            <input type="number" id="editRate" name="rate" class="form-input" step="0.01" min="0"
                                max="1">
                        </div>
                        <div class="form-group">
                            <label for="editChar" class="form-label">角色</label>
                            <input type="text" id="editChar" name="char" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="editApi" class="form-label">API</label>
                            <input type="text" id="editApi" name="api" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="editPreset" class="form-label">预设</label>
                            <input type="text" id="editPreset" name="preset" class="form-input">
                        </div>
                    </div>
                    <!-- Section 3: Content Rules -->
                    <div class="form-section">
                        <div class="section-header">
                            <h4 class="section-title">内容规则</h4>
                        </div>
                        <div class="form-group">
                            <label for="editKeywords" class="form-label">关键词 (逗号分隔)</label>
                            <textarea id="editKeywords" name="keywords" class="form-input" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="editDisabledTopics" class="form-label">禁用话题 (逗号分隔)</label>
                            <textarea id="editDisabledTopics" name="disabled_topics" class="form-input"
                                rows="3"></textarea>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" id="saveGroupChangesBtn" class="btn-glass btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                <span>保存更改</span>
            </button>
        </div>
    </div>
</div>

<!-- 用户画像模态框 -->
<div class="modal-overlay" id="groupProfileModal">
    <div class="modal-container modal-large">
        <div class="modal-header">
            <div class="modal-title-section">
                <div class="modal-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                </div>
                <div class="modal-title-text">
                    <h3 class="modal-title">群组用户画像</h3>
                    <p class="modal-subtitle">查看和编辑群组内用户的画像</p>
                </div>
            </div>
            <button class="modal-close" aria-label="关闭">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="modal-body">
            <div id="groupProfileContent" class="user-detail-content">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <span>加载中...</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-glass" id="analyzeGroupProfilesBtn">
                <span>分析生成画像</span>
            </button>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/admin_groups.js') }}"></script>
{% endblock %}