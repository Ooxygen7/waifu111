{% extends "base.html" %}

{% block title %}对话详情 - CyberWaifu Bot 后台管理系统{% endblock %}

{% block page_title %}对话详情{% endblock %}

{% block content %}
<!-- 对话信息卡片 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h6 class="m-0 font-weight-bold">
                    <i class="bi bi-info-circle"></i> 对话信息 - ID: {{ conversation.conv_id }}
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>对话ID:</strong></td>
                                <td><span class="badge bg-primary">{{ conversation.conv_id }}</span></td>
                            </tr>
                            <tr>
                                <td><strong>用户ID:</strong></td>
                                <td><span class="badge bg-secondary">{{ conversation.user_id }}</span></td>
                            </tr>
                            <tr>
                                <td><strong>角色:</strong></td>
                                <td><span class="badge bg-info">{{ conversation.character or '未设置' }}</span></td>
                            </tr>
                            <tr>
                                <td><strong>预设:</strong></td>
                                <td><span class="badge bg-warning text-dark">{{ conversation.preset or '默认' }}</span></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>总轮次:</strong></td>
                                <td><span class="badge bg-success">{{ conversation.turns or 0 }}</span></td>
                            </tr>
                            <tr>
                                <td><strong>创建时间:</strong></td>
                                <td><small class="text-muted">{{ format_datetime(conversation.create_at) }}</small></td>
                            </tr>
                            <tr>
                                <td><strong>更新时间:</strong></td>
                                <td><small class="text-muted">{{ format_datetime(conversation.update_at) }}</small></td>
                            </tr>
                            <tr>
                                <td><strong>状态:</strong></td>
                                <td>
                                    {% if conversation.delete_mark %}
                                        <span class="badge bg-danger">已删除</span>
                                    {% else %}
                                        <span class="badge bg-success">正常</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                {% if conversation.summary %}
                <hr>
                <div>
                    <h6 class="text-primary"><i class="bi bi-file-text"></i> 对话摘要</h6>
                    <div class="alert alert-light border">
                        {{ conversation.summary }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 对话消息 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold">
                    <i class="bi bi-chat-dots"></i> 对话消息 ({{ dialogs|length }} 条)
                </h6>
                <div>
                    <button class="btn btn-light btn-sm" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> 刷新
                    </button>
                    <a href="{{ url_for('conversations') }}" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-arrow-left"></i> 返回列表
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                {% if dialogs %}
                <div class="chat-container" style="max-height: 70vh; overflow-y: auto;">
                    {% for dialog in dialogs %}
                    <div class="message-item border-bottom p-3 {% if dialog.role == 'user' %}bg-light{% endif %}">
                        <div class="d-flex align-items-start">
                            <div class="avatar-container me-3">
                                {% if dialog.role == 'user' %}
                                <div class="avatar bg-primary rounded-circle d-flex align-items-center justify-content-center text-white" 
                                     style="width: 40px; height: 40px;">
                                    <i class="bi bi-person"></i>
                                </div>
                                {% else %}
                                <div class="avatar bg-success rounded-circle d-flex align-items-center justify-content-center text-white" 
                                     style="width: 40px; height: 40px;">
                                    <i class="bi bi-robot"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="message-content flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <strong class="{% if dialog.role == 'user' %}text-primary{% else %}text-success{% endif %}">
                                            {% if dialog.role == 'user' %}
                                                <i class="bi bi-person"></i> 用户
                                            {% else %}
                                                <i class="bi bi-robot"></i> AI助手
                                            {% endif %}
                                        </strong>
                                        <small class="text-muted ms-2">
                                            轮次: {{ dialog.turn_order }}
                                            {% if dialog.msg_id %}
                                            | 消息ID: {{ dialog.msg_id }}
                                            {% endif %}
                                        </small>
                                    </div>
                                    <small class="text-muted">{{ format_datetime(dialog.created_at) }}</small>
                                </div>
                                
                                <!-- 原始内容 -->
                                <div class="message-text">
                                    <div class="mb-2">
                                        <h6 class="text-secondary mb-1">
                                            <i class="bi bi-file-text"></i> 原始内容
                                        </h6>
                                        <div class="border rounded p-2 bg-white">
                                            <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">{{ dialog.raw_content }}</pre>
                                        </div>
                                    </div>
                                    
                                    <!-- 处理后内容 -->
                                    {% if dialog.processed_content and dialog.processed_content != dialog.raw_content %}
                                    <div>
                                        <h6 class="text-info mb-1">
                                            <i class="bi bi-gear"></i> 处理后内容
                                        </h6>
                                        <div class="border rounded p-2 bg-info bg-opacity-10">
                                            <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">{{ dialog.processed_content }}</pre>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-chat-dots text-muted" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mt-3">暂无对话消息</h5>
                    <p class="text-muted">该对话还没有任何消息记录</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 操作按钮 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center">
                <a href="{{ url_for('conversations') }}" class="btn btn-secondary me-2">
                    <i class="bi bi-arrow-left"></i> 返回对话列表
                </a>
                <a href="{{ url_for('conversations', user_id=conversation.user_id) }}" class="btn btn-primary me-2">
                    <i class="bi bi-person"></i> 查看该用户的所有对话
                </a>
                <button class="btn btn-info" onclick="exportDialog()">
                    <i class="bi bi-download"></i> 导出对话
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 导出对话功能
function exportDialog() {
    const convId = {{ conversation.conv_id }};
    const dialogs = {{ dialogs|tojson|safe }};
    
    let exportText = `对话ID: ${convId}\n`;
    exportText += `用户ID: {{ conversation.user_id }}\n`;
    exportText += `角色: {{ conversation.character or '未设置' }}\n`;
    exportText += `预设: {{ conversation.preset or '默认' }}\n`;
    exportText += `创建时间: {{ format_datetime(conversation.create_at) }}\n`;
    exportText += `总轮次: {{ conversation.turns or 0 }}\n`;
    exportText += `\n${'='.repeat(50)}\n\n`;
    
    dialogs.forEach(dialog => {
        const role = dialog.role === 'user' ? '用户' : 'AI助手';
        exportText += `[${role}] - 轮次 ${dialog.turn_order} - ${dialog.created_at}\n`;
        exportText += `${dialog.raw_content}\n`;
        if (dialog.processed_content && dialog.processed_content !== dialog.raw_content) {
            exportText += `[处理后]: ${dialog.processed_content}\n`;
        }
        exportText += `\n${'-'.repeat(30)}\n\n`;
    });
    
    // 创建下载链接
    const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `conversation_${convId}_${new Date().toISOString().slice(0, 10)}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// 自动滚动到最新消息
document.addEventListener('DOMContentLoaded', function() {
    const chatContainer = document.querySelector('.chat-container');
    if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
});

// 消息内容展开/收起功能
document.addEventListener('DOMContentLoaded', function() {
    const messageTexts = document.querySelectorAll('.message-text pre');
    messageTexts.forEach(pre => {
        if (pre.scrollHeight > 150) {
            pre.style.maxHeight = '150px';
            pre.style.overflow = 'hidden';
            
            const expandBtn = document.createElement('button');
            expandBtn.className = 'btn btn-sm btn-outline-secondary mt-1';
            expandBtn.innerHTML = '<i class="bi bi-chevron-down"></i> 展开';
            expandBtn.onclick = function() {
                if (pre.style.maxHeight === '150px') {
                    pre.style.maxHeight = 'none';
                    expandBtn.innerHTML = '<i class="bi bi-chevron-up"></i> 收起';
                } else {
                    pre.style.maxHeight = '150px';
                    expandBtn.innerHTML = '<i class="bi bi-chevron-down"></i> 展开';
                }
            };
            
            pre.parentNode.appendChild(expandBtn);
        }
    });
});
</script>
{% endblock %}