{% extends "base.html" %}
{% set page_has_custom_scripts = true %}

{% block title %}对话详情 - CyberWaifu Bot 后台管理系统{% endblock %}

{% block page_title %}对话详情{% endblock %}

{% block content %}
<div class="content-wrapper dialogs-page">
    <!-- 对话信息卡片 (可折叠) -->
    <div class="glass-card collapsible-card collapsed" id="conversationDetailsCard">
        <div class="card-header collapsible-header">
            <div class="header-title">
                <i class="fas fa-info-circle header-icon"></i>
                <h3 class="card-title-text">对话详情</h3>
            </div>
            <div class="header-actions">
                <button id="exportBtn" class="btn btn-glass btn-sm header-action-btn" title="导出对话为JSON">
                    <i class="fas fa-download"></i> <span>导出</span>
                </button>
                <a href="{{ url_for('admin.conversations') }}" class="btn btn-glass btn-sm header-action-btn" title="返回对话列表">
                    <i class="fas fa-arrow-left"></i> <span>返回</span>
                </a>
                <button class="btn btn-glass btn-sm btn-icon" id="toggleDetailsBtn" title="折叠/展开">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="card-body collapsible-content">
            <div class="details-grid">
                <div class="detail-item"><span class="detail-label">对话ID:</span> <span class="badge primary">{{
                        conversation.conv_id }}</span></div>
                <div class="detail-item"><span class="detail-label">用户ID:</span> <span class="badge secondary">{{
                        conversation.user_id }}</span></div>
                <div class="detail-item"><span class="detail-label">角色:</span>
                    {% if conversation.character %}
                    <span class="badge info">{{ conversation.character }}</span>
                    {% else %}
                    <span class="text-muted">未设置</span>
                    {% endif %}
                </div>
                <div class="detail-item"><span class="detail-label">预设:</span>
                    {% if conversation.preset %}
                    <span class="badge warning">{{ conversation.preset }}</span>
                    {% else %}
                    <span class="text-muted">默认</span>
                    {% endif %}
                </div>
                <div class="detail-item"><span class="detail-label">轮次:</span> <span class="badge success">{{
                        conversation.turns or 0 }}</span></div>
                <div class="detail-item"><span class="detail-label">状态:</span>
                    {% if conversation.delete_mark %}
                    <span class="badge danger">已删除</span>
                    {% else %}
                    <span class="badge success">正常</span>
                    {% endif %}
                </div>
                <div class="detail-item full-width"><span class="detail-label">更新时间:</span> <span class="text-muted">{{
                        format_datetime(conversation.update_at) }}</span></div>
                {% if conversation.summary %}
                <div class="detail-item full-width summary-item collapsible-summary">
                    <div class="summary-header">
                        <span class="detail-label">对话摘要</span>
                        <button class="btn btn-glass btn-sm btn-icon toggle-summary-btn" title="折叠/展开">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    <div class="summary-content">
                        <p class="summary-text">{{ conversation.summary }}</p>
                    </div>
                </div>
                {% endif %}

                {% if detailed_summary %}
                <div class="detail-item full-width summary-item collapsible-summary">
                    <div class="summary-header">
                        <span class="detail-label">详细总结</span>
                        <button class="btn btn-glass btn-sm btn-icon toggle-summary-btn" title="折叠/展开">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    <div class="summary-content">
                        {% for summary_part in detailed_summary %}
                        <div class="summary-block">
                            <div class="summary-meta">
                                <span class="badge info">总结轮次: {{ summary_part.summary_area }}</span>
                            </div>
                            <p class="summary-text">{{ summary_part.content | replace('\n', '<br>') | safe }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 对话内容 -->
    {% if dialogs %}
    <div class="glass-card chat-history-card">
        <div class="card-header">
            <div class="header-title">
                <i class="fas fa-comments header-icon"></i>
                <h3 class="card-title-text">
                    对话记录
                    {% if search_keyword %}
                    <span class="header-subtitle"> (搜索结果: {{ dialogs|length }} 条)</span>
                    {% else %}
                    <span class="header-subtitle"> (共 {{ dialogs|length }} 条)</span>
                    {% endif %}
                </h3>
            </div>
            <div class="header-actions">
                <form method="GET" class="search-form">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" name="search" class="search-input" placeholder="搜索消息..."
                            value="{{ search_keyword or '' }}" aria-label="搜索消息内容">
                        {% if search_keyword %}
                        <a href="{{ url_for('admin.dialogs', conv_id=conversation.conv_id) }}" class="clear-button"
                            title="清除搜索">
                            <i class="fas fa-times"></i>
                        </a>
                        {% endif %}
                    </div>
                    <button type="submit" class="btn btn-glass btn-primary btn-sm">
                        <i class="fas fa-search"></i> <span>搜索</span>
                    </button>
                </form>
            </div>
        </div>
        <div class="card-body">
            {% if search_keyword and dialogs %}
            <div class="search-notice">
                <i class="fas fa-info-circle"></i>
                点击任意搜索结果可跳转到完整对话页面查看上下文
            </div>
            {% endif %}
            <div class="message-list" id="messageList">
                {% for dialog in dialogs %}
                <div class="message-bubble-container {% if dialog.role == 'user' %}user-message{% else %}ai-message{% endif %}"
                    id="msg-{{ dialog.id }}" data-dialog-id="{{ dialog.id }}"
                    data-raw-content="{{ dialog.raw_content | e }}"
                    data-processed-content="{{ (dialog.processed_content if dialog.processed_content else dialog.raw_content) | e }}"
                    data-turn="{{ dialog.turn_order }}" data-time="{{ format_datetime(dialog.created_at) }}"
                    data-msg-id="{{ dialog.msg_id or '' }}" data-role="{{ dialog.role }}">

                    {% if dialog.role == 'user' %}
                    <!-- 用户消息 (右侧，蓝色) -->
                    <div class="message-row user-message">
                        <div class="message-bubble user-bubble" tabindex="0"
                            aria-label="用户消息，轮次 {{ dialog.turn_order }}">
                            <div class="message-content">
                                {{ (dialog.processed_content if dialog.processed_content else dialog.raw_content) |
                                replace('\n', '<br>') | highlight_search_keyword(search_keyword) | safe }}
                            </div>
                            <div class="message-time">
                                <i class="fas fa-clock fa-xs"></i> {{ format_datetime(dialog.created_at) }}
                            </div>
                            <!-- 编辑按钮 -->
                            {% if session.user_role == 'admin' %}
                            <button class="edit-btn" aria-label="编辑消息">
                                <i class="fas fa-edit"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <!-- AI消息 (左侧，灰色) -->
                    <div class="message-row ai-message">
                        <div class="message-bubble ai-bubble" tabindex="0" aria-label="AI消息，轮次 {{ dialog.turn_order }}">
                            <div class="message-content">
                                {{ (dialog.processed_content if dialog.processed_content else dialog.raw_content) |
                                replace('\n', '<br>') | highlight_search_keyword(search_keyword) | safe }}
                            </div>
                            <div class="message-time">
                                <i class="fas fa-clock fa-xs"></i> {{ format_datetime(dialog.created_at) }}
                            </div>
                            <!-- 编辑按钮 -->
                            {% if session.user_role == 'admin' %}
                            <button class="edit-btn" aria-label="编辑消息">
                                <i class="fas fa-edit"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-chat-dots text-muted" style="font-size: 3rem;"></i>
                <h5 class="text-muted mt-3">暂无对话消息</h5>
                <p class="text-muted">该对话还没有任何消息记录</p>
            </div>
            {% endif %}
        </div>
    </div>

    {% if total_pages > 1 %}
    <div class="pagination-wrapper">
        <div class="pagination-info">
            第 {{ page }} 页 / 共 {{ total_pages }} 页
        </div>
        <div class="pagination-controls">
            {% if page > 1 %}
            <a href="{{ url_for('admin.dialogs', conv_id=conversation.conv_id, page=1, search=search_keyword) }}" class="btn btn-glass pagination-btn" title="第一页"><i class="fas fa-angle-double-left"></i></a>
            <a href="{{ url_for('admin.dialogs', conv_id=conversation.conv_id, page=page-1, search=search_keyword) }}" class="btn btn-glass pagination-btn" title="上一页"><i class="fas fa-angle-left"></i></a>
            {% endif %}

            {% for p in range(max(1, page-2), min(total_pages+1, page+3)) %}
            <a href="{{ url_for('admin.dialogs', conv_id=conversation.conv_id, page=p, search=search_keyword) }}" class="btn btn-glass pagination-number {{ 'active' if p == page else '' }}">{{ p }}</a>
            {% endfor %}

            {% if page < total_pages %}
            <a href="{{ url_for('admin.dialogs', conv_id=conversation.conv_id, page=page+1, search=search_keyword) }}" class="btn btn-glass pagination-btn" title="下一页"><i class="fas fa-angle-right"></i></a>
            <a href="{{ url_for('admin.dialogs', conv_id=conversation.conv_id, page=total_pages, search=search_keyword) }}" class="btn btn-glass pagination-btn" title="最后一页"><i class="fas fa-angle-double-right"></i></a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
</div>

<!-- 消息详情模态框 -->
<div class="modal-overlay" id="messageDetailModal" aria-hidden="true" style="display: none; visibility: hidden;">
    <div class="modal-container" role="dialog" aria-labelledby="messageDetailModalLabel" aria-modal="true">
        <div class="modal-header">
            <h2 class="modal-title" id="messageDetailModalLabel">
                <i class="fas fa-info-circle"></i>
                消息详情
            </h2>
            <button class="modal-close" aria-label="关闭模态框">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="detail-card">
                <div class="message-meta-container collapsible-card collapsed">
                    <div class="meta-header collapsible-header">
                        <h3 class="section-title">
                            <i class="fas fa-info-circle"></i>
                            消息元数据
                        </h3>
                        <button class="btn btn-glass btn-sm btn-icon" title="折叠/展开">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    <div class="message-meta collapsible-content">
                        <div class="meta-item">
                            <span class="meta-label">角色:</span>
                            <span class="meta-value" id="modal-role"></span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">轮次:</span>
                            <span class="meta-value" id="modal-turn"></span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">时间:</span>
                            <span class="meta-value" id="modal-time"></span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">消息ID:</span>
                            <span class="meta-value" id="modal-msg-id"></span>
                        </div>
                    </div>
                </div>
                <div class="detail-section">
                    <h3 class="section-title">
                        <i class="fas fa-code"></i>
                        原始内容
                    </h3>
                    <div class="content-display raw-content" id="modal-raw-content"></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            {% if session.user_role == 'admin' %}
            <button class="btn btn-glass btn-primary" id="editMessageDetailBtn">
                <i class="fas fa-edit"></i>
                编辑内容
            </button>
            {% endif %}
        </div>
    </div>
</div>

{% if session.user_role == 'admin' %}
<!-- 编辑消息模态框 -->
<div class="modal-overlay" id="editMessageModal" aria-hidden="true" style="display: none; visibility: hidden;">
    <div class="modal-container" role="dialog" aria-labelledby="editMessageModalLabel" aria-modal="true">
        <div class="modal-header">
            <h2 class="modal-title" id="editMessageModalLabel">
                <i class="fas fa-edit"></i>
                编辑消息内容
            </h2>
            <button class="modal-close" aria-label="关闭模态框">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="edit-form-container">
                <div class="form-group">
                    <label for="edit-content" class="form-label">
                        <i class="fas fa-comment-alt"></i>
                        处理后内容
                    </label>
                    <textarea id="edit-content" class="form-input" rows="10" placeholder="请输入新的消息内容..."></textarea>
                </div>
                <div class="form-info-banner">
                    <i class="fas fa-info-circle"></i>
                    <span>编辑的是处理后内容，原始内容保持不变。</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="saveEditBtn" class="btn btn-glass btn-primary">
                <i class="fas fa-save"></i>
                <span>保存</span>
            </button>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_glass.css') }}">
{% endblock %}

{% block scripts %}
<script>
    // 安全地将后端数据传递给前端
    window.conversationData = {{ conversation | tojson | safe }};
    window.dialogsData = {{ dialogs | tojson | safe }};
    window.dialogsUrl = "{{ request.url_root.rstrip('/') }}";
</script>
<script src="{{ url_for('static', filename='js/dialogs.js') }}" defer></script>
<!-- The conflicting modal-dialog.js script has been removed to prevent issues. -->
<!-- 移除冲突的 modal-dialog.js 脚本 -->
{% endblock %}