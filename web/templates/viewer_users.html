{% extends "viewer_base.html" %}

{% block title %}Áî®Êà∑ÂàóË°® - CyberWaifu Bot ÊµèËßàÁ≥ªÁªü{% endblock %}

{% block page_title %}Áî®Êà∑ÂàóË°®{% endblock %}

{% block content %}
<div class="content-wrapper">
<div class="card">
    <div class="card-header">
        <div class="header-container">
            <div class="header-title">
                <h3><i class="icon">üë•</i> Áî®Êà∑ÁÆ°ÁêÜ</h3>
            </div>
            <div class="search-container">
                <form method="GET" class="search-form">
                    <div class="search-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>
                    <input type="text" name="search" class="search-input" 
                           placeholder="ÊêúÁ¥¢Áî®Êà∑ID„ÄÅÁî®Êà∑Âêç..." value="{{ search_term }}"
                           aria-label="ÊêúÁ¥¢Áî®Êà∑">
                    <div class="search-loading"></div>
                    {% if search_term %}
                    <a href="{{ url_for('viewer_users') }}" class="clear-button" aria-label="Ê∏ÖÈô§ÊêúÁ¥¢">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </a>
                    {% endif %}
                    <button type="submit" class="search-button" aria-label="ÊêúÁ¥¢">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </button>
                </form>
                {% if search_term %}
                <div class="search-status">ÊâæÂà∞‰∏é "{{ search_term }}" Áõ∏ÂÖ≥ÁöÑÁªìÊûú</div>
                {% endif %}
            </div>
        </div>
        
        <div class="filter-container mt-md">
            <div class="filter-label">Á≠õÈÄâÔºö</div>
            
            <button class="filter-button" aria-label="ÊâìÂºÄÁ≠õÈÄâÈÄâÈ°π">
                <span class="filter-button-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                </span>
                <span>Á≠õÈÄâÊù°‰ª∂</span>
            </button>
            
            <div class="filter-dropdown">
                <div class="filter-group">
                    <div class="filter-group-title">Ê≥®ÂÜåÊó∂Èó¥</div>
                    <div class="filter-options">
                        <div class="filter-option" data-key="date" data-value="today">‰ªäÂ§©</div>
                        <div class="filter-option" data-key="date" data-value="week">Êú¨Âë®</div>
                        <div class="filter-option" data-key="date" data-value="month">Êú¨Êúà</div>
                        <div class="filter-option" data-key="date" data-value="year">‰ªäÂπ¥</div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <div class="filter-group-title">ÂØπËØùÊï∞Èáè</div>
                    <div class="filter-options">
                        <div class="filter-option" data-key="conversations" data-value="0">Êó†ÂØπËØù</div>
                        <div class="filter-option" data-key="conversations" data-value="1-10">1-10</div>
                        <div class="filter-option" data-key="conversations" data-value="10+">10+</div>
                        <div class="filter-option" data-key="conversations" data-value="50+">50+</div>
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-text" id="clear-filters">Ê∏ÖÈô§Á≠õÈÄâ</button>
                    <button class="btn btn-primary" id="apply-filters">Â∫îÁî®Á≠õÈÄâ</button>
                </div>
            </div>
            
            <div class="filter-tags">
                <!-- Á≠õÈÄâÊ†áÁ≠æÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÊ∑ªÂä† -->
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if users %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="number">
                            <a href="{{ url_for('viewer_users', search=search_term, sort_by='uid', sort_order=next_sort_order('uid')) }}" 
                               class="sort-link" aria-label="ÊåâÁî®Êà∑IDÊéíÂ∫è">
                                <span>Áî®Êà∑ID</span>
                                <span class="sort-indicator">
                                    {% if sort_by == 'uid' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                            {% if sort_order == 'asc' %}
                                            <polyline points="18 15 12 9 6 15"></polyline>
                                            {% else %}
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                            {% endif %}
                                        </svg>
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <polyline points="19 12 12 19 5 12"></polyline>
                                        </svg>
                                    {% endif %}
                                </span>
                            </a>
                        </th>
                        <th class="sortable" data-sort="text">
                            <a href="{{ url_for('viewer_users', search=search_term, sort_by='user_name', sort_order=next_sort_order('user_name')) }}" 
                               class="sort-link" aria-label="ÊåâÁî®Êà∑ÂêçÊéíÂ∫è">
                                <span>Áî®Êà∑Âêç</span>
                                <span class="sort-indicator">
                                    {% if sort_by == 'user_name' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                            {% if sort_order == 'asc' %}
                                            <polyline points="18 15 12 9 6 15"></polyline>
                                            {% else %}
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                            {% endif %}
                                        </svg>
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <polyline points="19 12 12 19 5 12"></polyline>
                                        </svg>
                                    {% endif %}
                                </span>
                            </a>
                        </th>
                        <th>ÂßìÂêç</th>
                        <th class="sortable" data-sort="number">
                            <a href="{{ url_for('viewer_users', search=search_term, sort_by='conversations', sort_order=next_sort_order('conversations')) }}" 
                               class="sort-link" aria-label="ÊåâÂØπËØùÊï∞ÊéíÂ∫è">
                                <span>ÂØπËØùÊï∞</span>
                                <span class="sort-indicator">
                                    {% if sort_by == 'conversations' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                            {% if sort_order == 'asc' %}
                                            <polyline points="18 15 12 9 6 15"></polyline>
                                            {% else %}
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                            {% endif %}
                                        </svg>
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <polyline points="19 12 12 19 5 12"></polyline>
                                        </svg>
                                    {% endif %}
                                </span>
                            </a>
                        </th>
                        <th class="sortable" data-sort="number">
                            <a href="{{ url_for('viewer_users', search=search_term, sort_by='dialog_turns', sort_order=next_sort_order('dialog_turns')) }}" 
                               class="sort-link" aria-label="ÊåâÊ∂àÊÅØÊï∞ÊéíÂ∫è">
                                <span>Ê∂àÊÅØÊï∞</span>
                                <span class="sort-indicator">
                                    {% if sort_by == 'dialog_turns' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                            {% if sort_order == 'asc' %}
                                            <polyline points="18 15 12 9 6 15"></polyline>
                                            {% else %}
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                            {% endif %}
                                        </svg>
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <polyline points="19 12 12 19 5 12"></polyline>
                                        </svg>
                                    {% endif %}
                                </span>
                            </a>
                        </th>
                        <th class="sortable" data-sort="date">
                            <a href="{{ url_for('viewer_users', search=search_term, sort_by='create_at', sort_order=next_sort_order('create_at')) }}" 
                               class="sort-link" aria-label="ÊåâÊ≥®ÂÜåÊó∂Èó¥ÊéíÂ∫è">
                                <span>Ê≥®ÂÜåÊó∂Èó¥</span>
                                <span class="sort-indicator">
                                    {% if sort_by == 'create_at' %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="{{ 'sort-asc' if sort_order == 'asc' else 'sort-desc' }}">
                                            {% if sort_order == 'asc' %}
                                            <polyline points="18 15 12 9 6 15"></polyline>
                                            {% else %}
                                            <polyline points="6 9 12 15 18 9"></polyline>
                                            {% endif %}
                                        </svg>
                                    {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sort-both">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <polyline points="19 12 12 19 5 12"></polyline>
                                        </svg>
                                    {% endif %}
                                </span>
                            </a>
                        </th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr class="table-row-interactive">
                        <td>
                            <span class="badge primary user-id">{{ user.uid }}</span>
                        </td>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">
                                    <div class="avatar-image">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                            <circle cx="12" cy="7" r="4"></circle>
                                        </svg>
                                    </div>
                                </div>
                                <div class="user-details">
                                    <span class="user-name">{{ user.user_name or 'Êú™ËÆæÁΩÆ' }}</span>
                                    {% if user.is_active %}
                                    <span class="user-status active" title="Ê¥ªË∑ÉÁî®Êà∑"></span>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if user.first_name or user.last_name %}
                                <span class="user-fullname">{{ user.first_name or '' }} {{ user.last_name or '' }}</span>
                            {% else %}
                                <span class="text-muted">Êú™ËÆæÁΩÆ</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="stat-badge">
                                <span class="stat-value">{{ user.conversations or 0 }}</span>
                                <span class="stat-label">ÂØπËØù</span>
                            </div>
                        </td>
                        <td>
                            <div class="stat-badge">
                                <span class="stat-value">{{ user.dialog_turns or 0 }}</span>
                                <span class="stat-label">Ê∂àÊÅØ</span>
                            </div>
                        </td>
                        <td>
                            <div class="date-info">
                                <span class="date-value">{{ format_datetime(user.create_at).split(' ')[0] }}</span>
                                <span class="date-time text-muted">{{ format_datetime(user.create_at).split(' ')[1] }}</span>
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="{{ url_for('viewer_conversations', search=user.uid) }}" 
                                   class="btn btn-icon btn-sm" title="Êü•ÁúãÂØπËØù" aria-label="Êü•ÁúãÁî®Êà∑ÂØπËØù">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                    </svg>
                                </a>
                                <button class="btn btn-icon btn-sm" title="Êü•ÁúãËØ¶ÊÉÖ" aria-label="Êü•ÁúãÁî®Êà∑ËØ¶ÊÉÖ">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="12" y1="8" x2="12" y2="16"></line>
                                        <line x1="8" y1="12" x2="16" y2="12"></line>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- ÂàÜÈ°µ -->
        {% if total_pages > 1 %}
        <div class="pagination-container">
            <div class="pagination-info">
                ÊòæÁ§∫Á¨¨ <span class="text-primary">{{ (page - 1) * per_page + 1 }}</span> Ëá≥ 
                <span class="text-primary">{{ min(page * per_page, total_users) }}</span> Êù°Ôºå
                ÂÖ± <span class="text-primary">{{ total_users }}</span> Êù°ËÆ∞ÂΩï
            </div>
            <div class="pagination">
                {% if page > 1 %}
                <a class="page-item" href="{{ url_for('viewer_users', page=1, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="Á¨¨‰∏ÄÈ°µ" title="Á¨¨‰∏ÄÈ°µ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="11 17 6 12 11 7"></polyline>
                        <polyline points="18 17 13 12 18 7"></polyline>
                    </svg>
                </a>
                <a class="page-item" href="{{ url_for('viewer_users', page=page-1, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="‰∏ä‰∏ÄÈ°µ" title="‰∏ä‰∏ÄÈ°µ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </a>
                {% else %}
                <span class="page-item disabled" aria-disabled="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="11 17 6 12 11 7"></polyline>
                        <polyline points="18 17 13 12 18 7"></polyline>
                    </svg>
                </span>
                <span class="page-item disabled" aria-disabled="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </span>
                {% endif %}
                
                {% for p in range(max(1, page-2), min(total_pages+1, page+3)) %}
                <a class="page-item {{ 'active' if p == page else '' }}" href="{{ url_for('viewer_users', page=p, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="Á¨¨{{ p }}È°µ" {% if p == page %}aria-current="page"{% endif %}>
                    {{ p }}
                </a>
                {% endfor %}
                
                {% if page < total_pages %}
                <a class="page-item" href="{{ url_for('viewer_users', page=page+1, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="‰∏ã‰∏ÄÈ°µ" title="‰∏ã‰∏ÄÈ°µ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </a>
                <a class="page-item" href="{{ url_for('viewer_users', page=total_pages, search=search_term, sort_by=sort_by, sort_order=sort_order) }}" aria-label="ÊúÄÂêé‰∏ÄÈ°µ" title="ÊúÄÂêé‰∏ÄÈ°µ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="13 17 18 12 13 7"></polyline>
                        <polyline points="6 17 11 12 6 7"></polyline>
                    </svg>
                </a>
                {% else %}
                <span class="page-item disabled" aria-disabled="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </span>
                <span class="page-item disabled" aria-disabled="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="13 17 18 12 13 7"></polyline>
                        <polyline points="6 17 11 12 6 7"></polyline>
                    </svg>
                </span>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="7" r="4"></circle>
                    <path d="M5 21v-2a4 4 0 0 1 4-4h6a4 4 0 0 1 4 4v2"></path>
                    <line x1="8" y1="3" x2="16" y2="21"></line>
                </svg>
            </div>
            <h5 class="empty-title">ÊöÇÊó†Áî®Êà∑Êï∞ÊçÆ</h5>
            {% if search_term %}
            <p class="empty-text">Ê≤°ÊúâÊâæÂà∞ÂåπÈÖç "<span class="search-highlight">{{ search_term }}</span>" ÁöÑÁî®Êà∑</p>
            <a href="{{ url_for('viewer_users') }}" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-xs">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                Ê∏ÖÈô§ÊêúÁ¥¢
            </a>
            {% else %}
            <p class="empty-text">Á≥ªÁªü‰∏≠ËøòÊ≤°Êúâ‰ªª‰ΩïÁî®Êà∑Êï∞ÊçÆ</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>


</div>

{% block scripts %}
<script src="{{ url_for('static', filename='js/search.js') }}"></script>
<script src="{{ url_for('static', filename='js/user-table.js') }}"></script>
<script src="{{ url_for('static', filename='js/user-filter.js') }}"></script>
{% endblock %}
{% endblock %}