# 内联查询使用指南

## 概述

你的机器人已经支持内联查询功能！内联查询允许用户在任何聊天中通过输入 `@你的机器人用户名` 来快速访问机器人功能，无需切换到机器人私聊。

## 当前可用的内联查询类型

### 1. 角色查询 (`char`)
- **用法**: `@botname char [搜索词]`
- **功能**: 查询和浏览可用的角色
- **示例**:
  - `@botname char` - 显示所有角色
  - `@botname char 脆脆` - 搜索包含"脆脆"的角色
  - `@botname char miku` - 搜索包含"miku"的角色

### 2. 预设查询 (`preset`)
- **用法**: `@botname preset [搜索词]`
- **功能**: 查询和浏览可用的对话预设
- **示例**:
  - `@botname preset` - 显示所有预设
  - `@botname preset 一般` - 搜索包含"一般"的预设
  - `@botname preset nsfw` - 搜索包含"nsfw"的预设

### 3. 帮助信息 (`help`)
- **用法**: `@botname help`
- **功能**: 获取内联查询使用帮助
- **示例**:
  - `@botname help` - 显示帮助信息

### 4. 默认查询
- **用法**: `@botname` (不输入任何关键词)
- **功能**: 显示基本使用提示和可用查询类型

## 如何启用内联查询

### 1. Telegram Bot 设置

你需要在 BotFather 中为你的机器人启用内联查询功能：

1. 打开 Telegram，搜索并启动 `@BotFather`
2. 发送 `/mybots` 命令
3. 选择你的机器人
4. 选择 "Bot Settings"
5. 选择 "Inline Mode"
6. 选择 "Turn on" 启用内联模式
7. 可选：设置内联查询的占位符文本，例如："输入 help 获取帮助"

### 2. 代码配置

好消息！你的代码已经完全配置好了：

- ✅ 内联查询处理器已在 `bot_run.py` 中注册
- ✅ 所有内联查询模块已实现并可用
- ✅ 错误处理和日志记录已配置
- ✅ 测试通过，功能正常

## 技术实现细节

### 架构概览

```
bot_core/inline_handlers/
├── __init__.py          # 模块导出
├── base.py             # 基础类和元数据
├── inline.py           # 主调度器和处理器加载
├── character.py        # 角色查询处理器
├── preset.py           # 预设查询处理器
├── help.py             # 帮助信息处理器
├── default.py          # 默认查询处理器
├── test_handler.py     # 测试处理器
└── logging_config.py   # 日志配置
```

### 主要组件

1. **InlineQueryHandlers**: 主调度器，负责加载和路由查询
2. **BaseInlineQuery**: 所有内联查询处理器的基类
3. **InlineMeta**: 处理器元数据配置
4. **ErrorResultFactory**: 统一的错误结果生成

### 扩展新的内联查询类型

要添加新的内联查询类型，只需：

1. 在 `bot_core/inline_handlers/` 目录下创建新的处理器文件
2. 继承 `BaseInlineQuery` 类
3. 实现 `handle_inline_query` 方法
4. 定义 `meta` 属性
5. 系统会自动发现并加载新的处理器

## 使用示例

### 在群聊中使用

1. 在任何群聊中输入 `@你的机器人用户名 char`
2. 机器人会显示可用角色列表
3. 点击选择一个角色
4. 角色信息会发送到群聊中

### 在私聊中使用

1. 在任何私聊中输入 `@你的机器人用户名 help`
2. 机器人会显示帮助信息
3. 点击选择帮助主题
4. 详细帮助信息会发送到聊天中

## 注意事项

1. **仅查看功能**: 内联查询仅用于查看信息，不会执行切换角色或预设等操作
2. **缓存**: 查询结果会被缓存以提高性能
3. **权限**: 内联查询在所有聊天中都可用，无需特殊权限
4. **限制**: 每次查询最多返回50个结果

## 故障排除

### 内联查询不工作

1. 确认在 BotFather 中启用了内联模式
2. 检查机器人是否正常运行
3. 查看日志文件中的错误信息

### 查询结果为空

1. 检查角色和预设文件是否存在
2. 确认文件权限正确
3. 查看日志中的数据加载错误

### 性能问题

1. 内联查询结果会被缓存
2. 可以调整各处理器的 `cache_time` 设置
3. 监控日志中的性能指标

## 总结

你的机器人现在完全支持内联查询功能！只需要在 BotFather 中启用内联模式，用户就可以在任何聊天中使用 `@你的机器人用户名` 来快速访问角色、预设和帮助信息。