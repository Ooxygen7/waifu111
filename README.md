# CyberWaifu Bot

ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ Telegram AI èŠå¤©æœºå™¨äººï¼ŒåŸºäºç°ä»£åŒ–çš„åˆ†å±‚æ¶æ„è®¾è®¡ã€‚æ”¯æŒå¤šè§’è‰²å¯¹è¯ã€åŠ å¯†è´§å¸åˆ†æã€æ™ºèƒ½ç¾¤ç»„ç®¡ç†ç­‰é«˜çº§åŠŸèƒ½ï¼Œé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ç¡®ä¿é«˜å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

**æµ‹è¯•ç‰ˆæœºå™¨äººï¼š** https://t.me/waifucui_bot

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- ğŸ¤– **å¤šè§’è‰² AI å¯¹è¯**ï¼šæ”¯æŒé¢„è®¾å’Œè‡ªå®šä¹‰è§’è‰²ï¼Œæ™ºèƒ½å¯¹è¯ç®¡ç†
- ğŸ“Š **åŠ å¯†è´§å¸åˆ†æ**ï¼šé›†æˆ CCXT åº“çš„å®æ—¶å¸‚åœºæ•°æ®åˆ†æï¼Œæ”¯æŒå¤šç©ºå€¾å‘åˆ†æ
- ğŸ‘¥ **æ™ºèƒ½ç¾¤ç»„ç®¡ç†**ï¼šå…³é”®è¯è§¦å‘ã€å›å¤é¢‘ç‡æ§åˆ¶ã€ç”¨æˆ·æƒé™ç®¡ç†
- ğŸ› ï¸ **LLM å·¥å…·è°ƒç”¨**ï¼šç»Ÿä¸€çš„å·¥å…·æ³¨å†Œå’Œè°ƒç”¨ç³»ç»Ÿï¼Œæ”¯æŒæ•°æ®åº“æŸ¥è¯¢å’Œå¸‚åœºåˆ†æ
- ğŸŒ **Web ç®¡ç†åå°**ï¼šåŸºäº Flask çš„ç°ä»£åŒ–ç®¡ç†ç•Œé¢
- ğŸ’¾ **æ•°æ®æŒä¹…åŒ–**ï¼šSQLite æ•°æ®åº“ + ä»“åº“æ¨¡å¼çš„æ•°æ®è®¿é—®å±‚
- ğŸ”§ **é«˜åº¦å¯æ‰©å±•**ï¼šæ¨¡å—åŒ–æ¶æ„ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½

## ğŸ“ é¡¹ç›®æ¶æ„

```
cyberwaifu_bot/
â”œâ”€â”€ ğŸ“„ bot_run.py                    # ğŸš€ åº”ç”¨å¯åŠ¨å…¥å£
â”œâ”€â”€ ğŸ“„ Dockerfile                    # ğŸ³ Docker éƒ¨ç½²é…ç½®
â”œâ”€â”€ ğŸ“„ requirements.txt              # ğŸ“¦ Python ä¾èµ–åŒ…
â”œâ”€â”€ ğŸ“ agent/                        # ğŸ§  AI Agent & å·¥å…·ç³»ç»Ÿ
â”‚   â”œâ”€â”€ ğŸ“„ llm_functions.py          # ğŸ’¡ LLM æ ¸å¿ƒåŠŸèƒ½ (ç”¨æˆ·ç”»åƒç”Ÿæˆç­‰)
â”‚   â”œâ”€â”€ ğŸ“„ tools.py                  # ğŸ”¨ å·¥å…·å®ç° (å¸‚åœºåˆ†æ, æ•°æ®åº“æ“ä½œ)
â”‚   â”œâ”€â”€ ğŸ“„ tools_handler.py          # ğŸ”„ å·¥å…·è°ƒç”¨å¤„ç†å™¨
â”‚   â””â”€â”€ ğŸ“„ tools_registry.py         # ğŸ“‹ å·¥å…·æ³¨å†Œä¸æç¤ºç”Ÿæˆ
â”œâ”€â”€ ğŸ“ bot_core/                     # ğŸ¤– æœºå™¨äººæ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ ğŸ“„ models.py                 # ğŸ“Š æ•°æ®æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ ğŸ“„ repository.py             # ğŸª ä¼ ç»Ÿæ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ ğŸ“ callback_handlers/        # ğŸ”„ å›è°ƒæŸ¥è¯¢å¤„ç†å™¨
â”‚   â”œâ”€â”€ ğŸ“ command_handlers/         # âš¡ å‘½ä»¤å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ base.py              # ğŸ—ï¸ å‘½ä»¤åŸºç±»
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ admin.py             # ğŸ” ç®¡ç†å‘˜å‘½ä»¤
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ group.py             # ğŸ‘¥ ç¾¤ç»„å‘½ä»¤
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ private.py           # ğŸ‘¤ ç§èŠå‘½ä»¤
â”‚   â”‚   â””â”€â”€ ğŸ“„ regist.py            # âœï¸ å‘½ä»¤æ³¨å†Œç³»ç»Ÿ
â”‚   â”œâ”€â”€ ğŸ“ data_repository/          # ğŸ—„ï¸ æ–°æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ conversations_repository.py
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ groups_repository.py
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ users_repository.py
â”‚   â”‚   â””â”€â”€ ğŸ“„ user_config_repository.py
â”‚   â”œâ”€â”€ ğŸ“ inline_handlers/          # ğŸ” å†…è”æŸ¥è¯¢å¤„ç†å™¨
â”‚   â”œâ”€â”€ ğŸ“ message_handlers/         # ğŸ’¬ æ¶ˆæ¯å¤„ç†å™¨
â”‚   â”œâ”€â”€ ğŸ“ services/                 # ğŸ”§ ä¸šåŠ¡é€»è¾‘æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ conversation.py      # ğŸ’­ å¯¹è¯æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ messages.py          # ğŸ“¨ æ¶ˆæ¯æœåŠ¡
â”‚   â”‚   â””â”€â”€ ğŸ“ utils/              # ğŸ› ï¸ æœåŠ¡å·¥å…·
â”‚   â””â”€â”€ ğŸ“ web/                     # ğŸŒ Web ç®¡ç†åå°
â”œâ”€â”€ ğŸ“ characters/                   # ğŸ­ è§’è‰²é…ç½®æ–‡ä»¶
â”œâ”€â”€ ğŸ“ config/                       # âš™ï¸ é…ç½®æ–‡ä»¶
â”œâ”€â”€ ğŸ“ data/                         # ğŸ’¾ æ•°æ®å­˜å‚¨
â”œâ”€â”€ ğŸ“ prompts/                      # ğŸ’­ æç¤ºè¯æ¨¡æ¿
â”œâ”€â”€ ğŸ“ utils/                        # ğŸ› ï¸ é€šç”¨å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ ğŸ“„ auth_utils.py            # ğŸ” è®¤è¯å·¥å…·
â”‚   â”œâ”€â”€ ğŸ“„ config_utils.py          # âš™ï¸ é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ ğŸ“„ db_utils.py              # ğŸ—„ï¸ æ•°æ®åº“æ“ä½œ
â”‚   â”œâ”€â”€ ğŸ“„ LLM_utils.py             # ğŸ§  LLM å·¥å…·
â”‚   â””â”€â”€ ğŸ“„ text_utils.py            # ğŸ“ æ–‡æœ¬å¤„ç†
â””â”€â”€ ğŸ“ web/                          # ğŸŒ Web ç®¡ç†åå°
    â”œâ”€â”€ ğŸ“„ app.py                    # ğŸš€ Flask åº”ç”¨
    â”œâ”€â”€ ğŸ“„ factory.py                # ğŸ­ åº”ç”¨å·¥å‚
    â”œâ”€â”€ ğŸ“ blueprints/               # ğŸ§© åŠŸèƒ½æ¨¡å—
    â”œâ”€â”€ ğŸ“ static/                   # ğŸ¨ é™æ€èµ„æº
    â””â”€â”€ ğŸ“ templates/                # ğŸ“„ HTML æ¨¡æ¿
```

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### 1. ğŸ“¨ æ¶ˆæ¯å¤„ç†æ¶æ„

- **åˆ†å±‚æ¶ˆæ¯å¤„ç†**ï¼šæ¶ˆæ¯ â†’ å¤„ç†å™¨ â†’ æœåŠ¡ â†’ å“åº”
- **æ™ºèƒ½è·¯ç”±**ï¼šç§èŠ/ç¾¤ç»„æ¶ˆæ¯è‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”å¤„ç†å™¨
- **å¼‚æ­¥å¤„ç†**ï¼šåŸºäº asyncio çš„é«˜å¹¶å‘æ¶ˆæ¯å¤„ç†
- **é”™è¯¯æ¢å¤**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

### 2. ğŸ§  AI Agent ç³»ç»Ÿ

- **ç»Ÿä¸€å·¥å…·æ¥å£**ï¼šæ ‡å‡†åŒ–å·¥å…·æ³¨å†Œå’Œè°ƒç”¨
- **æ™ºèƒ½æç¤ºç”Ÿæˆ**ï¼šåŠ¨æ€æ„å»ºåŒ…å«ä¸Šä¸‹æ–‡çš„æç¤ºè¯
- **å¤šæ¨¡å‹æ”¯æŒ**ï¼šæ”¯æŒ OpenAIã€Claudeã€Gemini ç­‰ä¸»æµ LLM
- **å·¥å…·é“¾æ‰§è¡Œ**ï¼šæ”¯æŒå•ä¸ªå’Œæ‰¹é‡å·¥å…·è°ƒç”¨

### 3. ğŸ’¾ æ•°æ®è®¿é—®å±‚

- **åŒé‡ä»“åº“æ¶æ„**ï¼š
  - `repository.py` - ä¼ ç»Ÿç»¼åˆæ€§ä»“åº“
  - `data_repository/` - ä¸“ç”¨ç»†ç²’åº¦ä»“åº“
- **è¿æ¥æ± ç®¡ç†**ï¼šSQLite è¿æ¥æ± ä¼˜åŒ–
- **äº‹åŠ¡å®‰å…¨**ï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§

### 4. ğŸŒ Web ç®¡ç†åå°

- **ç°ä»£åŒ–æ¶æ„**ï¼šåŸºäº Flask + Blueprint
- **å“åº”å¼è®¾è®¡**ï¼šç§»åŠ¨ç«¯å‹å¥½çš„ç®¡ç†ç•Œé¢
- **å®æ—¶æ•°æ®**ï¼šåŠ¨æ€ç»Ÿè®¡å’Œç›‘æ§
- **å®‰å…¨è®¤è¯**ï¼šåŸºäºä¼šè¯çš„ç®¡ç†åå°è®¿é—®æ§åˆ¶

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.12+
- pip
- Dockerï¼ˆå¯é€‰ï¼Œæ¨èç”Ÿäº§ç¯å¢ƒï¼‰

### å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### é…ç½®è¯´æ˜

1. **Telegram Bot é…ç½®**
   ```bash
   # è”ç³» @BotFather åˆ›å»ºæœºå™¨äººå¹¶è·å– Token
   # åœ¨ BotFather ä¸­å¯ç”¨å†…è”æ¨¡å¼
   ```

2. **é…ç½®æ–‡ä»¶**
   - å¤åˆ¶ `config/config.json` ä¸º `config/config_local.json`
   - å¡«å†™ Telegram Bot Tokenã€API Keys ç­‰æ•æ„Ÿä¿¡æ¯

3. **è§’è‰²é…ç½®**
   - åœ¨ `characters/` ç›®å½•ä¸‹æ·»åŠ è§’è‰² JSON æ–‡ä»¶
   - è‡ªå®šä¹‰ `prompts/` æç¤ºè¯æ¨¡æ¿

### å¯åŠ¨æ–¹å¼

#### æœ¬åœ°å¼€å‘
```bash
python bot_run.py
```

#### Docker éƒ¨ç½²
```bash
docker build -t cyber-waifu-bot .
docker run -d --name cyber-waifu-bot \
  -v "${PWD}/config:/app/config" \
  -v "${PWD}/data:/app/data" \
  -v "${PWD}/characters:/app/characters" \
  -v "${PWD}/prompts:/app/prompts" \
  cyber-waifu-bot
```

## ğŸ“– å‘½ä»¤æ‰‹å†Œ

### ğŸ‘¤ ç§èŠå‘½ä»¤

#### åŸºç¡€åŠŸèƒ½
- `/start` - æ¬¢è¿æ¶ˆæ¯å’ŒåŠŸèƒ½ä»‹ç»
- `/help` - è¯¦ç»†å¸®åŠ©æ–‡æ¡£
- `/me` - æŸ¥çœ‹ä¸ªäººä¿¡æ¯å’Œä½¿ç”¨ç»Ÿè®¡

#### è§’è‰²ç®¡ç†
- `/char` - æŸ¥çœ‹å½“å‰è§’è‰²å’Œè§’è‰²åˆ—è¡¨
- `/newchar [è§’è‰²å]` - åˆ›å»ºè‡ªå®šä¹‰è§’è‰²
- `/delchar` - åˆ é™¤è§’è‰²

#### å¯¹è¯ç®¡ç†
- `/new` - å¼€å§‹æ–°çš„å¯¹è¯
- `/save` - ä¿å­˜å½“å‰å¯¹è¯å¹¶è‡ªåŠ¨æ€»ç»“
- `/dialog` - åŠ è½½å†å²å¯¹è¯
- `/undo` - æ’¤é”€ä¸Šä¸€æ¡æ¶ˆæ¯

#### åŠ å¯†è´§å¸åˆ†æ
- `/c [å‚æ•°] [æŒ‡ä»¤]` - AI é©±åŠ¨çš„åŠ å¯†è´§å¸åˆ†æ
  - `long` - å¤šå¤´å€¾å‘åˆ†æ
  - `short` - ç©ºå¤´å€¾å‘åˆ†æ
  - æ— å‚æ•° - ä¸­æ€§åˆ†æ

### ğŸ‘¥ ç¾¤ç»„å‘½ä»¤

#### ç¾¤ç»„ç®¡ç†ï¼ˆç®¡ç†å‘˜ï¼‰
- `/switch` - åˆ‡æ¢ç¾¤ç»„è§’è‰²
- `/rate [0-1]` - è®¾ç½®å›å¤æ¦‚ç‡
- `/kw` - ç®¡ç†å…³é”®è¯è§¦å‘
- `/enable` - å¯ç”¨ç¾¤èŠè¯é¢˜è®¨è®º
- `/disable` - ç¦ç”¨ç¾¤èŠè¯é¢˜è®¨è®º

#### ç¾¤ç»„åŠŸèƒ½
- `/cc [å¸ç§] [å‚æ•°]` - ç¾¤èŠåŠ å¯†è´§å¸åˆ†æ
- `/remake` - é‡ç½®ç¾¤èŠå¯¹è¯ä¸Šä¸‹æ–‡

### ğŸ” ç®¡ç†å‘˜å‘½ä»¤

- `/addf [ç”¨æˆ·ID/all] [æ•°é‡]` - å¢åŠ ç”¨æˆ·é¢åº¦
- `/sett [ç”¨æˆ·ID] [ç­‰çº§]` - ä¿®æ”¹ç”¨æˆ·ç­‰çº§
- `/q [æŸ¥è¯¢]` - æ•°æ®åº“æŸ¥è¯¢åˆ†æ

## ğŸ”§ æ‰©å±•å¼€å‘

### æ·»åŠ æ–°å‘½ä»¤

```python
# åœ¨ bot_core/command_handlers/ ä¸­åˆ›å»ºæ–°å‘½ä»¤
from bot_core.command_handlers.base import BaseCommand, CommandMeta

class MyCommand(BaseCommand):
    meta = CommandMeta(
        name='my_command',
        command_type='private',
        trigger='mycmd',
        menu_text='æˆ‘çš„å‘½ä»¤',
        show_in_menu=True,
        menu_weight=10
    )

    async def handle(self, update, context):
        await update.message.reply_text("Hello from my command!")
```

### æ·»åŠ æ–°å·¥å…·

```python
# 1. åœ¨ agent/tools.py ä¸­å®ç°å·¥å…·
class MyTools:
    @staticmethod
    async def my_tool(param: str) -> dict:
        return {
            "display": f"å¤„ç†ç»“æœ: {param}",
            "llm_feedback": f"Tool executed with {param}"
        }

# 2. åœ¨ agent/tools_registry.py ä¸­æ³¨å†Œ
```

### æ•°æ®è®¿é—®

```python
# ä½¿ç”¨æ–°çš„ä»“åº“æ¨¡å¼
from bot_core.data_repository.users_repository import UsersRepository

user_data = UsersRepository.user_info_get(user_id)
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

### å¼€å‘æµç¨‹

1. Fork é¡¹ç›®ä»“åº“
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

### ä»£ç è§„èŒƒ

- éµå¾ª PEP 8 ä»£ç é£æ ¼
- ä½¿ç”¨ç±»å‹æ³¨è§£
- æ·»åŠ å¿…è¦çš„æ–‡æ¡£å­—ç¬¦ä¸²
- ç¡®ä¿é€šè¿‡ä»£ç è´¨é‡æ£€æŸ¥

## â“ å¸¸è§é—®é¢˜

### éƒ¨ç½²ç›¸å…³

**Q: å¦‚ä½•è·å– Telegram Bot Tokenï¼Ÿ**
A: è”ç³» [@BotFather](https://t.me/BotFather) åˆ›å»ºæœºå™¨äººå¹¶è·å– Token

**Q: å¦‚ä½•é…ç½® LLM APIï¼Ÿ**
A: åœ¨ `config/config_local.json` ä¸­é…ç½® API å¯†é’¥å’Œç«¯ç‚¹

**Q: Docker éƒ¨ç½²æ³¨æ„äº‹é¡¹ï¼Ÿ**
A: ç¡®ä¿æŒ‚è½½ configã€dataã€charactersã€prompts ç›®å½•ä»¥æŒä¹…åŒ–æ•°æ®

### åŠŸèƒ½ä½¿ç”¨

**Q: å¦‚ä½•åˆ›å»ºè‡ªå®šä¹‰è§’è‰²ï¼Ÿ**
A: ä½¿ç”¨ `/newchar è§’è‰²å` å‘½ä»¤ï¼Œç„¶åæŒ‰æç¤ºè¾“å…¥è§’è‰²è®¾å®š

**Q: åŠ å¯†è´§å¸åˆ†ææ”¯æŒå“ªäº›å¸ç§ï¼Ÿ**
A: æ”¯æŒä¸»æµåŠ å¯†è´§å¸ï¼Œä½¿ç”¨å¸ç§ç¬¦å·æˆ–å…¨åæŸ¥è¯¢

### æ•…éšœæ’é™¤

**Q: æœºå™¨äººæ— å“åº”æ€ä¹ˆåŠï¼Ÿ**
A: æ£€æŸ¥ `data/bot.log` æ—¥å¿—æ–‡ä»¶ï¼ŒæŸ¥çœ‹é”™è¯¯ä¿¡æ¯

**Q: æ•°æ®åº“é”™è¯¯å¦‚ä½•å¤„ç†ï¼Ÿ**
A: ç¡®ä¿æ•°æ®åº“æ–‡ä»¶æƒé™æ­£ç¡®ï¼Œæ£€æŸ¥è¿æ¥æ± é…ç½®

---

â­ **å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ª Star æ”¯æŒä¸€ä¸‹ï¼**

ğŸ’– **æ„Ÿè°¢æ‰€æœ‰è´¡çŒ®è€…å’Œç”¨æˆ·çš„æ”¯æŒï¼**
